import{i as k,h as z,_ as A,d as m,F as B,l as S,a as E,f as u,u as f,L as j,s as y,b as C}from"./index-c2b82012.js";import{i as O}from"./originUtils-cfe4feaf.js";import{P as q,y as N,w as R,$ as H,d as Q,v as W,p as $,f as X,I as g,m as T}from"./utils-5a3862f5.js";import{t as Z,i as ee}from"./fetchService-097aa29a.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";import"./saveUtils-54061e79.js";const w="Feature Service",v="feature-layer-utils",te=`${v}-save`,re=`${v}-save-as`,p=`${v}-saveall`,d=`${v}-saveall-as`;function I(e){return{isValid:j(e)&&(!("dynamicDataSource"in e)||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function x(e){const t=[],r=[];for(const{layer:a,layerJSON:o}of e)a.isTable?r.push(o):t.push(o);return{layers:t,tables:r}}function D(e){return x([e])}async function M(e,t){return/\/\d+\/?$/.test(e.url)?D(t[0]):F(t,e)}async function F(e,t){if(e.reverse(),!t)return x(e);const r=await ae(t,e);for(const a of e)J(a.layer,a.layerJSON,r);return oe(r,e),r}async function ae(e,t){let r=await e.fetchData("json");if(ne(r))return r;r||(r={}),se(r);const{layer:{url:a,customParameters:o,apiKey:n}}=t[0];return await ie(r,{url:a??"",customParameters:o,apiKey:n},t.map(s=>s.layer.layerId)),r}function ne(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function se(e){e.layers||(e.layers=[]),e.tables||(e.tables=[])}function oe(e,t){const r=[],a=[];for(const{layer:o}of t){const{isTable:n,layerId:s}=o;n?a.push(s):r.push(s)}_(e.layers,r),_(e.tables,a)}function _(e,t){if(e.length<2)return;const r=[];for(const{id:a}of e)r.push(a);k(r.sort(P),t.slice().sort(P))&&e.sort((a,o)=>{const n=t.indexOf(a.id),s=t.indexOf(o.id);return n<s?-1:n>s?1:0})}function P(e,t){return e<t?-1:e>t?1:0}async function ie(e,t,r){const{url:a,customParameters:o,apiKey:n}=t,{serviceJSON:s,layersJSON:i}=await Z(a,{customParameters:o,apiKey:n}),l=b(e.layers,s.layers,r),c=b(e.tables,s.tables,r);e.layers=l.itemResources,e.tables=c.itemResources;const h=[...l.added,...c.added],V=i?[...i.layers,...i.tables]:[];await le(e,h,a,V)}function b(e,t,r){const a=z(e,t,(n,s)=>n.id===s.id);e=e.filter(n=>!a.removed.some(s=>s.id===n.id));const o=a.added;return o.forEach(({id:n})=>{e.push({id:n})}),{itemResources:e,added:o.filter(({id:n})=>!r.includes(n))}}async function le(e,t,r,a){const o=await ce(t),n=t.map(({id:s,type:i})=>new(o.get(i))({url:r,layerId:s,sourceJSON:a.find(({id:l})=>l===s)}));await Promise.allSettled(n.map(s=>s.load())),n.forEach(s=>{const{layerId:i,loaded:l,defaultPopupTemplate:c}=s;if(!l||c==null)return;const h={id:i,popupInfo:c.toJSON()};s.operationalLayerType!=="ArcGISFeatureLayer"&&(h.layerType=s.operationalLayerType),J(s,h,e)})}async function ce(e){const t=[];e.forEach(({type:o})=>{switch(ee(o)){case"CatalogLayer":t.push(A(()=>import("./CatalogLayer-d9595372.js"),["assets/CatalogLayer-d9595372.js","assets/index-c2b82012.js","assets/index-c76e6b87.css","assets/utils-d09b1dbb.js","assets/ClassBreaksDefinition-e3a59351.js","assets/FeatureLayerSource-58362f2f.js","assets/MeshLocalVertexSpace-da2d5a3a.js","assets/meshVertexSpaceUtils-9f59c7fe.js","assets/External-15867918.js","assets/MeshTransform-7d6e6d2a.js","assets/mat4f64-9a8384aa.js","assets/quat-7efbb1da.js","assets/mat3f64-e19cdcb8.js","assets/quatf64-216ddd5a.js","assets/editingSupport-fcbf6c06.js","assets/clientSideDefaults-7e58181d.js","assets/QueryEngineCapabilities-a2d35a4c.js","assets/capabilities-1a2f6cc3.js","assets/QueryTask-c988bd60.js","assets/executeForIds-0ae846d8.js","assets/featureConversionUtils-65314b0a.js"]).then(n=>n.default));break;case"FeatureLayer":t.push(A(()=>import("./index-c2b82012.js").then(n=>n.sD),["assets/index-c2b82012.js","assets/index-c76e6b87.css"]).then(n=>n.default));break;case"OrientedImageryLayer":t.push(A(()=>import("./OrientedImageryLayer-9ef874a3.js"),["assets/OrientedImageryLayer-9ef874a3.js","assets/index-c2b82012.js","assets/index-c76e6b87.css"]).then(n=>n.default))}});const r=await Promise.all(t),a=new Map;return e.forEach(({type:o},n)=>{a.set(o,r[n])}),a}function J(e,t,r){e.isTable?L(r.tables,t):L(r.layers,t)}function L(e,t){const r=e.findIndex(({id:a})=>a===t.id);r===-1?e.push(t):e[r]=t}function Y(e,t){if(!e.length)throw new y(`${t}:missing-parameters`,"'layers' array should contain at least one feature layer")}function ue(e,t){const r=e.map(a=>a.portalItem.id);if(new Set(r).size>1)throw new y(`${t}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function U(e,t){const r=e.map(a=>a.layerId);if(new Set(r).size!==r.length)throw new y(`${t}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}async function ye(e){Y(e,p),await Promise.all(e.map(t=>t.load()));for(const t of e)$(t,p,I),X({layer:t,itemType:w,errorNamePrefix:p});ue(e,p),U(e,p)}function G(e,t){const r=e.layers.some(a=>a.layerType==="OrientedImageryLayer");f(t,u.ORIENTED_IMAGERY_LAYER,r)}function K(e,t){const r=e.some(a=>a.type==="oriented-imagery");f(t,u.ORIENTED_IMAGERY_LAYER,r)}async function fe(e,t,r){G(r,t)}async function pe(e,t){const{url:r,layerId:a,title:o,fullExtent:n,isTable:s}=e,i=m(r);t.url=((i==null?void 0:i.serverType)==="FeatureServer"?r:`${r}/${a}`)??null,t.title||(t.title=o),t.extent=null,s||n==null||(t.extent=await S(n)),E(t,u.METADATA),E(t,u.MULTI_LAYER),C(t,u.SINGLE_LAYER),f(t,u.TABLE,s),K([e],t)}function de(e,t){for(const n of e){const s=n.parsedUrl.path,i=m(s);if(!(i==null?void 0:i.url.path))throw new y(`${t}:invalid-parameters`,T(n,`has unsupported url pattern: ${s}`),{layer:n});const c=i==null?void 0:i.serverType;if(c!=="FeatureServer"&&c!=="MapServer")throw new y(`${t}:invalid-parameters`,T(n,`has unsupported server type: ${c}`),{layer:n});if(c==="MapServer"&&e.length>1)throw new y(`${t}:invalid-parameters`,"Only one layer or table in a map service can be saved")}const r=m(e[0].parsedUrl.path),a=r==null?void 0:r.url.path;if(!e.every(n=>{const s=m(n.parsedUrl.path);return(s==null?void 0:s.url.path)===a}))throw new y(`${t}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}async function me(e){Y(e,d),await Promise.all(e.map(t=>t.load()));for(const t of e)$(t,d,I);de(e,d),U(e,d)}function he(e,t){G(t,e),g(e)}async function we(e,t){let r=0,a=0;for(const{isTable:s}of t)s?a++:r++;const o=t[0].parsedUrl.path,n=m(o);if(e.url=(n==null?void 0:n.serverType)==="FeatureServer"?n.url.path:o,e.title||(e.title=n.title),e.extent=null,r>0){const s=t.map(i=>i.fullExtent).filter(B).reduce((i,l)=>i.clone().union(l));s&&(e.extent=await S(s))}E(e,u.METADATA),f(e,u.MULTI_LAYER,t.length>1),f(e,u.SINGLE_LAYER,t.length===1),f(e,u.TABLE,a>0&&r===0),K(t,e),g(e)}async function Pe(e,t){return q({layer:e,itemType:w,validateLayer:I,createItemData:(r,a)=>M(a,[r]),errorNamePrefix:te,setItemProperties:fe},t)}async function be(e,t){await ye(e);const r=e[0].portalItem,a=N(r),o=await Promise.all(e.map(s=>R(s,a,t))),n=await M(r,e.map((s,i)=>({layer:s,layerJSON:o[i]})));return he(r,n),await r.update({data:n}),await Promise.all(e.slice(1).map(s=>s.portalItem.reload())),O(a),r.clone()}async function Le(e,t,r){return H({layer:e,itemType:w,validateLayer:I,createItemData:(a,o)=>Promise.resolve(D(a)),errorNamePrefix:re,newItem:t,setItemProperties:pe},r)}async function Se(e,t,r){await me(e);const a=Q({itemType:w,errorNamePrefix:d,newItem:t}),o=N(a),n=await Promise.all(e.map(i=>R(i,o,r))),s=await F(e.map((i,l)=>({layer:i,layerJSON:n[l]})));await we(a,e),await W(a,s,r);for(const i of e)i.portalItem=a.clone();return O(o),a}export{Pe as save,be as saveAll,Se as saveAllAs,Le as saveAs};
