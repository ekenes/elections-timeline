import{ei as L,e6 as C,e4 as F,lv as Oe,aF as N,he as _e,ep as se,lw as Re,lx as Be,gO as ie,ly as Ee,jV as ge,U as Ce,bX as pe,s as Pe,j4 as xe,gg as oe,lz as be,ks as X,cR as ae,$ as Se,_ as Le,lA as Fe,gW as Ne,gX as ue,gY as Ge,en as ke,e3 as Ue,lB as le,ek as je,aE as qe,iM as De,dK as ye}from"./index-02eff6e6.js";import{a as Ve}from"./devEnvironmentUtils-5c761adb.js";import{t as ee,e as we}from"./mat3f64-e19cdcb8.js";import{o as ce,r as He,e as ze}from"./mat4f64-9a8384aa.js";import{r as We,e as z,a as Ke,o as Xe,N as ve,z as Y,s as Ye,t as Qe,n as Ze,b as Je,c as W}from"./AttributeArray-93ec2a42.js";import{c as $e,x as et,L as tt,i as Te,O as st,E as rt}from"./BufferView-ca9895dd.js";import{r as nt,n as it,d as he,l as de}from"./vec3-9cc00b38.js";import{o as ot,d as me}from"./vec4-4d59ff29.js";import{n as at,o as ut,b as lt}from"./indexUtils-062bfce7.js";import{r as te}from"./resourceUtils-b3506350.js";import{t as ct}from"./NestedMap-b667f687.js";import{t as ht,o as Ie}from"./Indices-5546e6ec.js";import{t as dt}from"./requestImageUtils-cfb17578.js";import{t as q}from"./orientedBoundingBox-e085098f.js";import{t as mt,e as re,i as M,n as ft}from"./basicInterfaces-cbf2757f.js";import{S as gt}from"./triangle-8676a8aa.js";import{s as pt}from"./Util-dd4663f8.js";import{e as T}from"./VertexAttribute-c957ed9e.js";import{a as fe}from"./NormalAttribute.glsl-335d8cbf.js";import"./TextureFormat-60b88abd.js";import"./InterleavedLayout-c541ee63.js";import"./types-1305598a.js";import"./interfaces-d79e913c.js";import"./BindType-d21d71dd.js";import"./boundedPlane-a4f1fcdc.js";import"./sphere-098e4920.js";import"./plane-53ccce62.js";import"./quatf64-216ddd5a.js";import"./lineSegment-adddbca3.js";import"./renderState-95c3e7c2.js";import"./doublePrecisionUtils-e3c3d0d8.js";import"./quat-eaa78af8.js";import"./spatialReferenceEllipsoidUtils-16e47544.js";import"./computeTranslationToOriginAndRotation-e412a98d.js";function xt(n,e){if(!n)return!1;const{size:t,data:s,indices:l}=n;L(e,0,0,0),L($,0,0,0);let u=0,i=0;for(let o=0;o<l.length-2;o+=3){const c=l[o]*t,r=l[o+1]*t,a=l[o+2]*t;L(p,s[c],s[c+1],s[c+2]),L(P,s[r],s[r+1],s[r+2]),L(K,s[a],s[a+1],s[a+2]);const h=gt(p,P,K);h?(C(p,p,P),C(p,p,K),F(p,p,1/3*h),C(e,e,p),u+=h):(C($,$,p),C($,$,P),C($,$,K),i+=3)}return(i!==0||u!==0)&&(u!==0?(F(e,e,1/u),!0):i!==0&&(F(e,$,1/i),!0))}function bt(n,e){if(!n)return!1;const{size:t,data:s,indices:l}=n;L(e,0,0,0);let u=-1,i=0;for(let o=0;o<l.length;o++){const c=l[o]*t;u!==c&&(e[0]+=s[c],e[1]+=s[c+1],e[2]+=s[c+2],i++),u=c}return i>1&&F(e,e,1/i),i>0}function yt(n,e,t){if(!n)return!1;L(t,0,0,0),L($,0,0,0);let s=0,l=0;const{size:u,data:i,indices:o}=n,c=o.length-1,r=c+(e?2:0);for(let a=0;a<r;a+=2){const h=a<c?a+1:0,d=o[a<c?a:c]*u,f=o[h]*u;p[0]=i[d],p[1]=i[d+1],p[2]=i[d+2],P[0]=i[f],P[1]=i[f+1],P[2]=i[f+2],F(p,C(p,p,P),.5);const g=Oe(p,P);g>0?(C(t,t,F(p,p,g)),s+=g):s===0&&(C($,$,p),l++)}return s!==0?(F(t,t,1/s),!0):l!==0&&(F(t,$,1/l),!0)}const p=N(),P=N(),K=N(),$=N();class wt{constructor(){this.uid=_e()}}class vt extends wt{constructor(e){super(),this.highlightGroup=e,this.channel=mt.Highlight}}class Q extends We{constructor(e,t,s=null,l=z.Mesh,u=null,i=-1){super(),this.material=e,this.mapPositions=s,this.type=l,this.objectAndLayerIdColor=u,this.edgeIndicesLength=i,this.highlights=new Set,this._highlightGroupCounts=new Map,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[o,c]of t)this._attributes.set(o,{...c,indices:ht(c.indices)}),o===T.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(o).indices.length:this.edgeIndicesLength)}instantiate(e={}){const t=new Q(e.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach((s,l)=>{s.exclusive=!1,t._attributes.set(l,s)}),t._boundingInfo=this._boundingInfo,t.transformation=e.transformation||this.transformation,t}get attributes(){return this._attributes}getMutableAttribute(e){let t=this._attributes.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:Ke(t.data)},this._attributes.set(e,t)),t}setAttributeData(e,t){const s=this._attributes.get(e);s&&this._attributes.set(e,{...s,exclusive:!0,data:t})}get indexCount(){var t;const e=(t=this._attributes.values().next().value)==null?void 0:t.indices;return(e==null?void 0:e.length)??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo==null&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===z.Mesh?this._computeAttachmentOriginTriangles(e):this.type===z.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(this._transformation!=null&&se(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const t=this.attributes.get(T.POSITION);return xt(t,e)}_computeAttachmentOriginLines(e){const t=this.attributes.get(T.POSITION);return yt(t,$t(this.material.parameters,t),e)}_computeAttachmentOriginPoints(e){const t=this.attributes.get(T.POSITION);return bt(t,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.attributes.get(T.POSITION);if(!e||e.indices.length===0)return null;const t=this.type===z.Mesh?3:1;pt(e.indices.length%t==0,"Indexing error: "+e.indices.length+" not divisible by "+t);const s=Ie(e.indices.length/t);return new Xe(s,t,e)}get transformation(){return this._transformation??ce}set transformation(e){this._transformation=e&&e!==ce?He(e):null}get highlightGroups(){return this._highlightGroupCounts}get hasHighlights(){return this._highlightGroupCounts.size>0}foreachHighlightGroup(e){this._highlightGroupCounts.forEach((t,s)=>e(s))}allocateIdAndHighlight(e){const t=new vt(e);return this.addHighlight(t)}addHighlight(e){this.highlights.add(e);const{highlightGroup:t}=e,s=(this._highlightGroupCounts.get(t)??0)+1;return this._highlightGroupCounts.set(t,s),e}removeHighlight(e){if(this.highlights.delete(e)){const{highlightGroup:t}=e,s=this._highlightGroupCounts.get(t)??0;s<=1?this._highlightGroupCounts.delete(t):this._highlightGroupCounts.set(t,s-1)}}}function $t(n,e){return!(!("isClosed"in n)||!n.isClosed)&&e.indices.length>2}function V(n){if(n==null)return null;const e=n.offset!=null?n.offset:Re,t=n.rotation!=null?n.rotation:0,s=n.scale!=null?n.scale:Be,l=ee(1,0,0,0,1,0,e[0],e[1],1),u=ee(Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1),i=ee(s[0],0,0,0,s[1],0,0,0,1),o=we();return ie(o,u,i),ie(o,l,o),o}class Tt{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class It{constructor(e,t,s){this.name=e,this.lodThreshold=t,this.pivotOffset=s,this.stageResources=new Tt,this.numberOfVertices=0}}const E=()=>Se.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function At(n,e){const t=await Mt(n,e),s=await Et(t.textureDefinitions??{},e);let l=0;for(const u in s)if(s.hasOwnProperty(u)){const i=s[u];l+=i!=null&&i.image?i.image.width*i.image.height*4:0}return{resource:t,textures:s,cachedMemory:l+Ee(t)}}async function Mt(n,e){const t=e==null?void 0:e.streamDataRequester;if(t)return Ot(n,t,e);const s=await ge(Ce(n,e));if(s.ok===!0)return s.value.data;pe(s.error),Ae(s.error)}async function Ot(n,e,t){const s=await ge(e.request(n,"json",t));if(s.ok===!0)return s.value;pe(s.error),Ae(s.error.details.url)}function Ae(n){throw new Pe("",`Request for object resource failed: ${n}`)}function _t(n){const e=n.params,t=e.topology;let s=!0;switch(e.vertexAttributes||(E().warn("Geometry must specify vertex attributes"),s=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const u=e.faces;if(u){if(e.vertexAttributes)for(const i in e.vertexAttributes){const o=u[i];o!=null&&o.values?(o.valueType!=null&&o.valueType!=="UInt32"&&(E().warn(`Unsupported indexed geometry indices type '${o.valueType}', only UInt32 is currently supported`),s=!1),o.valuesPerElement!=null&&o.valuesPerElement!==1&&(E().warn(`Unsupported indexed geometry values per element '${o.valuesPerElement}', only 1 is currently supported`),s=!1)):(E().warn(`Indexed geometry does not specify face indices for '${i}' attribute`),s=!1)}}else E().warn("Indexed geometries must specify faces"),s=!1;break}default:E().warn(`Unsupported topology '${t}'`),s=!1}n.params.material||(E().warn("Geometry requires material"),s=!1);const l=n.params.vertexAttributes;for(const u in l)l[u].values||(E().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function Rt(n,e){var g,y;const t=new Array,s=new Array,l=new Array,u=new ct,i=n.resource,o=xe.parse(i.version||"1.0","wosr");Pt.validate(o);const c=i.model.name,r=i.model.geometries,a=i.materialDefinitions??{},h=n.textures;let d=0;const f=new Map;for(let m=0;m<r.length;m++){const x=r[m];if(!_t(x))continue;const I=Ct(x),w=x.params.vertexAttributes,D=[],Z=b=>{if(x.params.topology==="PerAttributeArray")return null;const A=x.params.faces;for(const B in A)if(B===b)return A[B].values;return null},H=w[T.POSITION],G=H.values.length/H.valuesPerElement;for(const b in w){const A=w[b],B=A.values,J=Z(b)??Ie(G);D.push([b,new q(B,J,A.valuesPerElement,!0)])}const O=I.texture,v=h&&h[O];if(v&&!f.has(O)){const{image:b,parameters:A}=v,B=new ve(b,A);s.push(B),f.set(O,B)}const S=f.get(O),k=S?S.id:void 0,U=I.material;let _=u.get(U,O);if(_==null){const b=a[U.slice(U.lastIndexOf("/")+1)].params;b.transparency===1&&(b.transparency=0);const A=v&&v.alphaChannelUsage,B=b.transparency>0||A==="transparency"||A==="maskAndTransparency",J=v?Me(v.alphaChannelUsage):void 0,ne={ambient:oe(b.diffuse),diffuse:oe(b.diffuse),opacity:1-(b.transparency||0),transparent:B,textureAlphaMode:J,textureAlphaCutoff:.33,textureId:k,initTextureTransparent:!0,doubleSided:!0,cullFace:re.None,colorMixMode:b.externalColorMixMode||"tint",textureAlphaPremultiplied:(v==null?void 0:v.parameters.preMultiplyAlpha)??!1};e!=null&&e.materialParameters&&Object.assign(ne,e.materialParameters),_=new Y(ne,e),u.set(U,O,_)}l.push(_);const R=new Q(_,D);d+=((y=(g=D.find(b=>b[0]===T.POSITION))==null?void 0:g[1])==null?void 0:y.indices.length)??0,t.push(R)}return{engineResources:[{name:c,stageResources:{textures:s,materials:l,geometries:t},pivotOffset:i.model.pivotOffset,numberOfVertices:d,lodThreshold:null}],referenceBoundingBox:Bt(t)}}function Bt(n){const e=be();return n.forEach(t=>{const s=t.boundingInfo;s!=null&&(X(e,s.bbMin),X(e,s.bbMax))}),e}async function Et(n,e){const t=new Array;for(const u in n){const i=n[u],o=i.images[0].data;if(!o){E().warn("Externally referenced texture data is not yet supported");continue}const c=i.encoding+";base64,"+o,r="/textureDefinitions/"+u,a=i.channels==="rgba"?i.alphaChannelUsage||"transparency":"none",h={noUnpackFlip:!0,wrap:{s:ae.REPEAT,t:ae.REPEAT},preMultiplyAlpha:Me(a)!==M.Opaque},d=e!=null&&e.disableTextures?Promise.resolve(null):dt(c,e);t.push(d.then(f=>({refId:r,image:f,parameters:h,alphaChannelUsage:a})))}const s=await Promise.all(t),l={};for(const u of s)l[u.refId]=u;return l}function Me(n){switch(n){case"mask":return M.Mask;case"maskAndTransparency":return M.MaskBlend;case"none":return M.Opaque;default:return M.Blend}}function Ct(n){const e=n.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const Pt=new xe(1,2,"wosr");async function ws(n,e){var h;const t=St(Ve(n));if(t.fileType==="wosr"){const d=await(e.cache?e.cache.loadWOSR(t.url,e):At(t.url,e)),{engineResources:f,referenceBoundingBox:g}=Rt(d,e);return{lods:f,referenceBoundingBox:g,isEsriSymbolResource:!1,isWosr:!0}}let s;if(e.cache)s=await e.cache.loadGLTF(t.url,e,!!e.usePBR);else{const{loadGLTF:d}=await Le(()=>import("./loader-381d31d6.js"),["assets/loader-381d31d6.js","assets/index-02eff6e6.js","assets/index-d85835aa.css","assets/mat4f64-9a8384aa.js","assets/quat-eaa78af8.js","assets/mat3f64-e19cdcb8.js","assets/quatf64-216ddd5a.js","assets/BufferView-ca9895dd.js","assets/resourceUtils-b3506350.js","assets/basicInterfaces-cbf2757f.js"]);s=await d(new at(e.streamDataRequester),t.url,e,e.usePBR)}const l=(h=s.model.meta)==null?void 0:h.ESRI_proxyEllipsoid,u=s.meta.isEsriSymbolResource&&l!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";u&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,kt(s,l));const i=!!e.usePBR,o=s.meta.isEsriSymbolResource?{usePBR:i,isSchematic:!1,treeRendering:u,mrrFactors:Ye}:{usePBR:i,isSchematic:!1,treeRendering:!1,mrrFactors:Qe},c={...e.materialParameters,treeRendering:u},{engineResources:r,referenceBoundingBox:a}=Lt(s,o,c,e,t.specifiedLodIndex);return{lods:r,referenceBoundingBox:a,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function St(n){const e=n.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:n.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:n,specifiedLodIndex:null}:{fileType:"unknown",url:n,specifiedLodIndex:null}}function Lt(n,e,t,s,l){const u=n.model,i=new Array,o=new Map,c=new Map,r=u.lods.length,a=be();return u.lods.forEach((h,d)=>{const f=s.skipHighLods===!0&&(r>1&&d===0||r>3&&d===1)||s.skipHighLods===!1&&l!=null&&d!==l;if(f&&d!==0)return;const g=new It(h.name,h.lodThreshold,[0,0,0]);h.parts.forEach(y=>{const m=f?new Y({},s):Ft(u,y,g,e,t,o,c,s),{geometry:x,vertexCount:I}=Nt(y,m??new Y({},s)),w=x.boundingInfo;w!=null&&d===0&&(X(a,w.bbMin),X(a,w.bbMax)),m!=null&&(g.stageResources.geometries.push(x),g.numberOfVertices+=I)}),f||i.push(g)}),{engineResources:i,referenceBoundingBox:a}}function Ft(n,e,t,s,l,u,i,o){var g,y;const c=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),r=n.materials.get(e.material),a=e.attributes.texCoord0!=null,h=e.attributes.normal!=null;if(r==null)return null;const d=Gt(r.alphaMode);if(!u.has(c)){if(a){const S=(k,U=!1)=>{if(k!=null&&!i.has(k)){const _=n.textures.get(k);if(_!=null){const R=_.data;i.set(k,new ve(te(R)?R.data:R,{..._.parameters,preMultiplyAlpha:!te(R)&&U,encoding:te(R)&&R.encoding!=null?R.encoding:void 0}))}}};S(r.textureColor,d!==M.Opaque),S(r.textureNormal),S(r.textureOcclusion),S(r.textureEmissive),S(r.textureMetallicRoughness)}const m=1/ye,x=r.color[0]**m,I=r.color[1]**m,w=r.color[2]**m,D=r.emissiveFactor[0]**m,Z=r.emissiveFactor[1]**m,H=r.emissiveFactor[2]**m,G=r.textureColor!=null&&a?i.get(r.textureColor):null,O=Ze({normalTexture:r.textureNormal,metallicRoughnessTexture:r.textureMetallicRoughness,metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,emissiveTexture:r.textureEmissive,emissiveFactor:r.emissiveFactor,occlusionTexture:r.textureOcclusion}),v=((g=r.normalTextureTransform)==null?void 0:g.scale)!=null?(y=r.normalTextureTransform)==null?void 0:y.scale:Fe;u.set(c,new Y({...s,transparent:d===M.Blend,customDepthTest:ft.Lequal,textureAlphaMode:d,textureAlphaCutoff:r.alphaCutoff,diffuse:[x,I,w],ambient:[x,I,w],opacity:r.opacity,doubleSided:r.doubleSided,doubleSidedType:"winding-order",cullFace:r.doubleSided?re.None:re.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:h?fe.Attribute:fe.ScreenDerivative,castShadows:!0,receiveShadows:r.receiveShadows,receiveAmbientOcclusion:r.receiveAmbientOcclustion,textureId:G!=null?G.id:void 0,colorMixMode:r.colorMixMode,normalTextureId:r.textureNormal!=null&&a?i.get(r.textureNormal).id:void 0,textureAlphaPremultiplied:G!=null&&!!G.parameters.preMultiplyAlpha,occlusionTextureId:r.textureOcclusion!=null&&a?i.get(r.textureOcclusion).id:void 0,emissiveTextureId:r.textureEmissive!=null&&a?i.get(r.textureEmissive).id:void 0,metallicRoughnessTextureId:r.textureMetallicRoughness!=null&&a?i.get(r.textureMetallicRoughness).id:void 0,emissiveFactor:[D,Z,H],mrrFactors:O?Je:[r.metallicFactor,r.roughnessFactor,s.mrrFactors[2]],isSchematic:O,colorTextureTransformMatrix:V(r.colorTextureTransform),normalTextureTransformMatrix:V(r.normalTextureTransform),scale:[v[0],v[1]],occlusionTextureTransformMatrix:V(r.occlusionTextureTransform),emissiveTextureTransformMatrix:V(r.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:V(r.metallicRoughnessTextureTransform),...l},o))}const f=u.get(c);if(t.stageResources.materials.push(f),a){const m=x=>{x!=null&&t.stageResources.textures.push(i.get(x))};m(r.textureColor),m(r.textureNormal),m(r.textureOcclusion),m(r.textureEmissive),m(r.textureMetallicRoughness)}return f}function Nt(n,e){const t=n.attributes.position.count,s=ut(n.indices||t,n.primitiveType),l=W(3*t),{typedBuffer:u,typedBufferStride:i}=n.attributes.position;nt(l,u,n.transform,3,i);const o=[[T.POSITION,new q(l,s,3,!0)]];if(n.attributes.normal!=null){const r=W(3*t),{typedBuffer:a,typedBufferStride:h}=n.attributes.normal;Ne(j,n.transform),it(r,a,j,3,h),ue(j)&&he(r,r),o.push([T.NORMAL,new q(r,s,3,!0)])}if(n.attributes.tangent!=null){const r=W(4*t),{typedBuffer:a,typedBufferStride:h}=n.attributes.tangent;Ge(j,n.transform),ot(r,a,j,4,h),ue(j)&&he(r,r,4),o.push([T.TANGENT,new q(r,s,4,!0)])}if(n.attributes.texCoord0!=null){const r=W(2*t),{typedBuffer:a,typedBufferStride:h}=n.attributes.texCoord0;lt(r,a,2,h),o.push([T.UV0,new q(r,s,2,!0)])}const c=n.attributes.color;if(c!=null){const r=new Uint8Array(4*t);c.elementCount===4?c instanceof $e?me(r,c,1,255):(c instanceof et||c instanceof tt)&&me(r,c,1/255,255):(r.fill(255),c instanceof Te?de(r,c.typedBuffer,1,255,4,c.typedBufferStride):(n.attributes.color instanceof st||n.attributes.color instanceof rt)&&de(r,c.typedBuffer,1/255,255,4,n.attributes.color.typedBufferStride)),o.push([T.COLOR,new q(r,s,4,!0)])}return{geometry:new Q(e,o),vertexCount:t}}const j=we();function Gt(n){switch(n){case"BLEND":return M.Blend;case"MASK":return M.Mask;case"OPAQUE":case null:case void 0:return M.Opaque}}function kt(n,e){for(let t=0;t<n.model.lods.length;++t){const s=n.model.lods[t];for(const l of s.parts){const u=l.attributes.normal;if(u==null)return;const i=l.attributes.position,o=i.count,c=N(),r=N(),a=N(),h=new Float32Array(4*o),d=new Float32Array(3*o),f=ke(ze(),l.transform);let g=0,y=0;for(let m=0;m<o;m++){i.getVec(m,r),u.getVec(m,c),se(r,r,l.transform),Ue(a,r,e.center),le(a,a,e.radius);const x=a[2],I=je(a),w=Math.min(.45+.55*I*I,1)**ye;le(a,a,e.radius),f!==null&&se(a,a,f),qe(a,a),t+1!==n.model.lods.length&&n.model.lods.length>1&&De(a,a,c,x>-1?.2:Math.min(-4*x-3.8,1)),d[g]=a[0],d[g+1]=a[1],d[g+2]=a[2],g+=3,h[y]=w,h[y+1]=w,h[y+2]=w,h[y+3]=1,y+=4}l.attributes.normal=new Te(d),l.attributes.color=new $e(h)}}}export{ws as fetch,St as parseUrl};
