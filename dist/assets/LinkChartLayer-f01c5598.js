import{eE as Ae,d9 as Re,da as Pe,eG as Ge,ah as X,B as Ne,s as ie,cv as Fe,f8 as Be,$ as P,ct as ue,et as K,a1 as Y,c2 as pe,hS as $e,Y as ye,P as ve,r as D,q as S,w as Ue,dd as je}from"./index-02eff6e6.js";import{u as Z,E as ze,D as Oe,C as We,g as Qe,P as qe,a as He,b as Ke,L as Ve,c as Ye,A as Je,v as Xe,d as x,s as z,t as ne,n as oe,e as Ze,o as se,r as E,f as De,i as et,p as xe,j as tt}from"./KnowledgeGraphSublayer-344272de.js";import{o as J}from"./featureConversionUtils-aa6583e8.js";import{W as at}from"./knowledgeGraphService-1b585d58.js";import"./GraphicsLayer-e95a2818.js";import"./GraphQueryStreaming-71b5222f.js";import"./FeatureStore-91d0a907.js";import"./BoundsStore-118fb5de.js";import"./PooledRBush-1b7ef766.js";import"./timeSupport-4d47519e.js";import"./queryUtils-60c4a6a9.js";import"./json-48e3ea08.js";import"./optimizedFeatureQueryEngineAdapter-50f8b80a.js";import"./QueryEngine-23d98145.js";import"./WhereClause-cb61301c.js";import"./QueryEngineCapabilities-a2d35a4c.js";import"./quantizationUtils-75dcba1a.js";import"./utils-9bf35a0c.js";import"./utils-7ccd7be0.js";import"./ClassBreaksDefinition-0149e616.js";import"./FixedIntervalBinParameters-2ec73721.js";import"./clientSideDefaults-0446b858.js";import"./capabilities-1a2f6cc3.js";var ee;(function(e){e.MULTIPLIER="multiplier",e.ABSOLUTE="absolute-value"})(ee||(ee={}));let N=class extends Ae(Re(Pe(Ge(je)))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this.membershipModified=!0,this._currentLinkChartConfig={layoutMode:"radial-root-centric"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(X.ofType(Z)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new Ne({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="LinkChartLayer",this.sublayerIdsCache=new Map,this.tables=new(X.ofType(Z)),this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e==null?void 0:e.inclusionModeDefinition,(e==null?void 0:e.dataPreloadedInLocalCache)&&!(e!=null&&e.inclusionModeDefinition))throw new ie("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");this.addHandles(Fe(()=>this.layers.concat(this.tables),(t,a)=>this._handleSublayersChange(t,a),Be))}normalizeCtorArgs(e){if(!e)return{};const{url:t,title:a,dataPreloadedInLocalCache:i,defaultLinkChartConfig:n}=e;return{url:t,title:a,dataPreloadedInLocalCache:i,defaultLinkChartConfig:n}}_initializeLayerProperties(e){var o,r,h,m;if(!this.title&&this.url){const d=this.url.split("/");this.title=d[d.length-2]}const t=new Set;let a=[],i=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new ie("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");(o=e.inclusionModeDefinition)!=null&&o.generateAllSublayers?(a=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]):(r=e.inclusionModeDefinition)!=null&&r.namedTypeDefinitions&&((h=e.inclusionModeDefinition)==null?void 0:h.namedTypeDefinitions.size)>0?(m=e.inclusionModeDefinition)==null||m.namedTypeDefinitions.forEach((d,y)=>{var C,b;const g=this._graphTypeLookup.get(y);if(!g)return P.getLogger(this).warn(`A named type, ${y}, was in the inclusion list that wasn't in the data model and will be removed`),void((C=e.inclusionModeDefinition)==null?void 0:C.namedTypeDefinitions.delete(y));g.type==="relationship"?t.has(y)||(t.add(y),i.push(g)):g.type==="entity"?t.has(y)||(t.add(y),a.push(g)):(P.getLogger(this).warn(`A named type, ${y}, was in the inclusion list that wasn't properly modeled and will be removed`),(b=e.inclusionModeDefinition)==null||b.namedTypeDefinitions.delete(y))}):(a=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]);const n=new ze({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=a,this.memberRelationshipTypes=i,this.dataManager=n}load(e){const t=async()=>{var n;const a=[],i=[];this.loadLayerAssumingLocalCache(),await xe(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),(n=this.dataManager.inclusionModeDefinition)==null||n.namedTypeDefinitions.forEach(o=>{o.useAllData=!1}),await this._initializeDiagram(),this.layers.forEach(o=>{i.push(o.refreshCachedQueryEngine()),a.push(new Promise(r=>{o.on("layerview-create",()=>{r(null)})}))}),this.tables.forEach(o=>{i.push(o.refreshCachedQueryEngine())}),await Promise.all(i)};return this.addResolvingPromise(new Promise(a=>{at(this.url).then(async i=>{var o,r,h,m,d,y,g,C,b,M;(o=i.dataModel.entityTypes)==null||o.forEach(w=>{w.name&&this._graphTypeLookup.set(w.name,w)}),(r=i.dataModel.relationshipTypes)==null||r.forEach(w=>{w.name&&this._graphTypeLookup.set(w.name,w)});const n=(h=this.parent)==null?void 0:h.linkChartProperties;if((n==null?void 0:n.originIdOf("entitiesUrl"))===ue.LINK_CHART&&(this.membershipModified=!1,this._originalInclusionList=await Oe.fetchAndConvertSerializedLinkChart({entitiesUrl:this.parent.linkChartProperties.entitiesUrl,relationshipsUrl:this.parent.linkChartProperties.relationshipsUrl}),this._alignLayersDataModelAndInclusionDefinition(i.dataModel),this.defaultLinkChartConfig={layoutSettings:(n==null?void 0:n.layoutSettings)??void 0,layoutMode:We(n.layoutType)}),this._initializeLayerProperties({knowledgeGraph:i,inclusionModeDefinition:this._originalInclusionList}),(d=(m=this.dataManager.inclusionModeDefinition)==null?void 0:m.namedTypeDefinitions)!=null&&d.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},(y=this.dataManager.knowledgeGraph.dataModel.entityTypes)==null||y.forEach(w=>{var v;w.name&&((v=this.dataManager.inclusionModeDefinition)==null||v.namedTypeDefinitions.set(w.name,{useAllData:!0}))}),(g=this.dataManager.knowledgeGraph.dataModel.relationshipTypes)==null||g.forEach(w=>{var v;w.name&&((v=this.dataManager.inclusionModeDefinition)==null||v.namedTypeDefinitions.set(w.name,{useAllData:!0}))})),this.dataPreloadedInLocalCache){const w=tt.getInstance();for(const[v,$]of((C=this.dataManager.inclusionModeDefinition)==null?void 0:C.namedTypeDefinitions)??[])for(const f of((b=$.members)==null?void 0:b.values())??[]){const te=w.readFromStoreById(`${v}__${f.id}`);te&&K(this.dataManager.sublayerCaches,v,()=>new Map).set(f.id,te)}await t()}else{const w=((M=this.defaultLinkChartConfig)==null?void 0:M.layoutMode)==="geographic-organic-standard";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,w,!0).then(async()=>{Y(e),await t()}))}a(null)})})),Promise.resolve(this)}set inclusionModeDefinition(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("inclusionModeDefinition",e):P.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}async addRecords(e,t){let a=[];t!=null&&t.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(a=await Qe(e,this.dataManager.knowledgeGraph));const i=e.concat(a).filter(n=>{var o;return!((o=this.sublayerIdsCache.get(n.typeName))!=null&&o.has(n.id))});i.length>0&&(this.membershipModified=!0),await this._handleNewRecords(i,t)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:a=!1,overrideMembershipCheck:i=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1,overrideMembershipCheck:!1}){var r,h,m,d,y,g,C,b;let n=[];for(const M of e)(i||((m=(h=(r=this.dataManager.inclusionModeDefinition)==null?void 0:r.namedTypeDefinitions)==null?void 0:h.get(M.typeName))==null?void 0:m.useAllData)===!1&&((C=(g=(y=(d=this.dataManager.inclusionModeDefinition)==null?void 0:d.namedTypeDefinitions)==null?void 0:y.get(M.typeName))==null?void 0:g.members)!=null&&C.has(M.id)))&&n.push(M);if(t){const M=new Set,w=[];for(const v of n)if(this.dataManager.nodeConnectionsLookup.has(v.id))for(const $ of this.dataManager.nodeConnectionsLookup.get(v.id))M.add($);for(const v of M)if(this.dataManager.memberIdTypeLookup.has(v))for(const $ of this.dataManager.memberIdTypeLookup.get(v))this.dataManager.relationshipTypeNames.has($)&&w.push({id:v,typeName:$});n=n.concat(w)}this.dataManager.removeFromLayer(n);for(const M of n)(b=this.sublayerIdsCache.get(M.typeName))==null||b.delete(M.id),this.dataManager.relationshipTypeNames.has(M.typeName)?this.relationshipLinkChartDiagramLookup.delete(M.id):this.entityLinkChartDiagramLookup.delete(M.id);a&&await this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,{layoutSettings:this._currentLinkChartConfig.layoutSettings}),n.length>0&&(this.membershipModified=!0);const o=[];return this.layers.forEach(M=>{o.push(M.refreshCachedQueryEngine())}),await Promise.all(o),this._refreshNamedTypes(),n}async expand(e,t){let a=[];try{const i=await this.dataManager.getConnectedRecordIds(e,t==null?void 0:t.relationshipTypeNames,t);a=i.filter(n=>{var o;return!((o=this.sublayerIdsCache.get(n.typeName))!=null&&o.has(n.id))}),await this._handleNewRecords(i,t),i.length>0&&(this.membershipModified=!0),Y(t==null?void 0:t.signal)}catch(i){throw pe(i)&&a.length>0&&this.removeRecords(a,{overrideMembershipCheck:!0}),i}return{records:a}}loadLayerAssumingLocalCache(){var t,a;const e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.originIdOf("layers")===ue.DEFAULTS?this._createSublayers(e,this.layers,i=>!!i.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===ue.DEFAULTS?this._createSublayers(e,this.tables,i=>!i.geometryType):this._updateSublayers(e,this.tables),(a=(t=this.dataManager.inclusionModeDefinition)==null?void 0:t.namedTypeDefinitions)==null||a.forEach((i,n)=>{var r;const o=K(this.sublayerIdsCache,n,()=>new Set);(r=i.members)==null||r.forEach(({id:h,linkChartLocation:m})=>{if(o.add(h),m){const d="coords"in m&&"lengths"in m?m:J(m);this.dataManager.relationshipTypeNames.has(n)?this.relationshipLinkChartDiagramLookup.set(h,d):this.entityLinkChartDiagramLookup.set(h,d)}})})}async calculateLinkChartLayout(e="radial-root-centric",t){var be,we,Me,ke,Ce;const a=[],i=[],n=[];this.dataManager.sublayerCaches.forEach((s,l)=>{this.dataManager.entityTypeNames.has(l)?s.forEach(u=>{a.push({typeName:l,feature:u})}):this.dataManager.relationshipTypeNames.has(l)&&s.forEach(u=>{i.push({typeName:l,feature:u})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const o=new Map,r=new Map,h=new Map,m=new Map,d=new Uint8Array(a.length),y=new Float64Array(a.length),g=new Float64Array(a.length),C=new Float64Array(a.length),b=new Float64Array(a.length),M=new Uint32Array(i.length),w=new Uint32Array(i.length),v=new Float64Array(i.length),$=new Float64Array(i.length),f=[],te="organic-standard",G=new Ne({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let Q,ge="organic-standard",L=0,A=0;const Ee=qe.apply;switch(ge=e==="geographic-organic-standard"?te:e,ge){case"organic-standard":Q=Xe.apply;break;case"organic-community":Q=Je.apply;break;case"hierarchical-bottom-to-top":Q=Ye.apply;break;case"radial-root-centric":Q=Ve.apply;break;case"tree-left-to-right":Q=Ke.apply;break;default:Q=He.apply}let re=!1;a.forEach(({typeName:s,feature:l})=>{var u,_,O,k,R;if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"&&((u=t==null?void 0:t.lockedNodeLocations)!=null&&u.has(l.attributes[x]))){e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(s)?d[L]=z.IsGeographic:d[L]=z.None;const c=t.lockedNodeLocations.get(l.attributes[x]);y[L]=c.x,g[L]=c.y}else if(e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(s)){d[L]=z.IsGeographic;let c=null;const T=l.attributes[this.dataManager.geographicLookup.get(s).name];switch((_=this.dataManager.geographicLookup.get(s))==null?void 0:_.geometryType){case"esriGeometryPoint":y[L]=T==null?void 0:T.x,g[L]=T==null?void 0:T.y;break;case"esriGeometryPolygon":c=T==null?void 0:T.centroid,(c==null?void 0:c.x)!=null&&(c==null?void 0:c.y)!=null?(y[L]=c.x,g[L]=c.y):d[L]=z.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":c=(O=T==null?void 0:T.extent)==null?void 0:O.center,(c==null?void 0:c.x)!=null&&(c==null?void 0:c.y)!=null?(y[L]=c.x,g[L]=c.y):d[L]=z.IsMovable;break;default:d[L]=z.IsMovable}(y[L]==null||g[L]==null||Number.isNaN(y[L])||Number.isNaN(g[L]))&&(d[L]=z.IsMovable,y[L]=0,g[L]=0)}else if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){!re&&((k=t==null?void 0:t.lockedNodeLocations)!=null&&k.has(l.attributes[x]))&&(re=!0);const c=(R=t==null?void 0:t.timeInfoByTypeName)==null?void 0:R.get(s),T=c==null?void 0:c.startField,F=T&&(c!=null&&c.startField)?l.attributes[T]:null;C[L]=F?new Date(F).getTime():NaN;const U=c==null?void 0:c.endField,j=U&&(c!=null&&c.endField)?l.attributes[U]:null;b[L]=j?new Date(j).getTime():NaN,y[L]=0,g[L]=0,d[L]=z.IsMovable}else d[L]=z.IsMovable,y[L]=0,g[L]=0;m.set(l.attributes[x],L),f[L]={feature:l,typeName:s},L++}),re&&P.getLogger(this).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let me=!1;const le=new Map;i.forEach(s=>{var U;const l=s.feature.attributes[ne],u=s.feature.attributes[oe],_=m.get(l),O=m.get(u),k=(U=t==null?void 0:t.timeInfoByTypeName)==null?void 0:U.get(s.typeName),R=t!=null&&t.timeInfoByTypeName?k==null?void 0:k.startField:null,c=R?s.feature.attributes[R]:null,T=k==null?void 0:k.endField,F=T?s.feature.attributes[T]:null;if(_!==void 0&&O!==void 0){let j=l+"-"+u;e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(j=j+"-"+c+"-"+F);const q=le.get(j);(q==null?void 0:q.has(s.typeName))||(M[A]=_,w[A]=O,e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(v[A]=c?new Date(c).getTime():NaN,$[A]=F?new Date(F).getTime():NaN),q===void 0?le.set(j,new Map([[s.typeName,A]])):q.set(s.typeName,A),A++),n.push(s)}else me=!0,this.relationshipLinkChartDiagramLookup.set(l,null)}),me&&P.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");const fe=this._validateLayoutSettings(e,t==null?void 0:t.layoutSettings),he=this._convertLayoutSettingsToCalculationSettings(fe);await Ze();let V=se.Error,I=null;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){let s;({status:V,links:I,graphics:s}=Ee(()=>{var l;return((l=t==null?void 0:t.signal)==null?void 0:l.aborted)??!1},d,y,g,C,b,M.subarray(0,A),w.subarray(0,A),v.subarray(0,A),$.subarray(0,A),e==="chronological-multi-timeline",((be=t==null?void 0:t.layoutSettings)==null?void 0:be.chronologicalLayoutSettings)??{})),V===se.Success&&(this.chronologicalAuxiliaryGraphics=s)}else({status:V,links:I}=Q(()=>{var s;return((s=t==null?void 0:t.signal)==null?void 0:s.aborted)??!1},d,y,g,M.subarray(0,A),w.subarray(0,A),he.computationBudgetTime,he.idealEdgeLengthMultiplier,he.repulsionRadiusMultiplier));if(Y(t==null?void 0:t.signal),V===se.Error)throw new ie("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");if(V===se.Canceled)throw $e();for(let s=0;s<f.length;s++){if(g[s]>84.9999?g[s]=84.9999:g[s]<-84.9999&&(g[s]=-84.9999),y[s]>179.9999?y[s]=179.9999:y[s]<-179.9999&&(y[s]=-179.9999),f[s].feature.attributes[E]=new ye(y[s],g[s]),o.has(f[s].typeName)){const _=o.get(f[s].typeName);_==null||_.set(f[s].feature.attributes[x],f[s].feature)}else{const _=new Map;_.set(f[s].feature.attributes[x],f[s].feature),o.set(f[s].typeName,_)}h.set(f[s].feature.attributes[x],f[s].feature);const l=J(f[s].feature.attributes[E]);this.entityLinkChartDiagramLookup.set(f[s].feature.attributes[x],f[s].feature.attributes[E]?l:null);const u=K(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,f[s].typeName,()=>({useAllData:!1,members:new Map}));K(u.members,f[s].feature.attributes[x],()=>({id:f[s].feature.attributes[x],linkChartLocation:void 0})).linkChartLocation=f[s].feature.attributes[E],f[s].feature.attributes[E].x<G.xmin&&(G.xmin=f[s].feature.attributes[E].x),f[s].feature.attributes[E].x>G.xmax&&(G.xmax=f[s].feature.attributes[E].x),f[s].feature.attributes[E].y<G.ymin&&(G.ymin=f[s].feature.attributes[E].y),f[s].feature.attributes[E].y>G.ymax&&(G.ymax=f[s].feature.attributes[E].y)}if(this.linkChartExtent.xmin=G.xmin,this.linkChartExtent.xmax=G.xmax,this.linkChartExtent.ymin=G.ymin,this.linkChartExtent.ymax=G.ymax,!I)throw new ie("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const ae=new Map,de=new Map,ce=new Map,Le=new Set;for(let s=0;s<n.length;s++){const l=[],u=n[s],_=u.feature.attributes[ne],O=u.feature.attributes[oe];let k=_+"-"+O;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){const p=(we=t==null?void 0:t.timeInfoByTypeName)==null?void 0:we.get(u.typeName),B=t!=null&&t.timeInfoByTypeName?p==null?void 0:p.startField:null,W=B?u.feature.attributes[B]:null,H=p==null?void 0:p.endField;k+="-"+W+"-"+(H?u.feature.attributes[H]:null)}const R=le.get(k).get(u.typeName),c=R===0?0:I==null?void 0:I.vertexEndIndex[R-1];if(!Le.has(R)){if(Le.add(R),I.types[R]===De.Recursive){const p=[I.vertices[2*c],I.vertices[2*c+1]],B=[I.vertices[2*(c+1)],I.vertices[2*(c+1)+1]],W=[.5*(p[0]+B[0]),.5*(p[1]+B[1])],H=[W[0]-p[0],W[1]-p[1]],Ie=[W[0]+H[1],W[1]-H[0]],_e=[W[0]-H[1],W[1]+H[0]];l.push(p),l.push(Ie),l.push(B),l.push(_e),l.push(p)}else{if(I.types[R]!==De.Regular){P.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let p=c;p<I.vertexEndIndex[R];p++)l.push([I.vertices[2*p],I.vertices[2*p+1]])}if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"){const p=(Me=f[m.get(_)])==null?void 0:Me.feature.attributes[E],B=(ke=f[m.get(O)])==null?void 0:ke.feature.attributes[E];l[0][0]===p.x&&l[0][1]===p.y||(l[0]=[p.x,p.y]),l[l.length-1][0]===B.x&&l[l.length-1][1]===B.y||(l[l.length-1]=[B.x,B.y])}for(let p=1;p<l.length-1;p++)l[p][1]>85.5?l[p][1]=85.5:l[p][1]<-85.5&&(l[p][1]=-85.5),l[p][0]>179.9999?l[p][0]=179.9999:l[p][0]<-179.9999&&(l[p][0]=-179.9999);ae.has(k)?ae.get(k).push(l):ae.set(k,[l])}const T=ae.get(k);de.has(k)||(de.set(k,new Map),ce.set(k,new Map));const F=de.get(k),U=ce.get(k);F.has(u.typeName)||(F.set(u.typeName,T.shift()),U.set(u.typeName,0));const j=F.get(u.typeName);U.set(u.typeName,U.get(u.typeName)+1);const q=new ve({paths:[j]});if(u.feature.attributes[E]=q,r.has(u.typeName)){const p=r.get(u.typeName);p==null||p.set(u.feature.attributes[x],u.feature)}else{const p=new Map;p.set(u.feature.attributes[x],u.feature),r.set(u.typeName,p)}h.set(u.feature.attributes[x],u.feature);const Te=J(u.feature.attributes[E]);this.relationshipLinkChartDiagramLookup.set(u.feature.attributes[x],u.feature.attributes[E]?Te:null);const Se=K(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,u.typeName,()=>({useAllData:!1,members:new Map}));K(Se.members,u.feature.attributes[x],()=>({id:u.feature.attributes[x],linkChartLocation:void 0})).linkChartLocation=u.feature.attributes[E]}for(const s of n)s.feature.attributes[et]=((Ce=ce.get(s.feature.attributes[ne]+"-"+s.feature.attributes[oe]))==null?void 0:Ce.get(s.typeName))??null;return this._currentLinkChartConfig={layoutMode:e,layoutSettings:fe},{nodes:o,links:r,idMap:h}}async applyNewLinkChartLayout(e="radial-root-centric",t){const a=[];await this._calculateLayoutWithSublayerTimeInfo(e,t),this.layers.forEach(i=>{a.push(i.refreshCachedQueryEngine())}),this.membershipModified=!0,await Promise.all(a),this._refreshNamedTypes()}getCurrentNodeLocations(){var t,a;const e=new Map;for(const[i,n]of((t=this.dataManager.inclusionModeDefinition)==null?void 0:t.namedTypeDefinitions.entries())??[])this.dataManager.relationshipTypeNames.has(i)||((a=n==null?void 0:n.members)==null||a.forEach(o=>{const r=o.linkChartLocation;let h;const m=o.id;r&&(h="x"in r?{x:r.x,y:r.y}:{x:r.coords[0],y:r.coords[1]},e.set(m,new ye({x:h.x,y:h.y})))}));return e}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach(a=>{t.push(a.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}async connectBetweenEntities(e,t){if(!e.length)return{records:[]};let a=[];try{let i=[];for(const n of this.dataManager.relationshipTypeNames){const o=this.sublayerIdsCache.get(n);o&&(i=i.concat(Array.from(o.keys())))}a=await this.dataManager.getRelationshipsBetweenNodes(e,i,t),await this._handleNewRecords(a,t),Y(t)}catch(i){throw pe(i)&&this.removeRecords(a),i}return{records:a}}async connectFromEntities(e,t){if(!e.length)return{records:[]};let a=[];try{let i=[];for(const o of this.dataManager.relationshipTypeNames){const r=this.sublayerIdsCache.get(o);r&&(i=i.concat(Array.from(r.keys())))}let n=[];for(const o of this.dataManager.entityTypeNames){const r=this.sublayerIdsCache.get(o);r&&(n=n.concat(Array.from(r)))}a=await this.dataManager.getRelationshipsFromNodes(e,n,i,t),await this._handleNewRecords(a,t),a.length>0&&(this.membershipModified=!0),Y(t)}catch(i){throw pe(i)&&this.removeRecords(a),i}return{records:a}}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}async _calculateLayoutWithSublayerTimeInfo(e="radial-root-centric",t){const a=new Map;this.layers.forEach(i=>{a.set(i.objectType.name,i.timeInfo)}),await this.calculateLinkChartLayout(e,{timeInfoByTypeName:a,...t})}async _handleNewRecords(e,t){const a=[];this.dataManager.addToLayer(e);for(const n of e)this.sublayerIdsCache.has(n.typeName)||(this.sublayerIdsCache.set(n.typeName,new Set),a.push(n.typeName)),this.sublayerIdsCache.get(n.typeName).add(n.id);for(const n of a){const o=this._graphTypeLookup.get(n);if(o){const r=this._createSublayer(o);o.type==="entity"?this.dataManager.entityTypeNames.add(n):this.dataManager.relationshipTypeNames.add(n),r.geometryType?this.layers.push(r):this.tables.push(r),this.dataManager.sublayerCaches.set(n,new Map)}}await xe(this,a,t),await this.dataManager.refreshCacheContent(e.map(n=>n.id),void 0,void 0,void 0,t);const i=Object.assign({},this._currentLinkChartConfig.layoutSettings);i.lockedNodeLocations=new Map;for(const[n,o]of this.entityLinkChartDiagramLookup.entries())o&&i.lockedNodeLocations.set(n,new ye(o.coords[0],o.coords[1]));await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,{layoutSettings:i})}_createSublayers(e,t,a){e.forEach(i=>{const n=this._createSublayer(i);a(n)&&t.push(n),this._updateSublayerCaches(i)})}_updateSublayers(e,t){t.forEach(a=>{a.parentCompositeLayer=this;const i=e.find(n=>n.type===a.graphType&&n.name===a.graphTypeName);i&&(a.objectType=i,a.read({title:i.name},{origin:"service"}),this._updateSublayerCaches(i))})}_updateSublayerCaches(e){const t=this.dataManager.sublayerCaches;t.has(e.name)||t.set(e.name,new Map)}async _initializeDiagram(){var e,t;this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?((t=(e=this.dataManager.inclusionModeDefinition)==null?void 0:e.namedTypeDefinitions)==null||t.forEach((a,i)=>{var n;(n=a==null?void 0:a.members)==null||n.forEach(o=>{const r=o.linkChartLocation;let h;const m=o.id;if(!r)return;h="x"in r?{x:r.x,y:r.y}:{x:r.coords[0],y:r.coords[1]};const d=J(h);this.dataManager.relationshipTypeNames.has(i)?this.relationshipLinkChartDiagramLookup.set(m,d):this.entityLinkChartDiagramLookup.set(m,d),this.linkChartExtent.xmin>h.x&&(this.linkChartExtent.xmin=h.x),this.linkChartExtent.xmax<h.x&&(this.linkChartExtent.xmax=h.x),this.linkChartExtent.ymin>h.y&&(this.linkChartExtent.ymin=h.y),this.linkChartExtent.ymax<h.y&&(this.linkChartExtent.ymax=h.y)})}),this.memberRelationshipTypes.forEach(a=>{var i;a.name&&((i=this.dataManager.sublayerCaches.get(a.name))==null||i.forEach(n=>{const o=this.relationshipLinkChartDiagramLookup.get(n.attributes[ne]),r=this.relationshipLinkChartDiagramLookup.get(n.attributes[oe]);if(o&&r){const h=J(new ve({paths:[[[o.coords[0],o.coords[1]],[r.coords[0],r.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(n.attributes[x],h)}else this.relationshipLinkChartDiagramLookup.set(n.attributes[x],null)}))})):await this._calculateLayoutWithSublayerTimeInfo(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.defaultLinkChartConfig||{}}):await this._calculateLayoutWithSublayerTimeInfo("radial-root-centric",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateLayoutSettings(e,t){const a=b=>typeof b=="number"&&!isNaN(b),i=b=>a(b)&&b>=1,n=b=>a(b)&&b>=1,o=b=>Object.values(ee).includes(b),r=b=>a(b)&&b>=0,h={organicLayoutSettings:{},chronologicalLayoutSettings:{}};if(!new Set(["organic-standard","organic-community","geographic-organic-standard","chronological-multi-timeline","chronological-mono-timeline"]).has(e)||!t)return h;t.organicLayoutSettings??(t.organicLayoutSettings={});const{computationBudgetTime:m,repulsionRadiusMultiplier:d,absoluteIdealEdgeLength:y,multiplicativeIdealEdgeLength:g,idealEdgeLengthType:C}=t.organicLayoutSettings;if(n(m)?h.organicLayoutSettings.computationBudgetTime=m:m!==void 0&&P.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),i(d)?h.organicLayoutSettings.repulsionRadiusMultiplier=d:d!==void 0&&P.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting"),e==="geographic-organic-standard"&&(y!==void 0||g!==void 0||C!==void 0)&&(o(C)?h.organicLayoutSettings.idealEdgeLengthType=C:C!==void 0&&P.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),C==="absolute-value"&&r(y)?h.organicLayoutSettings.absoluteIdealEdgeLength=y:C==="absolute-value"&&y!==void 0?P.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting"):C==="multiplier"&&r(g)?h.organicLayoutSettings.multiplicativeIdealEdgeLength=g:C==="multiplier"&&g!==void 0&&P.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),(e==="chronological-multi-timeline"||e==="chronological-mono-timeline")&&t.chronologicalLayoutSettings){const b=t.chronologicalLayoutSettings;b.durationLineWidth&&b.durationLineWidth<0&&P.getLogger(this).warn("Invalid layout durationLineWidth setting, will revert to default setting")}return h}_convertLayoutSettingsToCalculationSettings(e){e.organicLayoutSettings??(e.organicLayoutSettings={});let t=e.organicLayoutSettings.idealEdgeLengthType===ee.ABSOLUTE?e.organicLayoutSettings.absoluteIdealEdgeLength:e.organicLayoutSettings.multiplicativeIdealEdgeLength;return e.organicLayoutSettings.idealEdgeLengthType===ee.ABSOLUTE&&(t===void 0?t=-1:t*=-1),{computationBudgetTime:e.organicLayoutSettings.computationBudgetTime??void 0,repulsionRadiusMultiplier:e.organicLayoutSettings.repulsionRadiusMultiplier??void 0,idealEdgeLengthMultiplier:t}}_createSublayer(e){return new Z({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,t){t&&(t.forEach(a=>{a.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(a=>{a.parent=this}),this.addHandles([e.on("after-add",({item:a})=>{a.parent=this}),e.on("after-remove",({item:a})=>{a.parent=null})],"sublayers-owner"))}_alignLayersDataModelAndInclusionDefinition(e){var n;const t=new Set((e.entityTypes??[]).map(o=>o.name).concat((e.relationshipTypes??[]).map(o=>o.name))),a=new Set((e.entityTypes??[]).map(o=>o.name)),i=new Set((e.relationshipTypes??[]).map(o=>o.name));if(this.layers){for(const o of this.layers)!o.graphType&&t.has(o.graphTypeName)&&(o.graphType=a.has(o.graphTypeName)?"entity":"relationship");this.layers=this.layers.filter(o=>t.has(o.graphTypeName)&&(o.graphType==="entity"?a.has(o.graphTypeName):i.has(o.graphTypeName)))}else this.layers=new X;if(this.layers&&this._originalInclusionList){const o=new Set(this._originalInclusionList.namedTypeDefinitions.keys()),r=((n=this.tables)==null?void 0:n.map(d=>d.graphTypeName))??[],h=this.layers.map(d=>d.graphTypeName).concat(r);for(const d of h)o.has(d)||this._originalInclusionList.namedTypeDefinitions.set(d,{useAllData:!1,members:new Map});const m=[];for(const d of this._originalInclusionList.namedTypeDefinitions.keys())h.includes(d)||(P.getLogger(this).warn(`A named type, ${d}, was in the serialized feature collection but did not have a sublayer config in the item, so will be removed`),m.push(d));for(const d of m)this._originalInclusionList.namedTypeDefinitions.delete(d)}}};D([S()],N.prototype,"dataPreloadedInLocalCache",void 0),D([S()],N.prototype,"defaultLinkChartConfig",void 0),D([S()],N.prototype,"membershipModified",void 0),D([S()],N.prototype,"dataManager",void 0),D([S()],N.prototype,"inclusionModeDefinition",null),D([S()],N.prototype,"knowledgeGraph",void 0),D([S({type:X.ofType(Z),json:{write:{ignoreOrigin:!0}}})],N.prototype,"layers",void 0),D([S()],N.prototype,"entityLinkChartDiagramLookup",void 0),D([S()],N.prototype,"relationshipLinkChartDiagramLookup",void 0),D([S()],N.prototype,"linkChartExtent",void 0),D([S()],N.prototype,"memberEntityTypes",void 0),D([S()],N.prototype,"memberRelationshipTypes",void 0),D([S({type:["LinkChartLayer"]})],N.prototype,"operationalLayerType",void 0),D([S()],N.prototype,"sublayerIdsCache",void 0),D([S({type:X.ofType(Z),json:{write:{ignoreOrigin:!0}}})],N.prototype,"tables",void 0),D([S({json:{read:!1}})],N.prototype,"type",void 0),D([S({json:{read:!1}})],N.prototype,"chronologicalAuxiliaryGraphics",void 0),N=D([Ue("esri.layers.LinkChartLayer")],N);const vt=N;export{vt as default};
