import{dQ as c,dR as R,dS as A,T as D,dT as C,dU as E,dV as O,dW as S,C as I}from"./index-9b3f7302.js";import{o as L}from"./FeatureContainer-062c4973.js";import{r as N}from"./vec3f32-2da9db36.js";import{v as T}from"./normalizeUtils-b584c19a.js";import{i as $}from"./Container-696d2b4c.js";import{e as w}from"./color-0ce04c13.js";import{h as m}from"./FramebufferObject-08e5ad83.js";import{R as p,E as F,C as x,F as g,I as P}from"./enums-b14466b3.js";import{f as U}from"./ProgramTemplate-1f689709.js";const W=Math.PI/180,V=4;class q extends ${constructor(s){super(),this._program=null,this._vao=null,this._vertexBuffer=null,this._indexBuffer=null,this._dvsMat3=c(),this._localOrigin={x:0,y:0},this._getBounds=s}destroy(){this._vao&&(this._vao.dispose(),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=R(this._program)}doRender(s){const{context:t}=s,a=this._getBounds();if(a.length<1)return;this._createShaderProgram(t),this._updateMatricesAndLocalOrigin(s),this._updateBufferData(t,a),t.setBlendingEnabled(!0),t.setDepthTestEnabled(!1),t.setStencilWriteMask(0),t.setStencilTestEnabled(!1),t.setBlendFunction(p.ONE,p.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0);const d=this._program;t.bindVAO(this._vao),t.useProgram(d),d.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),t.gl.lineWidth(1),t.drawElements(F.LINES,8*a.length,x.UNSIGNED_INT,0),t.bindVAO()}_createTransforms(){return{dvs:c()}}_createShaderProgram(s){if(this._program)return;const t=`precision highp float;
        uniform mat3 u_dvsMat3;

        attribute vec2 a_position;

        void main() {
          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);
          gl_Position = vec4(pos.xy, 0.0, 1.0);
        }`,a=`precision mediump float;
      void main() {
        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);
      }`;this._program=s.programCache.acquire(t,a,v().attributes)}_updateMatricesAndLocalOrigin(s){const{state:t}=s,{displayMat3:a,size:d,resolution:u,pixelRatio:n,rotation:o,viewpoint:e}=t,h=W*o,{x:i,y}=e.targetGeometry,B=T(i,t.spatialReference);this._localOrigin.x=B,this._localOrigin.y=y;const _=n*d[0],f=n*d[1],b=u*_,M=u*f,l=A(this._dvsMat3);D(l,l,a),C(l,l,E(_/2,f/2)),O(l,l,N(d[0]/b,-f/M,1)),S(l,l,-h)}_updateBufferData(s,t){const{x:a,y:d}=this._localOrigin,u=2*V*t.length,n=new Float32Array(u),o=new Uint32Array(8*t.length);let e=0,h=0;for(const i of t)i&&(n[2*e]=i[0]-a,n[2*e+1]=i[1]-d,n[2*e+2]=i[0]-a,n[2*e+3]=i[3]-d,n[2*e+4]=i[2]-a,n[2*e+5]=i[3]-d,n[2*e+6]=i[2]-a,n[2*e+7]=i[1]-d,o[h]=e+0,o[h+1]=e+3,o[h+2]=e+3,o[h+3]=e+2,o[h+4]=e+2,o[h+5]=e+1,o[h+6]=e+1,o[h+7]=e+0,e+=4,h+=8);if(this._vertexBuffer?this._vertexBuffer.setData(n.buffer):this._vertexBuffer=m.createVertex(s,g.DYNAMIC_DRAW,n.buffer),this._indexBuffer?this._indexBuffer.setData(o):this._indexBuffer=m.createIndex(s,g.DYNAMIC_DRAW,o),!this._vao){const i=v();this._vao=new U(s,i.attributes,i.bufferLayouts,{geometry:this._vertexBuffer},this._indexBuffer)}}}const v=()=>w("bounds",{geometry:[{location:0,name:"a_position",count:2,type:x.FLOAT}]});let X=class extends L{constructor(r){super(r),this.hasHighlight=()=>!0}destroy(){super.destroy(),this._boundsRenderer=I(this._boundsRenderer)}enableRenderingBounds(r){this._boundsRenderer=new q(r),this.requestRender()}get hasLabels(){return!1}onTileData(r,s){r.patch(s),this.contains(r)||this.addChild(r),this.requestRender()}onTileError(r){r.clear(),this.contains(r)||this.addChild(r)}_renderChildren(r,s){for(const t of this.children)t.isReady&&t.hasData&&(t.commit(r),r.context.setStencilFunction(P.EQUAL,t.stencilRef,255),t.getDisplayList().replay(r,t,s))}};export{X as n};
