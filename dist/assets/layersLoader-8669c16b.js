import{s as w,aE as F,ai as M}from"./index-1f15e2a2.js";import{t as T,r as O}from"./fetchService-4c4a09d1.js";import{e as D}from"./jsonContext-f646d6ed.js";async function B(e,r){const t=e.instance.portalItem;if(t&&t.id)return await t.load(r),E(e),G(e,r)}function E(e){const r=e.instance.portalItem;if(!(r!=null&&r.type)||!e.supportedTypes.includes(r.type))throw new w("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:r==null?void 0:r.type,expectedType:e.supportedTypes.join(", ")})}async function G(e,r){const t=e.instance,a=t.portalItem;if(!a)return;const{url:s,title:o}=a,l=D(a);if(t.type==="group")return t.read({title:o},l),x(t,e);s&&t.read({url:s},l);const n=await L(e,r);return n&&t.read(n,l),t.resourceReferences={portalItem:a,paths:l.readResourcePaths??[]},t.type!=="subtype-group"&&t.read({title:o},l),F(t,l)}async function x(e,r){let t;const{portalItem:a}=e;if(!a)return;const s=a.type,o=r.layerModuleTypeMap;switch(s){case"Feature Service":case"Feature Collection":t=o.FeatureLayer;break;case"Stream Service":t=o.StreamLayer;break;case"Scene Service":t=o.SceneLayer;break;default:throw new w("portal:unsupported-item-type-as-group",`The item type '${s}' is not supported as a 'IGroupLayer'`)}let[l,n]=await Promise.all([t(),L(r)]),i=()=>l;if(s==="Feature Service"){n=a.url?await $(n,a.url):{};const u=S(n),y=J(n),c=[];if(u.length||y!=null&&y.length){u.length&&c.push("SubtypeGroupLayer"),y!=null&&y.length&&c.push("OrientedImageryLayer");const b=[];for(const p of c){const d=o[p];b.push(d())}const v=await Promise.all(b),h=new Map;c.forEach((p,d)=>{h.set(p,v[d])}),i=p=>p.layerType?h.get(p.layerType)??l:l}return f(e,i,n,await R(a.url))}return m(n)>0?f(e,i,n):N(e,i)}async function N(e,r){var s,o;const{portalItem:t}=e;if(!(t!=null&&t.url))return;const a=await T(t.url);a&&f(e,r,{layers:(s=a.layers)==null?void 0:s.map(g),tables:(o=a.tables)==null?void 0:o.map(g)})}function g(e){return{id:e.id,name:e.name}}function f(e,r,t,a){var l;let s=t.layers||[];const o=t.tables||[];((l=e.portalItem)==null?void 0:l.type)==="Feature Collection"&&(s.forEach(n=>{var i;((i=n==null?void 0:n.layerDefinition)==null?void 0:i.type)==="Table"&&o.push(n)}),s=s.filter(n=>{var i;return((i=n==null?void 0:n.layerDefinition)==null?void 0:i.type)!=="Table"})),s.reverse().forEach(n=>{const i=a==null?void 0:a(n);if(i||!a){const u=I(e,r(n),t,n,i);e.add(u)}}),o.reverse().forEach(n=>{const i=a==null?void 0:a(n);if(i||!a){const u=I(e,r(n),t,n,i);e.tables.add(u)}})}function I(e,r,t,a,s){const o=e.portalItem,l=new r({portalItem:o.clone(),layerId:a.id});if("sourceJSON"in l&&(l.sourceJSON=s),l.type!=="subtype-group"&&(l.sublayerTitleMode="service-name"),o.type==="Feature Collection"){const n={origin:"portal-item",portal:o.portal||M.getDefault()};l.read(a,n);const i=t.showLegend;i!=null&&l.read({showLegend:i},n)}return l}async function L(e,r){if(e.supportsData===!1)return;const t=e.instance,a=t.portalItem;if(!a)return;let s=null;try{s=await a.fetchData("json",r)}catch{}if(C(t)){let o=null,l=!0;if(s&&m(s)>0){if(t.layerId==null){const n=S(s);t.layerId=t.type==="subtype-group"?n==null?void 0:n[0]:j(s)}o=k(s,t),o&&(m(s)===1&&(l=!1),s.showLegend!=null&&(o.showLegend=s.showLegend))}return l&&"sublayerTitleMode"in t&&t.sublayerTitleMode!=="service-name"&&(t.sublayerTitleMode="item-title-and-service-name"),o}return s}async function $(e,r){if((e==null?void 0:e.layers)==null||(e==null?void 0:e.tables)==null){const t=await T(r);(e=e||{}).layers=e.layers||(t==null?void 0:t.layers),e.tables=e.tables||(t==null?void 0:t.tables)}return e}function j(e){const r=e.layers;if(r&&r.length)return r[0].id;const t=e.tables;return t&&t.length?t[0].id:null}function k(e,r){var s,o;const{layerId:t}=r,a=((s=e.layers)==null?void 0:s.find(l=>l.id===t))||((o=e.tables)==null?void 0:o.find(l=>l.id===t));return a&&P(a,r)?a:null}function m(e){var r,t;return(((r=e==null?void 0:e.layers)==null?void 0:r.length)??0)+(((t=e==null?void 0:e.tables)==null?void 0:t.length)??0)}function C(e){return e.type!=="stream"&&"layerId"in e}function S(e){var t;const r=[];return(t=e==null?void 0:e.layers)==null||t.forEach(a=>{a.layerType==="SubtypeGroupLayer"&&r.push(a.id)}),r}function J(e){var r;return(r=e==null?void 0:e.layers)==null?void 0:r.filter(({layerType:t})=>t==="OrientedImageryLayer").map(({id:t})=>t)}function P(e,r){return!(r.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||r.type==="subtype-group"&&!("layerType"in e))}async function R(e){const{layersJSON:r}=await O(e);if(!r)return null;const t=[...r.layers,...r.tables];return a=>t.find(s=>s.id===a.id)}export{j as getFirstLayerOrTableId,m as getNumLayersAndTables,J as getOrientedImageryLayerIds,S as getSubtypeGroupLayerIds,B as load,$ as preprocessFSItemData};
