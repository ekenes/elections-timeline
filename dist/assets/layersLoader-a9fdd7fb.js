import{s as p,Q as h,R as T,T as S,V as v,d as F}from"./index-02eff6e6.js";import{a as M,t as P}from"./fetchService-cf36dbdf.js";import{l as f,a as G,o as $,u as g,t as m,c as x,n as D,i as k,e as I}from"./loadUtils-8b205d56.js";import"./associatedFeatureServiceUtils-572c3485.js";async function W(t,r){const a=t.instance.portalItem;if(a!=null&&a.id)return await a.load(r),C(t),t.validateItem&&t.validateItem(a),R(t,r)}function C(t){const r=t.instance.portalItem;if(!(r!=null&&r.type)||!t.supportedTypes.includes(r.type))throw new p("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:r==null?void 0:r.type,expectedType:t.supportedTypes.join(", ")})}async function R(t,r){const a=t.instance,e=a.portalItem;if(!e)return;const{url:o,title:n}=e,i=h(e,"portal-item");if(a.type==="group")return j(a,i,t);o&&a.type!=="media"&&a.read({url:o},i);const l=new I,s=await b(t,l,r);return s&&a.read(s,i),a.resourceReferences={portalItem:e,paths:i.readResourcePaths??[]},a.type!=="subtype-group"&&a.read({title:n},i),T(a,i)}async function j(t,r,a){const e=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:o,type:n}=e;if(n==="Group Layer"){if(!S(e,"Map"))throw new p("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return A(t,a)}return t.read({title:o},r),E(t,a)}async function A(t,r){const a=t.portalItem,e=await a.fetchData("json");if(!e)return;if(!r.populateGroupLayer)throw new p("portal:missing-populate-group-layer","Missing populate group layer");const o=h(a,"web-map");t.read(e,o),await r.populateGroupLayer(t,e,{context:o}),t.resourceReferences={portalItem:a,paths:o.readResourcePaths??[]}}async function E(t,r){var c;let a;const{portalItem:e}=t;if(!e)return;const o=e.type,n=r.layerModuleTypeMap;if(!n)throw new p("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(o){case"Feature Service":case"Feature Collection":a=n.FeatureLayer;break;case"Stream Service":a=n.StreamLayer;break;case"Scene Service":a=n.SceneLayer;break;default:throw new p("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}const i=new I;let[l,s]=await Promise.all([a(),b(r,i)]),u=()=>l;if(o==="Feature Service"){const y=(c=f(s))==null?void 0:c.customParameters;s=e.url?await G(s,e.url,i):{},u=await z(s,n)||u;const L=await V(e.url,{customParameters:y,loadContext:i});return await d(t,u,s,n,L)}return o==="Scene Service"&&e.url&&(s=await $(e,s,i)),g(s)>0?await d(t,u,s,n):await O(t,u,n)}async function O(t,r,a){var n,i;const{portalItem:e}=t;if(!(e!=null&&e.url))return;const o=await M(e.url);o&&d(t,r,{layers:(n=o.layers)==null?void 0:n.map(m),tables:(i=o.tables)==null?void 0:i.map(m)},a)}async function d(t,r,a,e,o){var l;let n=a.layers||[];const i=a.tables||[];if(((l=t.portalItem)==null?void 0:l.type)==="Feature Collection"?(n.forEach((s,u)=>{var c;s.id=u,((c=s==null?void 0:s.layerDefinition)==null?void 0:c.type)==="Table"&&i.push(s)}),n=n.filter(s=>{var u;return((u=s==null?void 0:s.layerDefinition)==null?void 0:u.type)!=="Table"})):(n.reverse(),i.reverse()),n.forEach(s=>{const u=o==null?void 0:o(s);if(u||!o){const c=w(t,r(s),a,s,u);t.add(c)}}),i.length){const s=await e.FeatureLayer();i.forEach(u=>{const c=o==null?void 0:o(u);if(c||!o){const y=w(t,s,a,u,c);t.tables.add(y)}})}}function w(t,r,a,e,o){const n=t.portalItem,i={portalItem:n.clone(),layerId:e.id};e.url!=null&&(i.url=e.url);const l=new r(i);if("sourceJSON"in l&&(l.sourceJSON=o),l.type!=="subtype-group"&&l.type!=="catalog"&&(l.sublayerTitleMode="service-name"),n.type==="Feature Collection"){const s={origin:"portal-item",portal:n.portal||v.getDefault()};l.read(e,s);const u=a.showLegend;u!=null&&l.read({showLegend:u},s)}return l}async function b(t,r,a){if(t.supportsData===!1)return;const e=t.instance,o=e.portalItem;if(!o)return;let n=null;try{n=await o.fetchData("json",a)}catch{}if(q(e)){let i=null;const l=await J(o,n,r);if((n!=null&&n.layers||n!=null&&n.tables)&&l>0){if(e.layerId==null){const s=x(e.type),u=s?D(n,s)[0]:f(n);u&&(e.layerId=u.id)}i=N(n,e),(i==null?void 0:i.layerType)==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),i&&n.showLegend!=null&&(i.showLegend=n.showLegend)}return l>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),i}return n}async function J(t,r,a){var n,i,l,s,u;if(r!=null&&r.layers&&(r!=null&&r.tables))return g(r);const e=F(t.url);if(!e)return 1;const o=await a.fetchServiceMetadata(e.url.path,{customParameters:(n=f(r))==null?void 0:n.customParameters}).catch(()=>null);return(((i=r==null?void 0:r.layers)==null?void 0:i.length)??((l=o==null?void 0:o.layers)==null?void 0:l.length)??0)+(((s=r==null?void 0:r.tables)==null?void 0:s.length)??((u=o==null?void 0:o.tables)==null?void 0:u.length)??0)}function N(t,r){var o,n;const{layerId:a}=r,e=((o=t.layers)==null?void 0:o.find(i=>i.id===a))||((n=t.tables)==null?void 0:n.find(i=>i.id===a));return e&&Q(e,r)?e:null}function q(t){return t.type!=="stream"&&"layerId"in t}function Q(t,r){const a="layerType"in t&&t.layerType,{type:e}=r;return!(e==="feature"&&a&&t.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!a||e==="oriented-imagery"&&!a||e==="subtype-group"&&!a)}async function V(t,r){const{layersJSON:a}=await P(t,r);if(!a)return null;const e=[...a.layers,...a.tables];return o=>e.find(n=>n.id===o.id)}async function z(t,r){const{layers:a}=t;if(!(a!=null&&a.length))return;const e=new Set,o=[];for(const{layerType:l}of a){const s=l??"ArcGISFeatureLayer";if(e.has(s))continue;e.add(s);const u=r[k(s)];o.push(u())}const n=await Promise.all(o),i=new Map;return Array.from(e).forEach((l,s)=>{i.set(l,n[s])}),({layerType:l})=>{const s=l??"ArcGISFeatureLayer";return i.get(s)}}export{W as load};
