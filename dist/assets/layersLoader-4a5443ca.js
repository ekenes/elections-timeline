import{s as I,aN as O,ar as E,p as x}from"./index-10102046.js";import{l as G,a as N}from"./associatedFeatureServiceUtils-89c2d67c.js";import{t as S,r as j}from"./fetchService-b1de0ed5.js";import{e as C}from"./jsonContext-b65b26ad.js";class v{constructor(){this._serviceMetadatas=new Map}async fetchServiceMetadata(t,r){const a=this._serviceMetadatas.get(t);if(a)return a;const l=await S(t,r);return this._serviceMetadatas.set(t,l),l}}async function Z(e,t){const r=e.instance.portalItem;if(r&&r.id)return await r.load(t),k(e),J(e,t)}function k(e){const t=e.instance.portalItem;if(!(t!=null&&t.type)||!e.supportedTypes.includes(t.type))throw new I("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:t==null?void 0:t.type,expectedType:e.supportedTypes.join(", ")})}async function J(e,t){const r=e.instance,a=r.portalItem;if(!a)return;const{url:l,title:s}=a,o=C(a);if(r.type==="group")return r.read({title:s},o),P(r,e);l&&r.read({url:l},o);const n=new v,i=await L(e,n,t);return i&&r.read(i,o),r.resourceReferences={portalItem:a,paths:o.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:s},o),O(r,o)}async function P(e,t){let r;const{portalItem:a}=e;if(!a)return;const l=a.type,s=t.layerModuleTypeMap;switch(l){case"Feature Service":case"Feature Collection":r=s.FeatureLayer;break;case"Stream Service":r=s.StreamLayer;break;case"Scene Service":r=s.SceneLayer;break;default:throw new I("portal:unsupported-item-type-as-group",`The item type '${l}' is not supported as a 'IGroupLayer'`)}const o=new v;let[n,i]=await Promise.all([r(),L(t,o)]),c=()=>n;if(l==="Feature Service"){i=a.url?await A(i,a.url,o):{};const f=M(i),u=H(i),d=[];if(f.length||u!=null&&u.length){f.length&&d.push("SubtypeGroupLayer"),u!=null&&u.length&&d.push("OrientedImageryLayer");const b=[];for(const y of d){const m=s[y];b.push(m())}const D=await Promise.all(b),w=new Map;d.forEach((y,m)=>{w.set(y,D[m])}),c=y=>y.layerType?w.get(y.layerType)??n:n}const F=await Q(a.url);return await h(e,c,i,F)}return l==="Scene Service"&&a.url&&(i=await _(a,i,o)),T(i)>0?await h(e,c,i):await R(e,c)}async function _(e,t,r){var s,o;if(!(e!=null&&e.url))return t??{};if(t??(t={}),!t.layers){const n=await r.fetchServiceMetadata(e.url);t.layers=(s=n.layers)==null?void 0:s.map(p)}const{serverUrl:a,portalItem:l}=await G(e.url,{sceneLayerItem:e}).catch(()=>({serverUrl:null,portalItem:null}));if(a==null)return t.tables=[],t;if(!t.tables&&l){const n=await l.fetchData();if(n!=null&&n.tables)t.tables=n.tables.map(p);else{const i=await r.fetchServiceMetadata(a);t.tables=(o=i==null?void 0:i.tables)==null?void 0:o.map(p)}}if(t.tables)for(const n of t.tables)n.url=`${a}/${n.id}`;return t}async function R(e,t){var l,s;const{portalItem:r}=e;if(!(r!=null&&r.url))return;const a=await S(r.url);a&&h(e,t,{layers:(l=a.layers)==null?void 0:l.map(p),tables:(s=a.tables)==null?void 0:s.map(p)})}function p(e){return{id:e.id,name:e.name}}async function h(e,t,r,a){var o;let l=r.layers||[];const s=r.tables||[];if(((o=e.portalItem)==null?void 0:o.type)==="Feature Collection"&&(l.forEach(n=>{var i;((i=n==null?void 0:n.layerDefinition)==null?void 0:i.type)==="Table"&&s.push(n)}),l=l.filter(n=>{var i;return((i=n==null?void 0:n.layerDefinition)==null?void 0:i.type)!=="Table"})),l.reverse().forEach(n=>{const i=a==null?void 0:a(n);if(i||!a){const c=g(e,t(n),r,n,i);e.add(c)}}),s.length){const n=await N.FeatureLayer();s.reverse().forEach(i=>{const c=a==null?void 0:a(i);if(c||!a){const f=g(e,n,r,i,c);e.tables.add(f)}})}}function g(e,t,r,a,l){const s=e.portalItem,o={portalItem:s.clone(),layerId:a.id};a.url!=null&&(o.url=a.url);const n=new t(o);if("sourceJSON"in n&&(n.sourceJSON=l),n.type!=="subtype-group"&&(n.sublayerTitleMode="service-name"),s.type==="Feature Collection"){const i={origin:"portal-item",portal:s.portal||E.getDefault()};n.read(a,i);const c=r.showLegend;c!=null&&n.read({showLegend:c},i)}return n}async function L(e,t,r){if(e.supportsData===!1)return;const a=e.instance,l=a.portalItem;if(!l)return;let s=null;try{s=await l.fetchData("json",r)}catch{}if(B(a)){let o=null;const n=await U(l,s,t);if((s!=null&&s.layers||s!=null&&s.tables)&&n>0){if(a.layerId==null){const i=M(s);a.layerId=a.type==="subtype-group"?i==null?void 0:i[0]:q(s)}o=z(s,a),o&&s.showLegend!=null&&(o.showLegend=s.showLegend)}return n>1&&"sublayerTitleMode"in a&&a.sublayerTitleMode!=="service-name"&&(a.sublayerTitleMode="item-title-and-service-name"),o}return s}async function U(e,t,r){var s,o,n,i;if(t!=null&&t.layers&&(t!=null&&t.tables))return T(t);const a=x(e.url);if(!a)return 1;const l=await r.fetchServiceMetadata(a.url.path).catch(()=>null);return(((s=t==null?void 0:t.layers)==null?void 0:s.length)??((o=l==null?void 0:l.layers)==null?void 0:o.length)??0)+(((n=t==null?void 0:t.tables)==null?void 0:n.length)??((i=l==null?void 0:l.tables)==null?void 0:i.length)??0)}async function A(e,t,r){if((e==null?void 0:e.layers)==null||(e==null?void 0:e.tables)==null){const a=await r.fetchServiceMetadata(t);(e=e||{}).layers=e.layers||(a==null?void 0:a.layers),e.tables=e.tables||(a==null?void 0:a.tables)}return e}function q(e){const t=e.layers;if(t&&t.length)return t[0].id;const r=e.tables;return r&&r.length?r[0].id:null}function z(e,t){var l,s;const{layerId:r}=t,a=((l=e.layers)==null?void 0:l.find(o=>o.id===r))||((s=e.tables)==null?void 0:s.find(o=>o.id===r));return a&&K(a,t)?a:null}function T(e){var t,r;return(((t=e==null?void 0:e.layers)==null?void 0:t.length)??0)+(((r=e==null?void 0:e.tables)==null?void 0:r.length)??0)}function B(e){return e.type!=="stream"&&"layerId"in e}function M(e){var r;const t=[];return(r=e==null?void 0:e.layers)==null||r.forEach(a=>{a.layerType==="SubtypeGroupLayer"&&t.push(a.id)}),t}function H(e){var t;return(t=e==null?void 0:e.layers)==null?void 0:t.filter(({layerType:r})=>r==="OrientedImageryLayer").map(({id:r})=>r)}function K(e,t){return!(t.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||t.type==="subtype-group"&&!("layerType"in e))}async function Q(e){const{layersJSON:t}=await j(e);if(!t)return null;const r=[...t.layers,...t.tables];return a=>r.find(l=>l.id===a.id)}export{v as LayerLoadContext,q as getFirstLayerOrTableId,T as getNumLayersAndTables,H as getOrientedImageryLayerIds,M as getSubtypeGroupLayerIds,Z as load,_ as populateSceneServiceItemData,A as preprocessFSItemData};
