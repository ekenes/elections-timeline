import{t as y,e as p,m as ge}from"./TimeOnly-36610d4e.js";import{t as b,X as Te,Q as Y,H as S,N as C,Y as Z,c as E,j as Fe,k as De,u as fe,J as R,v as U,V as N,q as _,z as xe,b as O,B as Ee,w as be,y as z,x as Ne,D as Ae,E as B,F as X,K as q}from"./arcadeUtils-4c521855.js";import{e as de,j as Re,q as ce,f as Se,c as ue,a as Le,b as Ze,d as Ce,g as $,k as ve,F as Pe,C as Me,x as k,E as ke,A as K,y as L,W as ee}from"./featureSetUtils-c109d75a.js";import{l as Oe}from"./portalUtils-5021de55.js";import{u as Ue,v as me}from"./SpatialFilter-5b781c1a.js";import{ar as ye,dM as ze,H as te,dl as j}from"./index-a1a1303e.js";import{x}from"./WhereClause-2e2ff29f.js";import"./number-ca5937fa.js";import"./arcadeTimeUtils-13bc9096.js";import"./featureConversionUtils-b3c52e9d.js";import"./OptimizedGeometry-33b2eb0d.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./SubtypeGroupLayer-33572ee7.js";import"./executeQueryJSON-e07e9845.js";import"./query-0fb2e4ab.js";import"./pbfQueryUtils-61f7b846.js";import"./pbf-75d66840.js";import"./executeQueryPBF-6363f381.js";import"./AttachmentInfo-ee1b3563.js";import"./executeForIds-1a431b43.js";import"./geometryEngineAsync-2a433dfd.js";function We(l,t,r,u){if(u.length===1){if(N(u[0]))return q(l,u[0],-1);if(O(u[0]))return q(l,u[0].toArray(),-1)}return q(l,u,-1)}async function ne(l,t,r){const u=l.getVariables();if(u.length>0){const F=[];for(let n=0;n<u.length;n++){const a={name:u[n]};F.push(await t.evaluateIdentifier(r,a))}const e={};for(let n=0;n<u.length;n++)e[u[n]]=F[n];return l.parameters=e,l}return l}function d(l,t,r=null){for(const u in l)if(u.toLowerCase()===t.toLowerCase())return l[u];return r}function pe(l){if(l===null)return null;const t={type:d(l,"type",""),name:d(l,"name","")};if(t.type==="range")t.range=d(l,"range",[]);else{t.codedValues=[];for(const r of d(l,"codedValues",[]))t.codedValues.push({name:d(r,"name",""),code:d(r,"code",null)})}return t}function ie(l){if(l===null)return null;const t={},r=d(l,"wkt",null);r!==null&&(t.wkt=r);const u=d(l,"wkid",null);return u!==null&&(t.wkid=u),t}function he(l){if(l===null)return null;const t={hasZ:d(l,"hasz",!1),hasM:d(l,"hasm",!1)},r=d(l,"spatialreference",null);r&&(t.spatialReference=ie(r));const u=d(l,"x",null);if(u!==null)return t.x=u,t.y=d(l,"y",null),t;const F=d(l,"rings",null);if(F!==null)return t.rings=F,t;const e=d(l,"paths",null);if(e!==null)return t.paths=e,t;const n=d(l,"points",null);if(n!==null)return t.points=n,t;for(const a of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const c=d(l,a,null);c!==null&&(t[a]=c)}return t}function He(l,t){for(const r of t)if(r===l)return!0;return!1}function je(l){return!!l.layerDefinition&&!!l.featureSet&&He(l.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&N(l.layerDefinition.fields)!==!1&&N(l.featureSet.features)!==!1}function G(l){return(l==null?void 0:l.toLowerCase())==="utc"?"UTC":l}function dt(l){l.mode==="async"&&(l.functions.timezone=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{if(b(e,1,2,t,r),Te(e[0])||Y(e[0]))return"unknown";if(S(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return G(e[0].dateTimeReferenceFieldIndex.layerDateFieldsTimeZone);if(!(e[1]instanceof C)||e[1].hasField("type")===!1)throw new y(t,p.InvalidParameter,r);const c=e[1].field("type");if(Z(c)===!1)throw new y(t,p.InvalidParameter,r);switch(E(c).toLowerCase()){case"preferredtimezone":return G(e[0].dateTimeReferenceFieldIndex.layerPreferredTimeZone);case"editfieldsinfo":return G(e[0].dateTimeReferenceFieldIndex.layerEditFieldsTimeZone);case"timeinfo":return G(e[0].dateTimeReferenceFieldIndex.layerTimeInfoTimeZone);case"field":if(e[1].hasField("fieldname")&&Z(e[1].field("fieldname")))return G(e[0].dateTimeReferenceFieldIndex.fieldTimeZone(E(e[1].field("fieldname"))))}throw new y(t,p.InvalidParameter,r)}const n=Fe(e[0],De(t));if(n===null)return null;const a=n.timeZone;return a==="system"?ge.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a})},l.functions.sqltimestamp=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{b(e,1,3,t,r);const n=e[0];if(fe(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new y(t,p.InvalidParameter,r)}if(Y(n))return n.toSQLWithKeyword();if(S(n)){if(e.length!==3)throw new y(t,p.InvalidParameter,r);await n.load();const a=E(e[1]);if(Y(e[2]))return e[2].toSQLWithKeyword();if(fe(e[2])===!1)throw new y(t,p.InvalidParameter,r);const c=n.fieldTimeZone(a);return c===null?e[2].toSQLWithKeyword():e[2].changeTimeZone(c).toSQLWithKeyword()}throw new y(t,p.InvalidParameter,r)})},l.signatures.push({name:"sqltimestamp",min:2,max:4}),l.functions.featuresetbyid=function(t,r){return l.standardFunctionAsync(t,r,(u,F,e)=>{if(b(e,2,4,t,r),e[0]instanceof de){const n=E(e[1]);let a=R(e[2],null);const c=U(R(e[3],!0));if(a===null&&(a=["*"]),N(a)===!1)throw new y(t,p.InvalidParameter,r);return e[0].featureSetById(n,c,a)}throw new y(t,p.InvalidParameter,r)})},l.signatures.push({name:"featuresetbyid",min:2,max:4}),l.functions.getfeatureset=function(t,r){return l.standardFunctionAsync(t,r,(u,F,e)=>{if(b(e,1,2,t,r),_(e[0])){let n=R(e[1],"datasource");return n===null&&(n="datasource"),n=E(n).toLowerCase(),Re(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference)}throw new y(t,p.InvalidParameter,r)})},l.signatures.push({name:"getfeatureset",min:1,max:2}),l.functions.featuresetbyportalitem=function(t,r){return l.standardFunctionAsync(t,r,(u,F,e)=>{var s;if(b(e,2,5,t,r),e[0]===null)throw new y(t,p.PortalRequired,r);if(e[0]instanceof xe){const i=E(e[1]),o=E(e[2]);let f=R(e[3],null);const h=U(R(e[4],!0));if(f===null&&(f=["*"]),N(f)===!1)throw new y(t,p.InvalidParameter,r);let I=null;return I=t.services&&t.services.portal?t.services.portal:ye.getDefault(),I=Oe(e[0],I),ce(i,o,t.spatialReference,f,h,I,t.lrucache,t.interceptor)}if(Z(e[0])===!1)throw new y(t,p.PortalRequired,r);const n=E(e[0]),a=E(e[1]);let c=R(e[2],null);const m=U(R(e[3],!0));if(c===null&&(c=["*"]),N(c)===!1)throw new y(t,p.InvalidParameter,r);return ce(n,a,t.spatialReference,c,m,((s=t.services)==null?void 0:s.portal)??ye.getDefault(),t.lrucache,t.interceptor)})},l.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),l.functions.featuresetbyname=function(t,r){return l.standardFunctionAsync(t,r,(u,F,e)=>{if(b(e,2,4,t,r),e[0]instanceof de){const n=E(e[1]);let a=R(e[2],null);const c=U(R(e[3],!0));if(a===null&&(a=["*"]),N(a)===!1)throw new y(t,p.InvalidParameter,r);return e[0].featureSetByName(n,c,a)}throw new y(t,p.InvalidParameter,r)})},l.signatures.push({name:"featuresetbyname",min:2,max:4}),l.functions.featureset=function(t,r){return l.standardFunction(t,r,(u,F,e)=>{var c;b(e,1,1,t,r);let n=e[0];const a={layerDefinition:{geometryType:"",objectIdField:"",hasM:!1,hasZ:!1,globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(Z(n))n=JSON.parse(n),n.layerDefinition!==void 0?(a.layerDefinition=n.layerDefinition,a.featureSet=n.featureSet,n.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=n.layerDefinition.spatialReference)):(a.featureSet.features=n.features,a.featureSet.geometryType=n.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=n.objectIdFieldName??"",a.layerDefinition.typeIdField=n.typeIdFieldName,a.layerDefinition.globalIdField=n.globalIdFieldName,a.layerDefinition.fields=n.fields,n.spatialReference&&(a.layerDefinition.spatialReference=n.spatialReference));else{if(!(e[0]instanceof C))throw new y(t,p.InvalidParameter,r);{n=JSON.parse(e[0].castToText(!0));const m=d(n,"layerdefinition");if(m!==null){a.layerDefinition.geometryType=d(m,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=d(m,"globalidfield",""),a.layerDefinition.objectIdField=d(m,"objectidfield",""),a.layerDefinition.typeIdField=d(m,"typeidfield",""),a.layerDefinition.hasZ=d(m,"hasz",!1)===!0,a.layerDefinition.hasM=d(m,"hasm",!1)===!0;const s=d(m,"spatialreference",null);s&&(a.layerDefinition.spatialReference=ie(s));for(const o of d(m,"fields",[])){const f={name:d(o,"name",""),alias:d(o,"alias",""),type:d(o,"type",""),nullable:d(o,"nullable",!0),editable:d(o,"editable",!0),length:d(o,"length",null),domain:pe(d(o,"domain"))};a.layerDefinition.fields.push(f)}const i=d(n,"featureset",null);if(i){const o={};for(const f of a.layerDefinition.fields)o[f.name.toLowerCase()]=f.name;for(const f of d(i,"features",[])){const h={},I=d(f,"attributes",{});for(const g in I)h[o[g.toLowerCase()]]=I[g];a.featureSet.features.push({attributes:h,geometry:he(d(f,"geometry",null))})}}}else{a.layerDefinition.hasZ=d(n,"hasz",!1)===!0,a.layerDefinition.hasM=d(n,"hasm",!1)===!0,a.layerDefinition.geometryType=d(n,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=d(n,"objectidfieldname",""),a.layerDefinition.typeIdField=d(n,"typeidfieldname","");const s=d(n,"spatialreference",null);s&&(a.layerDefinition.spatialReference=ie(s));let i=d(n,"fields",null);if(N(i))for(const h of i){const I={name:d(h,"name",""),alias:d(h,"alias",""),type:d(h,"type",""),nullable:d(h,"nullable",!0),editable:d(h,"editable",!0),length:d(h,"length",null),domain:pe(d(h,"domain"))};a.layerDefinition.fields.push(I)}else i=null,a.layerDefinition.fields=i;const o={};for(const h of a.layerDefinition.fields)o[h.name.toLowerCase()]=h.name;let f=d(n,"features",null);if(N(f))for(const h of f){const I={},g=d(h,"attributes",{});for(const D in g)I[o[D.toLowerCase()]]=g[D];a.featureSet.features.push({attributes:I,geometry:he(d(h,"geometry",null))})}else f=null,a.featureSet.features=f}}}if(je(a)===!1)throw new y(t,p.InvalidParameter,r);return(((c=a==null?void 0:a.layerDefinition)==null?void 0:c.geometryType)||"")===""&&(a.layerDefinition.geometryType="esriGeometryNull"),Se.create(a,t.spatialReference)})},l.signatures.push({name:"featureset",min:1,max:1}),l.functions.filter=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{if(b(e,2,2,t,r),N(e[0])||O(e[0])){const n=[];let a=e[0];a instanceof Ee&&(a=a.toArray());let c=null;if(!be(e[1]))throw new y(t,p.InvalidParameter,r);c=e[1].createFunction(t);for(const m of a){const s=c(m);ze(s)?await s===!0&&n.push(m):s===!0&&n.push(m)}return n}if(S(e[0])){const n=await e[0].load(),a=x.create(e[1],n.getFieldsIndex(),{timeZone:n.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC}),c=a.getVariables();if(c.length>0){const m=[];for(let i=0;i<c.length;i++){const o={name:c[i]};m.push(await l.evaluateIdentifier(t,o))}const s={};for(let i=0;i<c.length;i++)s[c[i]]=m[i];return a.parameters=s,new ue({parentfeatureset:e[0],whereclause:a})}return new ue({parentfeatureset:e[0],whereclause:a})}throw new y(t,p.InvalidParameter,r)})},l.signatures.push({name:"filter",min:2,max:2}),l.functions.orderby=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{if(b(e,2,2,t,r),S(e[0])){const n=new Le(e[1]);return new Ze({parentfeatureset:e[0],orderbyclause:n})}throw new y(t,p.InvalidParameter,r)})},l.signatures.push({name:"orderby",min:2,max:2}),l.functions.top=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{if(b(e,2,2,t,r),S(e[0]))return new Ce({parentfeatureset:e[0],topnum:e[1]});if(N(e[0]))return z(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,z(e[1]));if(O(e[0]))return z(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,z(e[1]));throw new y(t,p.InvalidParameter,r)})},l.signatures.push({name:"top",min:2,max:2}),l.functions.first=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{if(b(e,1,1,t,r),S(e[0])){const n=await e[0].first(u.abortSignal);if(n!==null){const a=Ne.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeReference);return a._underlyingGraphic=n,a}return n}return N(e[0])?e[0].length===0?null:e[0][0]:O(e[0])?e[0].length()===0?null:e[0].get(0):null})},l.signatures.push({name:"first",min:1,max:1}),l.functions.attachments=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{b(e,1,2,t,r);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof C){if(e[1].hasField("minsize")&&(n.minsize=z(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=U(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=z(e[1].field("maxsize"))),e[1].hasField("types")){const a=Ae(e[1].field("types"),!1);a.length>0&&(n.types=a)}}else if(e[1]!==null)throw new y(t,p.InvalidParameter,r)}if(_(e[0])){let a=e[0]._layer;return a instanceof te&&(a=$(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),a===null?[]:S(a)===!1?[]:(await a.load(),a.queryAttachments(e[0].field(a.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata))}if(e[0]===null)return[];throw new y(t,p.InvalidParameter,r)})},l.signatures.push({name:"attachments",min:1,max:2}),l.functions.featuresetbyrelationshipname=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{b(e,2,4,t,r);const n=e[0],a=E(e[1]);let c=R(e[2],null);const m=U(R(e[3],!0));if(c===null&&(c=["*"]),N(c)===!1)throw new y(t,p.InvalidParameter,r);if(e[0]===null)return null;if(!_(e[0]))throw new y(t,p.InvalidParameter,r);let s=n._layer;if(s instanceof te&&(s=$(s,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),s===null||S(s)===!1)return null;s=await s.load();const i=s.relationshipMetaData().filter(g=>g.name===a);if(i.length===0)return null;if(i[0].relationshipTableId!==void 0&&i[0].relationshipTableId!==null&&i[0].relationshipTableId>-1)return ve(s,i[0],n.field(s.objectIdField),s.spatialReference,c,m,t.lrucache,t.interceptor);let o=s.serviceUrl();if(!o)return null;o=o.charAt(o.length-1)==="/"?o+i[0].relatedTableId.toString():o+"/"+i[0].relatedTableId.toString();const f=await Pe(o,s.spatialReference,c,m,t.lrucache,t.interceptor);await f.load();let h=f.relationshipMetaData();if(h=h.filter(g=>g.id===i[0].id),n.hasField(i[0].keyField)===!1||n.field(i[0].keyField)===null){const g=await s.getFeatureByObjectId(n.field(s.objectIdField),[i[0].keyField]);if(g){const D=x.create(h[0].keyField+"= @id",f.getFieldsIndex(),{timeZone:f.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC});return D.parameters={id:g.attributes[i[0].keyField]},f.filter(D)}return new Ue({parentfeatureset:f})}const I=x.create(h[0].keyField+"= @id",f.getFieldsIndex(),{timeZone:f.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC});return I.parameters={id:n.field(i[0].keyField)},f.filter(I)})},l.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),l.functions.featuresetbyassociation=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{b(e,2,3,t,r);const n=e[0],a=E(R(e[1],"")).toLowerCase(),c=Z(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!_(e[0]))throw new y(t,p.InvalidParameter,r);let m=n._layer;if(m instanceof te&&(m=$(m,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),m===null||S(m)===!1)return null;await m.load();const s=m.serviceUrl(),i=await Me(s,t.spatialReference);let o=null,f=null,h=!1;if(c!==null&&c!==""&&c!==void 0){for(const T of i.terminals)T.terminalName===c&&(f=T.terminalId);f===null&&(h=!0)}const I=i.associations.getFieldsIndex(),g=I.get("TOGLOBALID").name,D=I.get("FROMGLOBALID").name,V=I.get("TOTERMINALID").name,Q=I.get("FROMTERMINALID").name,W=I.get("FROMNETWORKSOURCEID").name,H=I.get("TONETWORKSOURCEID").name,M=I.get("ASSOCIATIONTYPE").name,Ie=I.get("ISCONTENTVISIBLE").name,we=I.get("OBJECTID").name;for(const T of m.fields)if(T.type==="global-id"){o=n.field(T.name);break}let v=null,ae=new k(new j({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC})),re=new k(new j({name:"side",alias:"side",type:"string"}),x.create("''",i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC}));const A="globalid",le="globalId",oe={};for(const T in i.lkp)oe[T]=i.lkp[T].sourceId;const P=new ke(new j({name:"classname",alias:"classname",type:"string"}),null,oe);let w="";switch(a){case"midspan":{w=`((${g}='${o}') OR ( ${D}='${o}')) AND (${M} IN (5))`,P.codefield=x.create(`CASE WHEN (${g}='${o}') THEN ${W} ELSE ${H} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC});const T=X(L.findField(i.associations.fields,D));T.name=A,T.alias=A,v=new k(T,x.create(`CASE WHEN (${D}='${o}') THEN ${g} ELSE ${D} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC})),ae=i.unVersion>=4?new ee(L.findField(i.associations.fields,I.get("PERCENTALONG").name)):new k(new j({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC}));break}case"junctionedge":{w=`((${g}='${o}') OR ( ${D}='${o}')) AND (${M} IN (4,6))`,P.codefield=x.create(`CASE WHEN (${g}='${o}') THEN ${W} ELSE ${H} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC});const T=X(L.findField(i.associations.fields,D));T.name=A,T.alias=A,v=new k(T,x.create(`CASE WHEN (${D}='${o}') THEN ${g} ELSE ${D} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC})),re=new k(new j({name:"side",alias:"side",type:"string"}),x.create(`CASE WHEN (${M}=4) THEN 'from' ELSE 'to' END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC}));break}case"connected":{let T=`${g}='@T'`,se=`${D}='@T'`;f!==null&&(T+=` AND ${V}=@A`,se+=` AND ${Q}=@A`),w="(("+T+") OR ("+se+"))",w=B(w,"@T",o??""),T=B(T,"@T",o??""),f!==null&&(T=B(T,"@A",f.toString()),w=B(w,"@A",f.toString())),P.codefield=x.create("CASE WHEN "+T+` THEN ${W} ELSE ${H} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC});const J=X(L.findField(i.associations.fields,D));J.name=A,J.alias=A,v=new k(J,x.create("CASE WHEN "+T+` THEN ${D} ELSE ${g} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC}));break}case"container":w=`${g}='${o}' AND ${M} = 2`,f!==null&&(w+=` AND ${V} = `+f.toString()),P.codefield=W,w="( "+w+" )",v=new K(L.findField(i.associations.fields,D),A,A);break;case"content":w=`(${D}='${o}' AND ${M} = 2)`,f!==null&&(w+=` AND ${Q} = `+f.toString()),P.codefield=H,w="( "+w+" )",v=new K(L.findField(i.associations.fields,g),A,A);break;case"structure":w=`(${g}='${o}' AND ${M} = 3)`,f!==null&&(w+=` AND ${V} = `+f.toString()),P.codefield=W,w="( "+w+" )",v=new K(L.findField(i.associations.fields,D),A,le);break;case"attached":w=`(${D}='${o}' AND ${M} = 3)`,f!==null&&(w+=` AND ${Q} = `+f.toString()),P.codefield=H,w="( "+w+" )",v=new K(L.findField(i.associations.fields,g),A,le);break;default:throw new y(t,p.InvalidParameter,r)}return h&&(w="1 <> 1"),new L({parentfeatureset:i.associations,adaptedFields:[new ee(L.findField(i.associations.fields,we)),new ee(L.findField(i.associations.fields,Ie)),v,re,P,ae],extraFilter:w?x.create(w,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC}):null})})},l.signatures.push({name:"featuresetbyassociation",min:2,max:6}),l.functions.groupby=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{if(b(e,3,3,t,r),!S(e[0]))throw new y(t,p.InvalidParameter,r);const n=await e[0].load(),a=[],c=[];let m=!1,s=[];if(Z(e[1]))s.push(e[1]);else if(e[1]instanceof C)s.push(e[1]);else if(N(e[1]))s=e[1];else{if(!O(e[1]))throw new y(t,p.InvalidParameter,r);s=e[1].toArray()}for(const i of s)if(Z(i)){const o=x.create(E(i),n.getFieldsIndex(),{timeZone:n.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC}),f=me(o)===!0?E(i):"%%%%FIELDNAME";a.push({name:f,expression:o}),f==="%%%%FIELDNAME"&&(m=!0)}else{if(!(i instanceof C))throw new y(t,p.InvalidParameter,r);{const o=i.hasField("name")?i.field("name"):"%%%%FIELDNAME",f=i.hasField("expression")?i.field("expression"):"";if(o==="%%%%FIELDNAME"&&(m=!0),!o)throw new y(t,p.InvalidParameter,r);a.push({name:o,expression:x.create(f||o,n.getFieldsIndex(),{timeZone:n.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC})})}}if(s=[],Z(e[2]))s.push(e[2]);else if(N(e[2]))s=e[2];else if(O(e[2]))s=e[2].toArray();else{if(!(e[2]instanceof C))throw new y(t,p.InvalidParameter,r);s.push(e[2])}for(const i of s){if(!(i instanceof C))throw new y(t,p.InvalidParameter,r);{const o=i.hasField("name")?i.field("name"):"",f=i.hasField("statistic")?i.field("statistic"):"",h=i.hasField("expression")?i.field("expression"):"";if(!o||!f||!h)throw new y(t,p.InvalidParameter,r);c.push({name:o,statistic:f.toLowerCase(),expression:x.create(h,n.getFieldsIndex(),{timeZone:n.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC})})}}if(m){const i={};for(const f of n.fields)i[f.name.toLowerCase()]=1;for(const f of a)f.name!=="%%%%FIELDNAME"&&(i[f.name.toLowerCase()]=1);for(const f of c)f.name!=="%%%%FIELDNAME"&&(i[f.name.toLowerCase()]=1);let o=0;for(const f of a)if(f.name==="%%%%FIELDNAME"){for(;i["field_"+o.toString()]===1;)o++;i["field_"+o.toString()]=1,f.name="FIELD_"+o.toString()}}for(const i of a)await ne(i.expression,l,t);for(const i of c)await ne(i.expression,l,t);return e[0].groupby(a,c)})},l.signatures.push({name:"groupby",min:3,max:3}),l.functions.distinct=function(t,r){return l.standardFunctionAsync(t,r,async(u,F,e)=>{if(S(e[0])){b(e,2,2,t,r);const n=await e[0].load(),a=[];let c=[];if(Z(e[1]))c.push(e[1]);else if(e[1]instanceof C)c.push(e[1]);else if(N(e[1]))c=e[1];else{if(!O(e[1]))throw new y(t,p.InvalidParameter,r);c=e[1].toArray()}let m=!1;for(const s of c)if(Z(s)){const i=x.create(E(s),n.getFieldsIndex(),{timeZone:n.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC}),o=me(i)===!0?E(s):"%%%%FIELDNAME";a.push({name:o,expression:i}),o==="%%%%FIELDNAME"&&(m=!0)}else{if(!(s instanceof C))throw new y(t,p.InvalidParameter,r);{const i=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",o=s.hasField("expression")?s.field("expression"):"";if(i==="%%%%FIELDNAME"&&(m=!0),!i)throw new y(t,p.InvalidParameter,r);a.push({name:i,expression:x.create(o||i,n.getFieldsIndex(),{timeZone:n.dateTimeReferenceFieldIndex.layerTimeInfoTimeZoneDefaultUTC})})}}if(m){const s={};for(const o of n.fields)s[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(s[o.name.toLowerCase()]=1);let i=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;s["field_"+i.toString()]===1;)i++;s["field_"+i.toString()]=1,o.name="FIELD_"+i.toString()}}for(const s of a)await ne(s.expression,l,t);return e[0].groupby(a,[])}return We("distinct",u,F,e)})})}export{dt as registerFunctions};
