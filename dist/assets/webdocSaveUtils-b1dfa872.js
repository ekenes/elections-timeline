import{fO as F,e0 as K,fP as w,X as H,s as d,am as J,W as q,V as z,a as s,b as c,T as f,fD as Q,_ as X,cf as Y,C as Z,cg as $,fQ as ee,fR as ae,N as te,f as y,L as T,fS as ne,fT as oe}from"./index-02eff6e6.js";import{i as re}from"./originUtils-cfe4feaf.js";import{p as W}from"./resourceUtils-84f5c463.js";import{r as A,t as P}from"./saveUtils-795bb719.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";import"./resourceUtils-138d32d8.js";function ie(a){return!!(a!=null&&a.baseLayers.concat(a.referenceLayers).some(O))}function O(a){if(g(a.url))return!0;if(a.type==="vector-tile")for(const e in a.sourceNameToSource){const t=a.sourceNameToSource[e];if(g(t==null?void 0:t.sourceUrl))return!0}return!1}function se(a,e){var r;if(e==null||a==null)return{spatialReference:null,updating:!1};if(e.loadStatus==="not-loaded")return e.load(),{spatialReference:null,updating:!0};if(e.spatialReference)return{spatialReference:e.spatialReference,updating:!1};if(e.baseLayers.length===0)return{spatialReference:null,updating:!1};const t=e.baseLayers.at(0);switch(t.loadStatus){case"not-loaded":t.load();case"loading":return{spatialReference:null,updating:!0};case"failed":return{spatialReference:null,updating:!1}}const n=(("supportedSpatialReferences"in t?t.supportedSpatialReferences:null)||["tileInfo"in t?(r=t.tileInfo)==null?void 0:r.spatialReference:t.spatialReference]).filter(Boolean),o=a.spatialReference;return o?{spatialReference:n.find(i=>o.equals(i))??n[0]??null,updating:!1}:{spatialReference:n[0],updating:!1}}const le=/^(basemaps|ibasemaps).*-api\.arcgis\.com$/i;function g(a){if(!a)return!1;const e=new F(K(a));return!!e.authority&&le.test(e.authority)}const ce=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(a=>a.toLowerCase());async function Ue(a,e,t){t??(t={}),pe(a,e),await w(()=>!e.updatingFromView),await e.load(),await V(e),await A(e),await D(a,e);const n=e.portalItem,{json:o,jsonContext:r}=await L(e,n);return P(r,{errorName:`${a.name}:save`},t),await E(e,n),await De(a,e,n,o,r),await Promise.all([e.updateItemThumbnail(),W(e.resourceReferences,r)]),n}async function L(a,e){const t=H(e,"web-map",!0),n=a.write({},t);return await Promise.all(t.resources.pendingOperations),{json:n,jsonContext:t}}async function Fe(a,e,t,n){n??(n={});const o=ue(a,t);await w(()=>!e.updatingFromView),await e.load(),await V(e),await A(e),await D(a,e);const{json:r,jsonContext:i}=await L(e,o);P(i,{errorName:`${a.name}:save`},n),await we(e,o);const l=e.getThumbnailState();return await Ve(a,e,o,r,i,n)&&(e.resourceReferences.portalItem=o),e.restoreThumbnailFromState(l),await Promise.all([e.updateItemThumbnail(),W(e.resourceReferences,i)]),o}function pe(a,e){if(!e.portalItem)throw new d(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");C(a,e.portalItem)}function C(a,e){if(e.type!==a.itemType)throw new d(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}async function D(a,e){var n;if(a.name==="linkchart")return;if(!((n=e.basemap)!=null&&n.baseLayers.length))throw new d(`${a.name}:save`,"Map does not have a valid basemap with a base layer.");let t=null;if(await w(()=>{const o=se(e.initialViewProperties,e.basemap);return t=o.spatialReference,!o.updating}),!J(t,e.initialViewProperties.spatialReference))throw new d(`${a.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:t})}function ue(a,e){let t=q.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type=a.itemType),t.portal||(t.portal=z.getDefault()),C(a,t),t}function V(a){const e=[];return a.basemap&&e.push(a.basemap.load()),a.ground&&e.push(a.ground.load()),Promise.allSettled(e).then(()=>{})}async function E(a,e){e.extent=await Te(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),await ye(a,e)}const fe=y.JSAPI,N="CollectorDisabled",_="Collector",R="Data Editing",M="OfflineDisabled",b="Offline",k="Workforce Project",x="Workforce Worker",G="Workforce Dispatcher",de="Offline Map Areas",me="FieldMapsDisabled",v=y.DEVELOPER_BASEMAP,S="UtilityNetwork",I="IPS";async function we(a,e){s(e,N),s(e,me),s(e,y.METADATA),s(e,M),s(e,de),s(e,G),s(e,k),s(e,x),await E(a,e)}async function ye(a,e){c(e,fe),await he(a),_e(a,e),Re(a,e),be(a,e),ve(a,e),Se(a,e),Ie(a,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,n,o)=>o.indexOf(t)===n))}function he(a){const e=h(a).map(t=>t.load()).toArray();return Promise.allSettled(e).then(()=>{})}function h(a){return a.allLayers.concat(a.allTables)}function j(a){return h(a).some(e=>e.loaded&&T(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some(t=>t.editingEnabled)))}function ge(a){return h(a).filter(e=>e.type!=="group").every(e=>e.loaded&&Pe(a,e))}function _e(a,e){f(e,N)||f(e,k)||f(e,x)||f(e,G)||!j(a)?s(e,_):c(e,_)}function Re(a,e){j(a)?c(e,R):s(e,R)}function be(a,e){!f(e,M)&&ge(a)?c(e,b):s(e,b)}function ve(a,e){ie(a.basemap)?c(e,v):s(e,v)}function Se(a,e){var t;(t=a.utilityNetworks)!=null&&t.length?c(e,S):s(e,S)}function Ie(a,e){a.ipsInfo?c(e,I):s(e,I)}async function Te(a,e){const t=e.clone().normalize();let n;if(t.length>1)for(const o of t)n?o.width>n.width&&(n=o):n=o;else n=t[0];return We(a,n)}async function We(a,e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return Q(e);const{getGeometryServiceURL:n}=await X(()=>import("./geometryServiceUtils-6c913aec.js"),["assets/geometryServiceUtils-6c913aec.js","assets/index-02eff6e6.js","assets/index-d85835aa.css"]),o=await n(a),r=new Y({geometries:[e],outSpatialReference:Z.WGS84});return(await $(o,r))[0]}function Ae(a){return oe(a)||a.type==="map-notes"||a.type==="route"}function Pe(a,e){return T(e)&&e.capabilities.operations.supportsSync||Ae(e)&&!e.portalItem||Oe(e)&&!Le(e)&&e.spatialReference.equals(a.initialViewProperties.spatialReference)}function Oe(a){return(a.type==="tile"||a.type==="vector-tile")&&(a.capabilities.operations.supportsExportTiles||Ce(a)||O(a))}function Le(a){return a.type==="vector-tile"&&Object.keys(a.sourceNameToSource).length>1}function Ce(a){return a.type==="tile"&&ne(a.url)&&ce.some(e=>{var t;return(t=a.url)==null?void 0:t.toLowerCase().includes("/"+e+"/")})}async function De(a,e,t,n,o){await t.update({data:n}),B(a,e,t,n,o)}async function Ve(a,e,t,n,o,r){const i=e.portalItem,l={item:i,authenticated:!(!(i!=null&&i.id)||!i.portal.user)},p=t.portal;await p.signIn();const{copyAllowed:u,itemReloaded:m}=await Ee(l,p);if(l.authenticated||(l.authenticated=m),!u)throw new d(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const U=await Ne(t,l,n,r);return e.portalItem=t,B(a,e,t,n,o),U}async function Ee(a,e){var o;const{item:t,authenticated:n}=a;return t!=null&&t.id&&((o=t.typeKeywords)!=null&&o.includes("useOnly"))?t.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(n||await t.reload(),{copyAllowed:t.itemControl==="admin"||t.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function Ne(a,e,t,n){const o=a.portal,{item:r}=e,{folder:i,copyAllResources:l}=n;let p=!1;if(l&&(r!=null&&r.id)&&ee(r.portal.url,o.url)&&parseInt(r.portal.currentVersion,10)>=2023){const{total:u}=await r.fetchResources();p=!!u}if(p){const u=await r.copy({copyResources:"all",folder:i});a.id=u.id,a.portal=u.portal;const m=a.toJSON();await a.load(),a.read(m),await a.update({data:t})}else await o.user.addItem({item:a,folder:i,data:t});return p}function B(a,e,t,n,o){ae.prototype.read.call(e,{version:n.version,authoringApp:n.authoringApp,authoringAppVersion:n.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:t.itemUrl?te(t.itemUrl):void 0}),re(o),e.resourceInfo=n}export{L as createJSON,Ne as initializeNewItem,Ee as isCopyAllowed,Ue as save,Fe as saveAs};
