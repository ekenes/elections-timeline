import{t as y,e as p,m as ge}from"./TimeOnly-7709534d.js";import{n as b,K as Ie,X,U as R,N as Z,P as C,c as E,l as De,t as Te,Q as fe,u as S,y as O,q as N,H as _,A as xe,a as U,B as Ee,v as be,b as z,x as Ne,D as Ae,E as B,J as Y,S as q}from"./arcadeUtils-9059ecac.js";import{e as de,j as Se,q as ce,f as Re,c as ue,a as Le,b as Ce,d as Ze,g as $,k as ve,F as Pe,C as Me,x as k,E as ke,A as K,y as L,W as ee}from"./featureSetUtils-b5f17327.js";import{l as Ue}from"./portalUtils-fcf3051c.js";import{u as Oe,v as me}from"./SpatialFilter-5f14afcf.js";import{ar as ye,dM as ze,H as ne,dl as j}from"./index-10102046.js";import{x}from"./WhereClause-0f24bbde.js";import"./number-5c8e8ae2.js";import"./arcadeTimeUtils-6f9cbcf5.js";import"./featureConversionUtils-1947fb7d.js";import"./OptimizedGeometry-33b2eb0d.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./SubtypeGroupLayer-559253fb.js";import"./executeQueryJSON-ce8281b8.js";import"./query-ee1dd75d.js";import"./pbfQueryUtils-77b7e0c7.js";import"./pbf-43b1a242.js";import"./executeQueryPBF-a840aa56.js";import"./AttachmentInfo-de9b706b.js";import"./executeForIds-64785e03.js";import"./geometryEngineAsync-1f81c3a8.js";function He(s,n,r,u){if(u.length===1){if(N(u[0]))return q(s,u[0],-1);if(U(u[0]))return q(s,u[0].toArray(),-1)}return q(s,u,-1)}async function te(s,n,r){const u=s.getVariables();if(u.length>0){const D=[];for(let t=0;t<u.length;t++){const a={name:u[t]};D.push(await n.evaluateIdentifier(r,a))}const e={};for(let t=0;t<u.length;t++)e[u[t]]=D[t];return s.parameters=e,s}return s}function d(s,n,r=null){for(const u in s)if(u.toLowerCase()===n.toLowerCase())return s[u];return r}function pe(s){if(s===null)return null;const n={type:d(s,"type",""),name:d(s,"name","")};if(n.type==="range")n.range=d(s,"range",[]);else{n.codedValues=[];for(const r of d(s,"codedValues",[]))n.codedValues.push({name:d(r,"name",""),code:d(r,"code",null)})}return n}function ie(s){if(s===null)return null;const n={},r=d(s,"wkt",null);r!==null&&(n.wkt=r);const u=d(s,"wkid",null);return u!==null&&(n.wkid=u),n}function he(s){if(s===null)return null;const n={hasZ:d(s,"hasz",!1),hasM:d(s,"hasm",!1)},r=d(s,"spatialreference",null);r&&(n.spatialReference=ie(r));const u=d(s,"x",null);if(u!==null)return n.x=u,n.y=d(s,"y",null),n;const D=d(s,"rings",null);if(D!==null)return n.rings=D,n;const e=d(s,"paths",null);if(e!==null)return n.paths=e,n;const t=d(s,"points",null);if(t!==null)return n.points=t,n;for(const a of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const c=d(s,a,null);c!==null&&(n[a]=c)}return n}function We(s,n){for(const r of n)if(r===s)return!0;return!1}function je(s){return!!s.layerDefinition&&!!s.featureSet&&We(s.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&N(s.layerDefinition.fields)!==!1&&N(s.featureSet.features)!==!1}function G(s){return(s==null?void 0:s.toLowerCase())==="utc"?"UTC":s}function cn(s){s.mode==="async"&&(s.functions.timezone=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{if(b(e,1,2,n,r),Ie(e[0])||X(e[0]))return"unknown";if(R(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return G(e[0].dateTimeReferenceFieldIndex.layerDateFieldsTimeZone);if(!(e[1]instanceof Z)||e[1].hasField("type")===!1)throw new y(n,p.InvalidParameter,r);const c=e[1].field("type");if(C(c)===!1)throw new y(n,p.InvalidParameter,r);switch(E(c).toLowerCase()){case"preferredtimezone":return G(e[0].dateTimeReferenceFieldIndex.layerPreferredTimeZone);case"editfieldsinfo":return G(e[0].dateTimeReferenceFieldIndex.layerEditFieldsTimeZone);case"timeinfo":return G(e[0].dateTimeReferenceFieldIndex.layerTimeInfoTimeZone);case"field":if(e[1].hasField("fieldname")&&C(e[1].field("fieldname")))return G(e[0].dateTimeReferenceFieldIndex.fieldTimeZone(E(e[1].field("fieldname"))))}throw new y(n,p.InvalidParameter,r)}const t=De(e[0],Te(n));if(t===null)return null;const a=t.timeZone;return a==="system"?ge.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a})},s.functions.sqltimestamp=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{b(e,1,3,n,r);const t=e[0];if(fe(t)){if(e.length===1)return t.toSQLWithKeyword();if(e.length===2)return t.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new y(n,p.InvalidParameter,r)}if(X(t))return t.toSQLWithKeyword();if(R(t)){if(e.length!==3)throw new y(n,p.InvalidParameter,r);await t.load();const a=E(e[1]);if(X(e[2]))return e[2].toSQLWithKeyword();if(fe(e[2])===!1)throw new y(n,p.InvalidParameter,r);const c=t.fieldTimeZone(a);return c===null?e[2].toSQLWithKeyword():e[2].changeTimeZone(c).toSQLWithKeyword()}throw new y(n,p.InvalidParameter,r)})},s.signatures.push({name:"sqltimestamp",min:2,max:4}),s.functions.featuresetbyid=function(n,r){return s.standardFunctionAsync(n,r,(u,D,e)=>{if(b(e,2,4,n,r),e[0]instanceof de){const t=E(e[1]);let a=S(e[2],null);const c=O(S(e[3],!0));if(a===null&&(a=["*"]),N(a)===!1)throw new y(n,p.InvalidParameter,r);return e[0].featureSetById(t,c,a)}throw new y(n,p.InvalidParameter,r)})},s.signatures.push({name:"featuresetbyid",min:2,max:4}),s.functions.getfeatureset=function(n,r){return s.standardFunctionAsync(n,r,(u,D,e)=>{if(b(e,1,2,n,r),_(e[0])){let t=S(e[1],"datasource");return t===null&&(t="datasource"),t=E(t).toLowerCase(),Se(e[0].fullSchema(),t,n.lrucache,n.interceptor,n.spatialReference)}throw new y(n,p.InvalidParameter,r)})},s.signatures.push({name:"getfeatureset",min:1,max:2}),s.functions.featuresetbyportalitem=function(n,r){return s.standardFunctionAsync(n,r,(u,D,e)=>{var l;if(b(e,2,5,n,r),e[0]===null)throw new y(n,p.PortalRequired,r);if(e[0]instanceof xe){const i=E(e[1]),o=E(e[2]);let f=S(e[3],null);const h=O(S(e[4],!0));if(f===null&&(f=["*"]),N(f)===!1)throw new y(n,p.InvalidParameter,r);let w=null;return w=n.services&&n.services.portal?n.services.portal:ye.getDefault(),w=Ue(e[0],w),ce(i,o,n.spatialReference,f,h,w,n.lrucache,n.interceptor)}if(C(e[0])===!1)throw new y(n,p.PortalRequired,r);const t=E(e[0]),a=E(e[1]);let c=S(e[2],null);const m=O(S(e[3],!0));if(c===null&&(c=["*"]),N(c)===!1)throw new y(n,p.InvalidParameter,r);return ce(t,a,n.spatialReference,c,m,((l=n.services)==null?void 0:l.portal)??ye.getDefault(),n.lrucache,n.interceptor)})},s.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),s.functions.featuresetbyname=function(n,r){return s.standardFunctionAsync(n,r,(u,D,e)=>{if(b(e,2,4,n,r),e[0]instanceof de){const t=E(e[1]);let a=S(e[2],null);const c=O(S(e[3],!0));if(a===null&&(a=["*"]),N(a)===!1)throw new y(n,p.InvalidParameter,r);return e[0].featureSetByName(t,c,a)}throw new y(n,p.InvalidParameter,r)})},s.signatures.push({name:"featuresetbyname",min:2,max:4}),s.functions.featureset=function(n,r){return s.standardFunction(n,r,(u,D,e)=>{var c;b(e,1,1,n,r);let t=e[0];const a={layerDefinition:{geometryType:"",objectIdField:"",hasM:!1,hasZ:!1,globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(C(t))t=JSON.parse(t),t.layerDefinition!==void 0?(a.layerDefinition=t.layerDefinition,a.featureSet=t.featureSet,t.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=t.layerDefinition.spatialReference)):(a.featureSet.features=t.features,a.featureSet.geometryType=t.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=t.objectIdFieldName??"",a.layerDefinition.typeIdField=t.typeIdFieldName,a.layerDefinition.globalIdField=t.globalIdFieldName,a.layerDefinition.fields=t.fields,t.spatialReference&&(a.layerDefinition.spatialReference=t.spatialReference));else{if(!(e[0]instanceof Z))throw new y(n,p.InvalidParameter,r);{t=JSON.parse(e[0].castToText(!0));const m=d(t,"layerdefinition");if(m!==null){a.layerDefinition.geometryType=d(m,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=d(m,"globalidfield",""),a.layerDefinition.objectIdField=d(m,"objectidfield",""),a.layerDefinition.typeIdField=d(m,"typeidfield",""),a.layerDefinition.hasZ=d(m,"hasz",!1)===!0,a.layerDefinition.hasM=d(m,"hasm",!1)===!0;const l=d(m,"spatialreference",null);l&&(a.layerDefinition.spatialReference=ie(l));for(const o of d(m,"fields",[])){const f={name:d(o,"name",""),alias:d(o,"alias",""),type:d(o,"type",""),nullable:d(o,"nullable",!0),editable:d(o,"editable",!0),length:d(o,"length",null),domain:pe(d(o,"domain"))};a.layerDefinition.fields.push(f)}const i=d(t,"featureset",null);if(i){const o={};for(const f of a.layerDefinition.fields)o[f.name.toLowerCase()]=f.name;for(const f of d(i,"features",[])){const h={},w=d(f,"attributes",{});for(const g in w)h[o[g.toLowerCase()]]=w[g];a.featureSet.features.push({attributes:h,geometry:he(d(f,"geometry",null))})}}}else{a.layerDefinition.hasZ=d(t,"hasz",!1)===!0,a.layerDefinition.hasM=d(t,"hasm",!1)===!0,a.layerDefinition.geometryType=d(t,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=d(t,"objectidfieldname",""),a.layerDefinition.typeIdField=d(t,"typeidfieldname","");const l=d(t,"spatialreference",null);l&&(a.layerDefinition.spatialReference=ie(l));let i=d(t,"fields",null);if(N(i))for(const h of i){const w={name:d(h,"name",""),alias:d(h,"alias",""),type:d(h,"type",""),nullable:d(h,"nullable",!0),editable:d(h,"editable",!0),length:d(h,"length",null),domain:pe(d(h,"domain"))};a.layerDefinition.fields.push(w)}else i=null,a.layerDefinition.fields=i;const o={};for(const h of a.layerDefinition.fields)o[h.name.toLowerCase()]=h.name;let f=d(t,"features",null);if(N(f))for(const h of f){const w={},g=d(h,"attributes",{});for(const T in g)w[o[T.toLowerCase()]]=g[T];a.featureSet.features.push({attributes:w,geometry:he(d(h,"geometry",null))})}else f=null,a.featureSet.features=f}}}if(je(a)===!1)throw new y(n,p.InvalidParameter,r);return(((c=a==null?void 0:a.layerDefinition)==null?void 0:c.geometryType)||"")===""&&(a.layerDefinition.geometryType="esriGeometryNull"),Re.create(a,n.spatialReference)})},s.signatures.push({name:"featureset",min:1,max:1}),s.functions.filter=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{if(b(e,2,2,n,r),N(e[0])||U(e[0])){const t=[];let a=e[0];a instanceof Ee&&(a=a.toArray());let c=null;if(!be(e[1]))throw new y(n,p.InvalidParameter,r);c=e[1].createFunction(n);for(const m of a){const l=c(m);ze(l)?await l===!0&&t.push(m):l===!0&&t.push(m)}return t}if(R(e[0])){const t=await e[0].load(),a=x.create(e[1],t.getFieldsIndex(),{timeZone:t.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC}),c=a.getVariables();if(c.length>0){const m=[];for(let i=0;i<c.length;i++){const o={name:c[i]};m.push(await s.evaluateIdentifier(n,o))}const l={};for(let i=0;i<c.length;i++)l[c[i]]=m[i];return a.parameters=l,new ue({parentfeatureset:e[0],whereclause:a})}return new ue({parentfeatureset:e[0],whereclause:a})}throw new y(n,p.InvalidParameter,r)})},s.signatures.push({name:"filter",min:2,max:2}),s.functions.orderby=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{if(b(e,2,2,n,r),R(e[0])){const t=new Le(e[1]);return new Ce({parentfeatureset:e[0],orderbyclause:t})}throw new y(n,p.InvalidParameter,r)})},s.signatures.push({name:"orderby",min:2,max:2}),s.functions.top=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{if(b(e,2,2,n,r),R(e[0]))return new Ze({parentfeatureset:e[0],topnum:e[1]});if(N(e[0]))return z(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,z(e[1]));if(U(e[0]))return z(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,z(e[1]));throw new y(n,p.InvalidParameter,r)})},s.signatures.push({name:"top",min:2,max:2}),s.functions.first=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{if(b(e,1,1,n,r),R(e[0])){const t=await e[0].first(u.abortSignal);if(t!==null){const a=Ne.createFromGraphicLikeObject(t.geometry,t.attributes,e[0],n.timeReference);return a._underlyingGraphic=t,a}return t}return N(e[0])?e[0].length===0?null:e[0][0]:U(e[0])?e[0].length()===0?null:e[0].get(0):null})},s.signatures.push({name:"first",min:1,max:1}),s.functions.attachments=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{b(e,1,2,n,r);const t={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof Z){if(e[1].hasField("minsize")&&(t.minsize=z(e[1].field("minsize"))),e[1].hasField("metadata")&&(t.returnMetadata=O(e[1].field("metadata"))),e[1].hasField("maxsize")&&(t.maxsize=z(e[1].field("maxsize"))),e[1].hasField("types")){const a=Ae(e[1].field("types"),!1);a.length>0&&(t.types=a)}}else if(e[1]!==null)throw new y(n,p.InvalidParameter,r)}if(_(e[0])){let a=e[0]._layer;return a instanceof ne&&(a=$(a,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),a===null?[]:R(a)===!1?[]:(await a.load(),a.queryAttachments(e[0].field(a.objectIdField),t.minsize,t.maxsize,t.types,t.returnMetadata))}if(e[0]===null)return[];throw new y(n,p.InvalidParameter,r)})},s.signatures.push({name:"attachments",min:1,max:2}),s.functions.featuresetbyrelationshipname=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{b(e,2,4,n,r);const t=e[0],a=E(e[1]);let c=S(e[2],null);const m=O(S(e[3],!0));if(c===null&&(c=["*"]),N(c)===!1)throw new y(n,p.InvalidParameter,r);if(e[0]===null)return null;if(!_(e[0]))throw new y(n,p.InvalidParameter,r);let l=t._layer;if(l instanceof ne&&(l=$(l,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),l===null||R(l)===!1)return null;l=await l.load();const i=l.relationshipMetaData().filter(g=>g.name===a);if(i.length===0)return null;if(i[0].relationshipTableId!==void 0&&i[0].relationshipTableId!==null&&i[0].relationshipTableId>-1)return ve(l,i[0],t.field(l.objectIdField),l.spatialReference,c,m,n.lrucache,n.interceptor);let o=l.serviceUrl();if(!o)return null;o=o.charAt(o.length-1)==="/"?o+i[0].relatedTableId.toString():o+"/"+i[0].relatedTableId.toString();const f=await Pe(o,l.spatialReference,c,m,n.lrucache,n.interceptor);await f.load();let h=f.relationshipMetaData();if(h=h.filter(g=>g.id===i[0].id),t.hasField(i[0].keyField)===!1||t.field(i[0].keyField)===null){const g=await l.getFeatureByObjectId(t.field(l.objectIdField),[i[0].keyField]);if(g){const T=x.create(h[0].keyField+"= @id",f.getFieldsIndex(),{timeZone:f.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC});return T.parameters={id:g.attributes[i[0].keyField]},f.filter(T)}return new Oe({parentfeatureset:f})}const w=x.create(h[0].keyField+"= @id",f.getFieldsIndex(),{timeZone:f.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC});return w.parameters={id:t.field(i[0].keyField)},f.filter(w)})},s.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),s.functions.featuresetbyassociation=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{b(e,2,3,n,r);const t=e[0],a=E(S(e[1],"")).toLowerCase(),c=C(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!_(e[0]))throw new y(n,p.InvalidParameter,r);let m=t._layer;if(m instanceof ne&&(m=$(m,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),m===null||R(m)===!1)return null;await m.load();const l=m.serviceUrl(),i=await Me(l,n.spatialReference);let o=null,f=null,h=!1;if(c!==null&&c!==""&&c!==void 0){for(const I of i.terminals)I.terminalName===c&&(f=I.terminalId);f===null&&(h=!0)}const w=i.associations.getFieldsIndex(),g=w.get("TOGLOBALID").name,T=w.get("FROMGLOBALID").name,Q=w.get("TOTERMINALID").name,V=w.get("FROMTERMINALID").name,H=w.get("FROMNETWORKSOURCEID").name,W=w.get("TONETWORKSOURCEID").name,M=w.get("ASSOCIATIONTYPE").name,we=w.get("ISCONTENTVISIBLE").name,Fe=w.get("OBJECTID").name;for(const I of m.fields)if(I.type==="global-id"){o=t.field(I.name);break}let v=null,ae=new k(new j({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC})),re=new k(new j({name:"side",alias:"side",type:"string"}),x.create("''",i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC}));const A="globalid",se="globalId",oe={};for(const I in i.lkp)oe[I]=i.lkp[I].sourceId;const P=new ke(new j({name:"classname",alias:"classname",type:"string"}),null,oe);let F="";switch(a){case"midspan":{F=`((${g}='${o}') OR ( ${T}='${o}')) AND (${M} IN (5))`,P.codefield=x.create(`CASE WHEN (${g}='${o}') THEN ${H} ELSE ${W} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC});const I=Y(L.findField(i.associations.fields,T));I.name=A,I.alias=A,v=new k(I,x.create(`CASE WHEN (${T}='${o}') THEN ${g} ELSE ${T} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC})),ae=i.unVersion>=4?new ee(L.findField(i.associations.fields,w.get("PERCENTALONG").name)):new k(new j({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{F=`((${g}='${o}') OR ( ${T}='${o}')) AND (${M} IN (4,6))`,P.codefield=x.create(`CASE WHEN (${g}='${o}') THEN ${H} ELSE ${W} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC});const I=Y(L.findField(i.associations.fields,T));I.name=A,I.alias=A,v=new k(I,x.create(`CASE WHEN (${T}='${o}') THEN ${g} ELSE ${T} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC})),re=new k(new j({name:"side",alias:"side",type:"string"}),x.create(`CASE WHEN (${M}=4) THEN 'from' ELSE 'to' END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC}));break}case"connected":{let I=`${g}='@T'`,le=`${T}='@T'`;f!==null&&(I+=` AND ${Q}=@A`,le+=` AND ${V}=@A`),F="(("+I+") OR ("+le+"))",F=B(F,"@T",o??""),I=B(I,"@T",o??""),f!==null&&(I=B(I,"@A",f.toString()),F=B(F,"@A",f.toString())),P.codefield=x.create("CASE WHEN "+I+` THEN ${H} ELSE ${W} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC});const J=Y(L.findField(i.associations.fields,T));J.name=A,J.alias=A,v=new k(J,x.create("CASE WHEN "+I+` THEN ${T} ELSE ${g} END`,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC}));break}case"container":F=`${g}='${o}' AND ${M} = 2`,f!==null&&(F+=` AND ${Q} = `+f.toString()),P.codefield=H,F="( "+F+" )",v=new K(L.findField(i.associations.fields,T),A,A);break;case"content":F=`(${T}='${o}' AND ${M} = 2)`,f!==null&&(F+=` AND ${V} = `+f.toString()),P.codefield=W,F="( "+F+" )",v=new K(L.findField(i.associations.fields,g),A,A);break;case"structure":F=`(${g}='${o}' AND ${M} = 3)`,f!==null&&(F+=` AND ${Q} = `+f.toString()),P.codefield=H,F="( "+F+" )",v=new K(L.findField(i.associations.fields,T),A,se);break;case"attached":F=`(${T}='${o}' AND ${M} = 3)`,f!==null&&(F+=` AND ${V} = `+f.toString()),P.codefield=W,F="( "+F+" )",v=new K(L.findField(i.associations.fields,g),A,se);break;default:throw new y(n,p.InvalidParameter,r)}return h&&(F="1 <> 1"),new L({parentfeatureset:i.associations,adaptedFields:[new ee(L.findField(i.associations.fields,Fe)),new ee(L.findField(i.associations.fields,we)),v,re,P,ae],extraFilter:F?x.create(F,i.associations.getFieldsIndex(),{timeZone:i.associations.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC}):null})})},s.signatures.push({name:"featuresetbyassociation",min:2,max:6}),s.functions.groupby=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{if(b(e,3,3,n,r),!R(e[0]))throw new y(n,p.InvalidParameter,r);const t=await e[0].load(),a=[],c=[];let m=!1,l=[];if(C(e[1]))l.push(e[1]);else if(e[1]instanceof Z)l.push(e[1]);else if(N(e[1]))l=e[1];else{if(!U(e[1]))throw new y(n,p.InvalidParameter,r);l=e[1].toArray()}for(const i of l)if(C(i)){const o=x.create(E(i),t.getFieldsIndex(),{timeZone:t.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC}),f=me(o)===!0?E(i):"%%%%FIELDNAME";a.push({name:f,expression:o}),f==="%%%%FIELDNAME"&&(m=!0)}else{if(!(i instanceof Z))throw new y(n,p.InvalidParameter,r);{const o=i.hasField("name")?i.field("name"):"%%%%FIELDNAME",f=i.hasField("expression")?i.field("expression"):"";if(o==="%%%%FIELDNAME"&&(m=!0),!o)throw new y(n,p.InvalidParameter,r);a.push({name:o,expression:x.create(f||o,t.getFieldsIndex(),{timeZone:t.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC})})}}if(l=[],C(e[2]))l.push(e[2]);else if(N(e[2]))l=e[2];else if(U(e[2]))l=e[2].toArray();else{if(!(e[2]instanceof Z))throw new y(n,p.InvalidParameter,r);l.push(e[2])}for(const i of l){if(!(i instanceof Z))throw new y(n,p.InvalidParameter,r);{const o=i.hasField("name")?i.field("name"):"",f=i.hasField("statistic")?i.field("statistic"):"",h=i.hasField("expression")?i.field("expression"):"";if(!o||!f||!h)throw new y(n,p.InvalidParameter,r);c.push({name:o,statistic:f.toLowerCase(),expression:x.create(h,t.getFieldsIndex(),{timeZone:t.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC})})}}if(m){const i={};for(const f of t.fields)i[f.name.toLowerCase()]=1;for(const f of a)f.name!=="%%%%FIELDNAME"&&(i[f.name.toLowerCase()]=1);for(const f of c)f.name!=="%%%%FIELDNAME"&&(i[f.name.toLowerCase()]=1);let o=0;for(const f of a)if(f.name==="%%%%FIELDNAME"){for(;i["field_"+o.toString()]===1;)o++;i["field_"+o.toString()]=1,f.name="FIELD_"+o.toString()}}for(const i of a)await te(i.expression,s,n);for(const i of c)await te(i.expression,s,n);return e[0].groupby(a,c)})},s.signatures.push({name:"groupby",min:3,max:3}),s.functions.distinct=function(n,r){return s.standardFunctionAsync(n,r,async(u,D,e)=>{if(R(e[0])){b(e,2,2,n,r);const t=await e[0].load(),a=[];let c=[];if(C(e[1]))c.push(e[1]);else if(e[1]instanceof Z)c.push(e[1]);else if(N(e[1]))c=e[1];else{if(!U(e[1]))throw new y(n,p.InvalidParameter,r);c=e[1].toArray()}let m=!1;for(const l of c)if(C(l)){const i=x.create(E(l),t.getFieldsIndex(),{timeZone:t.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC}),o=me(i)===!0?E(l):"%%%%FIELDNAME";a.push({name:o,expression:i}),o==="%%%%FIELDNAME"&&(m=!0)}else{if(!(l instanceof Z))throw new y(n,p.InvalidParameter,r);{const i=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",o=l.hasField("expression")?l.field("expression"):"";if(i==="%%%%FIELDNAME"&&(m=!0),!i)throw new y(n,p.InvalidParameter,r);a.push({name:i,expression:x.create(o||i,t.getFieldsIndex(),{timeZone:t.dateTimeReferenceFieldIndex.layerDateFieldsTimeZoneDefaultUTC})})}}if(m){const l={};for(const o of t.fields)l[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(l[o.name.toLowerCase()]=1);let i=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;l["field_"+i.toString()]===1;)i++;l["field_"+i.toString()]=1,o.name="FIELD_"+i.toString()}}for(const l of a)await te(l.expression,s,n);return e[0].groupby(a,[])}return He("distinct",u,D,e)})})}export{cn as registerFunctions};
