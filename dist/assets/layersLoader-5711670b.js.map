{"version":3,"file":"layersLoader-5711670b.js","sources":["../../node_modules/@arcgis/core/portal/support/layersLoader.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{parse as t}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as r}from\"../../layers/support/fetchService.js\";import{LayerLoadContext as a}from\"../../layers/support/LayerLoadContext.js\";import{populateGroupLayer as o}from\"../../layers/support/layersCreator.js\";import{layerLookupMap as n}from\"../../layers/support/lazyLayerLoader.js\";import s from\"../Portal.js\";import{createForItemRead as i}from\"./jsonContext.js\";import{getFirstLayerOrTable as l,preprocessFSItemData as c,populateSceneServiceItemData as u,getNumLayersAndTables as p,createSublayerData as y,instanceTypeToLayerType as f,getSublayersByLayerType as m,layerTypeToLayerModuleType as d}from\"./loadUtils.js\";import{hasTypeKeyword as w}from\"./portalItemUtils.js\";import{loadStyleRenderer as h}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as I}from\"../../support/requestPresets.js\";async function b(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),g(e),e.validateItem&&e.validateItem(r),L(e,t)}function g(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function L(e,t){const r=e.instance,o=r.portalItem;if(!o)return;const{url:n,title:s}=o,l=i(o,\"portal-item\");if(\"group\"===r.type)return v(r,l,e);n&&\"media\"!==r.type&&r.read({url:n},l);const c=new a,u=await F(e,c,t);return u&&r.read(u,l),r.resourceReferences={portalItem:o,paths:l.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:s},l),h(r,l)}async function v(t,r,a){const o=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:s}=o;if(\"Group Layer\"===s){if(!w(o,\"Map\"))throw new e(\"portal:invalid-layer-item-typekeyword\",\"'Group Layer' item without 'Map' type keyword is not supported\");return j(t)}return t.read({title:n},r),S(t,a)}async function j(e){const t=e.portalItem,r=await t.fetchData(\"json\");if(!r)return;const a=i(t,\"web-map\");e.read(r,a),await o(e,r,{context:a}),e.resourceReferences={portalItem:t,paths:a.readResourcePaths??[]}}async function S(t,r){let o;const{portalItem:n}=t;if(!n)return;const s=n.type,i=r.layerModuleTypeMap;switch(s){case\"Feature Service\":case\"Feature Collection\":o=i.FeatureLayer;break;case\"Stream Service\":o=i.StreamLayer;break;case\"Scene Service\":o=i.SceneLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const y=new a;let[f,m]=await Promise.all([o(),F(r,y)]),d=()=>f;if(\"Feature Service\"===s){const e=l(m)?.customParameters;m=n.url?await c(m,n.url,y):{},d=await R(m,i)||d;const r=await E(n.url,{customParameters:e,loadContext:y});return await P(t,d,m,r)}return\"Scene Service\"===s&&n.url&&(m=await u(n,m,y)),p(m)>0?await P(t,d,m):await T(t,d)}async function T(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await I(r.url);a&&P(e,t,{layers:a.layers?.map(y),tables:a.tables?.map(y)})}async function P(e,t,r,a){let o=r.layers||[];const s=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type?(o.forEach(((e,t)=>{e.id=t,\"Table\"===e?.layerDefinition?.type&&s.push(e)})),o=o.filter((e=>\"Table\"!==e?.layerDefinition?.type))):(o.reverse(),s.reverse()),o.forEach((o=>{const n=a?.(o);if(n||!a){const a=M(e,t(o),r,o,n);e.add(a)}})),s.length){const t=await n.FeatureLayer();s.forEach((o=>{const n=a?.(o);if(n||!a){const a=M(e,t,r,o,n);e.tables.add(a)}}))}}function M(e,t,r,a,o){const n=e.portalItem,i={portalItem:n.clone(),layerId:a.id};null!=a.url&&(i.url=a.url);const l=new t(i);if(\"sourceJSON\"in l&&(l.sourceJSON=o),\"subtype-group\"!==l.type&&\"catalog\"!==l.type&&(l.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===n.type){const e={origin:\"portal-item\",portal:n.portal||s.getDefault()};l.read(a,e);const t=r.showLegend;null!=t&&l.read({showLegend:t},e)}return l}async function F(e,t,r){if(!1===e.supportsData)return;const a=e.instance,o=a.portalItem;if(!o)return;let n=null;try{n=await o.fetchData(\"json\",r)}catch(s){}if(D(a)){let e=null;const r=await x(o,n,t);if((n?.layers||n?.tables)&&r>0){if(null==a.layerId){const e=f(a.type),t=e?m(n,e)[0]:l(n);t&&(a.layerId=t.id)}e=C(n,a),e&&null!=n.showLegend&&(e.showLegend=n.showLegend)}return r>1&&\"sublayerTitleMode\"in a&&\"service-name\"!==a.sublayerTitleMode&&(a.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function x(e,r,a){if(r?.layers&&r?.tables)return p(r);const o=t(e.url);if(!o)return 1;const n=await a.fetchServiceMetadata(o.url.path,{customParameters:l(r)?.customParameters}).catch((()=>null));return(r?.layers?.length??n?.layers?.length??0)+(r?.tables?.length??n?.tables?.length??0)}function C(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&k(a,t)?a:null}function D(e){return\"stream\"!==e.type&&\"layerId\"in e}function k(e,t){const r=\"layerType\"in e&&e.layerType,{type:a}=t;return!(\"feature\"===a&&r||\"catalog\"===a&&!r||\"oriented-imagery\"===a&&!r||\"subtype-group\"===a&&!r)}async function E(e,t){const{layersJSON:a}=await r(e,t);if(!a)return null;const o=[...a.layers,...a.tables];return e=>o.find((t=>t.id===e.id))}async function R(e,t){const{layers:r}=e;if(!r?.length)return;const a=new Set,o=[];for(const{layerType:i}of r){const e=i??\"FeatureLayer\";if(a.has(e))continue;a.add(e);const r=t[d(e)];o.push(r())}const n=await Promise.all(o),s=new Map;return Array.from(a).forEach(((e,t)=>{s.set(e,n[t])})),({layerType:e})=>{const t=e??\"FeatureLayer\";return s.get(t)}}export{b as load};\n"],"names":["b","e","t","r","g","L","o","n","s","i","v","c","a","u","F","h","w","j","S","y","f","m","d","l","R","E","P","p","T","I","_a","_b","M","D","x","C","_c","_d","_e","k"],"mappings":"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","x_google_ignoreList":[0]}