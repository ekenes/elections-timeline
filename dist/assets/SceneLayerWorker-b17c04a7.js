import{_ as N,cu as W,d4 as Z,C as B,gX as ee}from"./index-02eff6e6.js";import{n as te,a as re}from"./MeshLocalVertexSpace-795f86db.js";import{n as oe,d as ne}from"./vec3-9cc00b38.js";import"./projectVectorToVector-e55b88e0.js";import"./sphere-098e4920.js";import"./I3SUtil-4b58cb71.js";import"./projectPointToVector-4f128583.js";import"./mat3f64-e19cdcb8.js";import"./plane-53ccce62.js";import"./mat4f64-9a8384aa.js";import"./quatf64-216ddd5a.js";import"./I3SBinaryReader-aa5e0c58.js";import"./VertexAttribute-c957ed9e.js";import"./floatRGBA-7569b6cb.js";import"./NormalAttribute.glsl-335d8cbf.js";import"./interfaces-d79e913c.js";import"./BindType-d21d71dd.js";import"./orientedBoundingBox-e085098f.js";import"./quat-eaa78af8.js";import"./spatialReferenceEllipsoidUtils-16e47544.js";import"./computeTranslationToOriginAndRotation-e412a98d.js";var R,k;(function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"})(R||(R={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(k||(k={}));function ie(){return F||(F=new Promise(e=>N(()=>import("./i3s-2733707f.js"),["assets/i3s-2733707f.js","assets/_commonjsHelpers-2f3e7994.js"]).then(t=>t.i).then(({default:t})=>{const r=t({locateFile:se,onRuntimeInitialized:()=>e(r)});delete r.then})).catch(e=>{throw e})),F}function se(e){return W(`esri/libs/i3s/${e}`)}let F;class ae{constructor(t,r,s,i,c,a){this.layout=t,this.interleavedVertexData=r,this.indices=s,this.hasColors=i,this.hasModifications=c,this.positionData=a}}let fe=class{constructor(t,r,s,i,c,a,f){this.componentOffsets=t,this.featureIds=r,this.anchorIds=s,this.anchors=i,this.transformedGeometry=c,this.globalTrafo=a,this.obb=f}};new Z({deallocator:null});var V,b,H,Y,z;(function(e){e[e.Unmodified=0]="Unmodified",e[e.Culled=1]="Culled",e[e.NotChecked=2]="NotChecked"})(V||(V={})),function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(b||(b={}));(function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"})(H||(H={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(Y||(Y={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(z||(z={}));async function Oe(e){o=await g();const t=[e.geometryBuffer];return{result:J(o,e,t),transferList:t}}async function xe(e){var y;o=await g();const t=[e.geometryBuffer],{geometryBuffer:r}=e,s=r.byteLength,i=o._malloc(s),c=new Uint8Array(o.HEAPU8.buffer,i,s);c.set(new Uint8Array(r));const a=o.dracoDecompressPointCloudData(i,c.byteLength);if(o._free(i),a.error.length>0)throw new Error(`i3s.wasm: ${a.error}`);const f=((y=a.featureIds)==null?void 0:y.length)>0?a.featureIds.slice():null,d=a.positions.slice();return f&&t.push(f.buffer),t.push(d.buffer),{result:{positions:d,featureIds:f},transferList:t}}async function Te(e){await g(),le(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function De(e){await g(),ce(e)}async function Ce(e){o=await g(),o.setLegacySchema(e.context,e.jsonSchema)}async function $e(e){const{localMatrix:t,origin:r,positions:s,vertexSpace:i}=e,c=B.fromJSON(e.inSpatialReference),a=B.fromJSON(e.outSpatialReference);let f;const[{projectBuffer:d},{initializeProjection:y}]=await Promise.all([N(()=>import("./index-02eff6e6.js").then(l=>l.sz),["assets/index-02eff6e6.js","assets/index-d85835aa.css"]),N(()=>import("./index-02eff6e6.js").then(l=>l.sA),["assets/index-02eff6e6.js","assets/index-d85835aa.css"])]);await y(c,a);const w=[0,0,0];if(!d(r,c,0,w,a,0))throw new Error("Failed to project");if(i.type==="georeferenced"&&i.origin==null){if(f=new Float64Array(s.length),!d(s,c,0,f,a,0,f.length/3))throw new Error("Failed to project")}else{const l=i.type==="georeferenced"?te.fromJSON(i):re.fromJSON(i),{projectMeshVertexPositions:u}=await N(()=>import("./projectMeshVertexPositions-63d7f512.js"),["assets/projectMeshVertexPositions-63d7f512.js","assets/index-02eff6e6.js","assets/index-d85835aa.css","assets/MeshLocalVertexSpace-795f86db.js","assets/vertexSpaceConversion-19816ce6.js","assets/mat3f64-e19cdcb8.js","assets/mat4f64-9a8384aa.js","assets/spatialReferenceEllipsoidUtils-16e47544.js","assets/computeTranslationToOriginAndRotation-e412a98d.js","assets/projectPointToVector-4f128583.js","assets/meshVertexSpaceUtils-4a324c69.js","assets/vec3-9cc00b38.js","assets/BufferView-ca9895dd.js","assets/vec4-4d59ff29.js"]),m=u({vertexAttributes:{position:s},transform:t?{localMatrix:t}:void 0,vertexSpace:l,spatialReference:c},a);if(!m)throw new Error("Failed to project");f=m}const S=f.length,[E,L,_]=w;for(let l=0;l<S;l+=3)f[l]-=E,f[l+1]-=L,f[l+2]-=_;return{result:{projected:f,original:s,projectedOrigin:w},transferList:[f.buffer,s.buffer]}}async function je({normalMatrix:e,normals:t}){const r=new Float32Array(t.length);return oe(r,t,e),ee(e)&&ne(r,r),{result:{transformed:r,original:t},transferList:[r.buffer,t.buffer]}}function Be(e){G(e)}let P,o;function ce(e){if(!o)return;const t=e.modifications,r=o._malloc(8*t.length),s=new Float64Array(o.HEAPU8.buffer,r,t.length);for(let i=0;i<t.length;++i)s[i]=t[i];o.setModifications(e.context,r,t.length,e.isGeodetic),o._free(r)}function J(e,t,r){const{context:s,globalTrafo:i,mbs:c,obbData:a,elevationOffset:f,geometryBuffer:d,geometryDescriptor:y,indexToVertexProjector:w,vertexToRenderProjector:S}=t,E=e._malloc(d.byteLength),L=33,_=e._malloc(L*Float64Array.BYTES_PER_ELEMENT),l=new Uint8Array(e.HEAPU8.buffer,E,d.byteLength);l.set(new Uint8Array(d));const u=new Float64Array(e.HEAPU8.buffer,_,L);I(u,[NaN,NaN,NaN]);let m=u.byteOffset+3*u.BYTES_PER_ELEMENT,A=new Float64Array(u.buffer,m);I(A,i),m+=16*u.BYTES_PER_ELEMENT,A=new Float64Array(u.buffer,m),I(A,c),m+=4*u.BYTES_PER_ELEMENT,a&&(A=new Float64Array(u.buffer,m),I(A,a));const M=y,X={isDraco:!1,isLegacy:!1,color:t.layouts.some(h=>h.some(p=>p.name==="color")),normal:t.needNormals&&t.layouts.some(h=>h.some(p=>p.name==="normalCompressed")),uv0:t.layouts.some(h=>h.some(p=>p.name==="uv0")),uvRegion:t.layouts.some(h=>h.some(p=>p.name==="uvRegion")),featureIndex:M.featureIndex},n=e.process(s,!!t.obbData,E,l.byteLength,M,X,_,f,w,S,t.normalReferenceFrame);if(e._free(_),e._free(E),n.error.length>0)throw new Error(`i3s.wasm: ${n.error}`);if(n.discarded)return null;const U=n.componentOffsets.length>0?n.componentOffsets.slice():null,v=n.featureIds.length>0?n.featureIds.slice():null,q=n.anchorIds.length>0?Array.from(n.anchorIds):null,K=n.anchors.length>0?Array.from(n.anchors):null,O=n.interleavedVertedData.slice().buffer,x=n.indicesType===R.Int16?new Uint16Array(n.indices.buffer,n.indices.byteOffset,n.indices.byteLength/2).slice():new Uint32Array(n.indices.buffer,n.indices.byteOffset,n.indices.byteLength/4).slice(),T=n.positions.slice(),{buffer:D,byteOffset:C,byteLength:$}=n.positionIndices,j=n.positionIndicesType===R.Int16?new Uint16Array(D,C,$/2).slice():new Uint32Array(D,C,$/4).slice(),Q=new ae(t.layouts[0],O,x,n.hasColors,n.hasModifications,{data:T,indices:j});return v&&r.push(v.buffer),U&&r.push(U.buffer),r.push(O),r.push(x.buffer),r.push(T.buffer),r.push(j.buffer),new fe(U,v,q,K,Q,i,n.obb)}function ke(e){return e===0?b.Unmodified:e===1?b.PotentiallyModified:e===2?b.Culled:b.Unknown}function le(e){if(!o)return;const{context:t,buffer:r}=e,s=o._malloc(r.byteLength),i=r.byteLength/Float64Array.BYTES_PER_ELEMENT,c=new Float64Array(o.HEAPU8.buffer,s,i),a=new Float64Array(r);c.set(a),o.filterOBBs(t,s,i),a.set(c),o._free(s)}function G(e){o&&o.destroy(e)===0&&(o=null)}function I(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function Ve(){o||await g()}function g(){return o?Promise.resolve(o):(P||(P=ie().then(e=>(o=e,P=null,o))),P)}const He={transform:(e,t)=>o&&J(o,e,t),destroy:G};export{Be as destroyContext,xe as dracoDecompressPointCloudData,Te as filterObbsForModifications,le as filterObbsForModificationsSync,Ve as initialize,ke as interpretObbModificationResults,Oe as process,$e as project,Ce as setLegacySchema,De as setModifications,ce as setModificationsSync,He as test,je as transformNormals};
