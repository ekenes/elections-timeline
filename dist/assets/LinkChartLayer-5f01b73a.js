import{ck as Te,cl as Ie,b8 as fe,R as Le,s as J,a8 as G,ay as Ce,ab as De,eN as xe,aV as se,Q as Me,C as T,D as I,J as Re,co as Ae}from"./index-76dad814.js";import{o as V}from"./featureConversionUtils-b0e2d6ba.js";import{E as Oe,c as oe,I as _e,b as ve,v as Ge,L as Se,m as Pe,h as He,a as Fe,f as Ue,d as D,s as F,t as K,r as X,e as Be,n as E,o as ke,g as ze,u as $e}from"./KnowledgeGraphSublayer-eda6c5a9.js";import{F as We}from"./knowledgeGraphService-3b670746.js";import"./GraphicsLayer-ffff398b.js";import"./GraphQueryStreaming-dc22f10e.js";import"./FeatureStore-1061cd43.js";import"./BoundsStore-b464477d.js";import"./PooledRBush-f047a2ee.js";import"./timeSupport-d7036d62.js";import"./optimizedFeatureQueryEngineAdapter-6620a995.js";import"./QueryEngine-9cc9f690.js";import"./WhereClause-0d51d3b3.js";import"./TimeOnly-45af311b.js";import"./QueryEngineCapabilities-85c4f1d0.js";import"./utils-cf2e7669.js";import"./utils-a0bd1234.js";import"./ClassBreaksDefinition-8af16aed.js";import"./clientSideDefaults-fbb2ba4b.js";import"./capabilities-0809f3bf.js";var Z;(function(e){e.MULTIPLIER="multiplier",e.ABSOLUTE="absoluteValue"})(Z||(Z={}));let b=class extends Te(Ie(Ae)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new fe,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new Le({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new fe,this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new J("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){var l,r,y,M,m,g;if(!this.title&&this.url){const s=this.url.split("/");this.title=s[s.length-2]}const t=new Set;let i=[],a=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new J("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");(l=e.knowledgeGraph.dataModel.entityTypes)==null||l.forEach(s=>{s.name&&this._graphTypeLookup.set(s.name,s)}),(r=e.knowledgeGraph.dataModel.relationshipTypes)==null||r.forEach(s=>{s.name&&this._graphTypeLookup.set(s.name,s)}),(y=e.inclusionModeDefinition)!=null&&y.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],a=e.knowledgeGraph.dataModel.relationshipTypes??[]):(M=e.inclusionModeDefinition)!=null&&M.namedTypeDefinitions&&((m=e.inclusionModeDefinition)==null?void 0:m.namedTypeDefinitions.size)>0?(g=e.inclusionModeDefinition)==null||g.namedTypeDefinitions.forEach((s,h)=>{var S,x;const L=this._graphTypeLookup.get(h);if(!L)return G.getLogger(this).warn(`A named type, ${h}, was in the inclusion list that wasn't in the data model and will be removed`),void((S=e.inclusionModeDefinition)==null?void 0:S.namedTypeDefinitions.delete(h));L.type==="relationship"?t.has(h)||(t.add(h),a.push(L)):L.type==="entity"?t.has(h)||(t.add(h),i.push(L)):(G.getLogger(this).warn(`A named type, ${h}, was in the inclusion list that wasn't properly modeled and will be removed`),(x=e.inclusionModeDefinition)==null||x.namedTypeDefinitions.delete(h))}):(i=e.knowledgeGraph.dataModel.entityTypes??[],a=e.knowledgeGraph.dataModel.relationshipTypes??[]);const o=new Oe({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=a,this.dataManager=o}load(e){return this.addResolvingPromise(new Promise(t=>{We(this.url).then(async i=>{var a,o,l,r,y,M;if(this._initializeLayerProperties({knowledgeGraph:i,inclusionModeDefinition:this._originalInclusionList}),(o=(a=this.dataManager.inclusionModeDefinition)==null?void 0:a.namedTypeDefinitions)!=null&&o.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},(l=this.dataManager.knowledgeGraph.dataModel.entityTypes)==null||l.forEach(m=>{var g;m.name&&((g=this.dataManager.inclusionModeDefinition)==null||g.namedTypeDefinitions.set(m.name,{useAllData:!0}))}),(r=this.dataManager.knowledgeGraph.dataModel.relationshipTypes)==null||r.forEach(m=>{var g;m.name&&((g=this.dataManager.inclusionModeDefinition)==null||g.namedTypeDefinitions.set(m.name,{useAllData:!0}))})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),await oe(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),(y=this.dataManager.inclusionModeDefinition)==null||y.namedTypeDefinitions.forEach(m=>{var g;m.useAllData=!1,(g=m.members)==null||g.forEach(s=>{let h;h=s.linkChartLocation instanceof Ce?s.linkChartLocation:s.linkChartLocation?V(s.linkChartLocation):null,h&&h.coords.length===2&&h.lengths.length===0?this.entityLinkChartDiagramLookup.set(s.id,h):this.relationshipLinkChartDiagramLookup.set(s.id,h)}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async s=>{await s.refreshCachedQueryEngine()}),this.tables.forEach(async s=>{await s.refreshCachedQueryEngine()})}))});else{const m=((M=this.defaultLinkChartConfig)==null?void 0:M.layoutMode)==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,m,!0).then(async()=>{De(e);const g=[],s=[];this.loadLayerAssumingLocalCache(),await oe(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(h=>{h.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(h=>{s.push(h.refreshCachedQueryEngine()),g.push(new Promise(L=>{h.on("layerview-create",()=>{L(null)})}))}),this.tables.forEach(h=>{s.push(h.refreshCachedQueryEngine())}),await Promise.all(s)}))}t(null)})})),Promise.resolve(this)}async addRecords(e,t){let i=[];t!=null&&t.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=await _e(e,this.dataManager.knowledgeGraph));const a=e.concat(i).filter(o=>{var l;return!((l=this.sublayerIdsCache.get(o.typeName))!=null&&l.has(o.id))});await this._handleNewRecords(a)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:i=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){var l,r,y,M,m,g,s,h;let a=[];for(const L of e)((y=(r=(l=this.dataManager.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions)==null?void 0:r.get(L.typeName))==null?void 0:y.useAllData)===!1&&((s=(g=(m=(M=this.dataManager.inclusionModeDefinition)==null?void 0:M.namedTypeDefinitions)==null?void 0:m.get(L.typeName))==null?void 0:g.members)!=null&&s.has(L.id))&&a.push(L);if(t){const L=new Set,S=[];for(const x of a)if(this.dataManager.nodeConnectionsLookup.has(x.id))for(const $ of this.dataManager.nodeConnectionsLookup.get(x.id))L.add($);for(const x of L)if(this.dataManager.memberIdTypeLookup.has(x))for(const $ of this.dataManager.memberIdTypeLookup.get(x))this.dataManager.relationshipTypeNames.has($)&&S.push({id:x,typeName:$});a=a.concat(S)}this.dataManager.removeFromLayer(a);for(const L of a)(h=this.sublayerIdsCache.get(L.typeName))==null||h.delete(L.id),this.dataManager.relationshipTypeNames.has(L.typeName)?this.relationshipLinkChartDiagramLookup.delete(L.id):this.entityLinkChartDiagramLookup.delete(L.id);i&&await this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,this._currentLinkChartConfig.layoutOptions);const o=[];return this.layers.forEach(L=>{o.push(L.refreshCachedQueryEngine())}),await Promise.all(o),this._refreshNamedTypes(),a}async expand(e,t){const i=await this.dataManager.getConnectedRecordIds(e,t),a=i.filter(o=>{var l;return!((l=this.sublayerIdsCache.get(o.typeName))!=null&&l.has(o.id))});return await this._handleNewRecords(i),{records:a}}loadLayerAssumingLocalCache(){var e,t;this.memberRelationshipTypes.forEach(i=>{const a=this._createSublayer(i);a.geometryType?this.layers.push(a):this.tables.push(a),this.dataManager.sublayerCaches.has(i.name)||this.dataManager.sublayerCaches.set(i.name,new Map)}),this.memberEntityTypes.forEach(i=>{const a=this._createSublayer(i);a.geometryType?this.layers.push(a):this.tables.push(a),this.dataManager.sublayerCaches.has(i.name)||this.dataManager.sublayerCaches.set(i.name,new Map)}),(e=this.dataManager.inclusionModeDefinition)!=null&&e.namedTypeDefinitions&&((t=this.dataManager.inclusionModeDefinition)==null||t.namedTypeDefinitions.forEach((i,a)=>{var l;const o=xe(this.sublayerIdsCache,a,()=>new Set);(l=i.members)==null||l.forEach(r=>{if(o.add(r.id),r.linkChartLocation)if(r.linkChartLocation instanceof Ce)this.dataManager.relationshipTypeNames.has(a)?this.relationshipLinkChartDiagramLookup.set(r.id,r.linkChartLocation):this.entityLinkChartDiagramLookup.set(r.id,r.linkChartLocation);else{const y=V(r.linkChartLocation);this.dataManager.relationshipTypeNames.has(a)?this.relationshipLinkChartDiagramLookup.set(r.id,r.linkChartLocation?y:null):this.entityLinkChartDiagramLookup.set(r.id,r.linkChartLocation?y:null)}})}))}async calculateLinkChartLayout(e="RADIAL_TREE",t){var ce,pe,ye,ge;const i=[],a=[],o=[];this.dataManager.sublayerCaches.forEach((n,d)=>{this.dataManager.entityTypeNames.has(d)?n.forEach(c=>{i.push({typeName:d,feature:c})}):this.dataManager.relationshipTypeNames.has(d)&&n.forEach(c=>{a.push({typeName:d,feature:c})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const l=new Map,r=new Map,y=new Map,M=new Map,m=new Uint8Array(i.length),g=new Float64Array(i.length),s=new Float64Array(i.length),h=new Float64Array(i.length),L=new Float64Array(i.length),S=new Uint32Array(a.length),x=new Uint32Array(a.length),$=new Float64Array(a.length),re=new Float64Array(a.length),C=[],we="FORCE_DIRECTED",O=new Le({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let W,le="FORCE_DIRECTED",f=0,R=0;const be=ve.apply;switch(le=e==="GEOGRAPHIC"?we:e,le){case"FORCE_DIRECTED":W=Ue.apply;break;case"COMMUNITY":W=Fe.apply;break;case"HIERARCHICAL":W=He.apply;break;case"RADIAL_TREE":W=Pe.apply;break;case"SMART_TREE":W=Se.apply;break;default:W=Ge.apply}let ee=!1;i.forEach(({typeName:n,feature:d})=>{var c,U,B,k,A;if(e!=="CHRONOLOGICAL_SINGLE"&&e!=="CHRONOLOGICAL_MULTIPLE"&&((c=t==null?void 0:t.lockedNodeLocations)!=null&&c.has(d.attributes[D]))){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(n)?m[f]=F.IsGeographic:m[f]=F.None;const u=t.lockedNodeLocations.get(d.attributes[D]);g[f]=u.x,s[f]=u.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(n)){m[f]=F.IsGeographic;let u=null;const w=d.attributes[this.dataManager.geographicLookup.get(n).name];switch((U=this.dataManager.geographicLookup.get(n))==null?void 0:U.geometryType){case"esriGeometryPoint":g[f]=w==null?void 0:w.x,s[f]=w==null?void 0:w.y;break;case"esriGeometryPolygon":u=w==null?void 0:w.centroid,(u==null?void 0:u.x)!=null&&(u==null?void 0:u.y)!=null?(g[f]=u.x,s[f]=u.y):m[f]=F.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":u=(B=w==null?void 0:w.extent)==null?void 0:B.center,(u==null?void 0:u.x)!=null&&(u==null?void 0:u.y)!=null?(g[f]=u.x,s[f]=u.y):m[f]=F.IsMovable;break;default:m[f]=F.IsMovable}(g[f]==null||s[f]==null||Number.isNaN(g[f])||Number.isNaN(s[f]))&&(m[f]=F.IsMovable,g[f]=0,s[f]=0)}else if(e==="CHRONOLOGICAL_SINGLE"||e==="CHRONOLOGICAL_MULTIPLE"){!ee&&((k=t==null?void 0:t.lockedNodeLocations)!=null&&k.has(d.attributes[D]))&&(ee=!0);const u=(A=t==null?void 0:t.timeInfoByTypeName)==null?void 0:A.get(n),w=u==null?void 0:u.startField,_=w&&(u!=null&&u.startField)?d.attributes[w]:null;h[f]=_?new Date(_).getTime():NaN;const P=u==null?void 0:u.endField,H=P&&(u!=null&&u.endField)?d.attributes[P]:null;L[f]=H?new Date(H).getTime():NaN,g[f]=0,s[f]=0,m[f]=F.IsMovable}else m[f]=F.IsMovable,g[f]=0,s[f]=0;M.set(d.attributes[D],f),C[f]={feature:d,typeName:n},f++}),ee&&G.getLogger(this).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let he=!1;const te=new Map;a.forEach(n=>{var P;const d=n.feature.attributes[K],c=n.feature.attributes[X],U=M.get(d),B=M.get(c),k=(P=t==null?void 0:t.timeInfoByTypeName)==null?void 0:P.get(n.typeName),A=t!=null&&t.timeInfoByTypeName?k==null?void 0:k.startField:null,u=A?n.feature.attributes[A]:null,w=k==null?void 0:k.endField,_=w?n.feature.attributes[w]:null;if(U!==void 0&&B!==void 0){let H=d+"-"+c;e!=="CHRONOLOGICAL_SINGLE"&&e!=="CHRONOLOGICAL_MULTIPLE"||(H=H+"-"+u+"-"+_);const j=te.get(H);(j==null?void 0:j.has(n.typeName))||(S[R]=U,x[R]=B,e!=="CHRONOLOGICAL_SINGLE"&&e!=="CHRONOLOGICAL_MULTIPLE"||($[R]=u?new Date(u).getTime():NaN,re[R]=_?new Date(_).getTime():NaN),j===void 0?te.set(H,new Map([[n.typeName,R]])):j.set(n.typeName,R),R++),o.push(n)}else he=!0,this.relationshipLinkChartDiagramLookup.set(d,null)}),he&&G.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");const de=this._validateLayoutSettings(e,t),ae=this._convertLayoutSettingsToCalculationSettings(de);await Be();let Y=!1,N=null;if(e==="CHRONOLOGICAL_SINGLE"||e==="CHRONOLOGICAL_MULTIPLE"){let n;({success:Y,links:N,graphics:n}=be(m,g,s,h,L,S.subarray(0,R),x.subarray(0,R),$.subarray(0,R),re.subarray(0,R),e==="CHRONOLOGICAL_MULTIPLE",(t==null?void 0:t.chronologicalLayoutSettings)??{})),Y&&(this.chronologicalAuxiliaryGraphics=n)}else({success:Y,links:N}=W(m,g,s,S.subarray(0,R),x.subarray(0,R),ae.computationBudgetTime,ae.idealEdgeLengthMultiplier,ae.repulsionRadiusMultiplier));if(!Y)throw new J("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let n=0;n<C.length;n++){if(s[n]>84.9999?s[n]=84.9999:s[n]<-84.9999&&(s[n]=-84.9999),g[n]>179.9999?g[n]=179.9999:g[n]<-179.9999&&(g[n]=-179.9999),C[n].feature.attributes[E]=new se(g[n],s[n]),l.has(C[n].typeName)){const c=l.get(C[n].typeName);c==null||c.set(C[n].feature.attributes[D],C[n].feature)}else{const c=new Map;c.set(C[n].feature.attributes[D],C[n].feature),l.set(C[n].typeName,c)}y.set(C[n].feature.attributes[D],C[n].feature);const d=V(C[n].feature.attributes[E]);this.entityLinkChartDiagramLookup.set(C[n].feature.attributes[D],C[n].feature.attributes[E]?d:null),C[n].feature.attributes[E].x<O.xmin&&(O.xmin=C[n].feature.attributes[E].x),C[n].feature.attributes[E].x>O.xmax&&(O.xmax=C[n].feature.attributes[E].x),C[n].feature.attributes[E].y<O.ymin&&(O.ymin=C[n].feature.attributes[E].y),C[n].feature.attributes[E].y>O.ymax&&(O.ymax=C[n].feature.attributes[E].y)}if(this.linkChartExtent.xmin=O.xmin,this.linkChartExtent.xmax=O.xmax,this.linkChartExtent.ymin=O.ymin,this.linkChartExtent.ymax=O.ymax,!N)throw new J("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const q=new Map,ie=new Map,ne=new Map,ue=new Set;for(let n=0;n<o.length;n++){const d=[],c=o[n],U=c.feature.attributes[K],B=c.feature.attributes[X];let k=U+"-"+B;if(e==="CHRONOLOGICAL_SINGLE"||e==="CHRONOLOGICAL_MULTIPLE"){const p=(ce=t==null?void 0:t.timeInfoByTypeName)==null?void 0:ce.get(c.typeName),v=t!=null&&t.timeInfoByTypeName?p==null?void 0:p.startField:null,z=v?c.feature.attributes[v]:null,Q=p==null?void 0:p.endField;k+="-"+z+"-"+(Q?c.feature.attributes[Q]:null)}const A=te.get(k).get(c.typeName),u=A===0?0:N==null?void 0:N.vertexEndIndex[A-1];if(!ue.has(A)){if(ue.add(A),N.types[A]===ke.Recursive){const p=[N.vertices[2*u],N.vertices[2*u+1]],v=[N.vertices[2*(u+1)],N.vertices[2*(u+1)+1]],z=[.5*(p[0]+v[0]),.5*(p[1]+v[1])],Q=[z[0]-p[0],z[1]-p[1]],Ee=[z[0]+Q[1],z[1]-Q[0]],Ne=[z[0]-Q[1],z[1]+Q[0]];d.push(p),d.push(Ee),d.push(v),d.push(Ne),d.push(p)}else{if(N.types[A]!==ke.Regular){G.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let p=u;p<N.vertexEndIndex[A];p++)d.push([N.vertices[2*p],N.vertices[2*p+1]])}if(e!=="CHRONOLOGICAL_SINGLE"&&e!=="CHRONOLOGICAL_MULTIPLE"){const p=(pe=C[M.get(U)])==null?void 0:pe.feature.attributes[E],v=(ye=C[M.get(B)])==null?void 0:ye.feature.attributes[E];d[0][0]===p.x&&d[0][1]===p.y||(d[0]=[p.x,p.y]),d[d.length-1][0]===v.x&&d[d.length-1][1]===v.y||(d[d.length-1]=[v.x,v.y])}for(let p=1;p<d.length-1;p++)d[p][1]>85.5?d[p][1]=85.5:d[p][1]<-85.5&&(d[p][1]=-85.5),d[p][0]>179.9999?d[p][0]=179.9999:d[p][0]<-179.9999&&(d[p][0]=-179.9999);q.has(k)?q.get(k).push(d):q.set(k,[d])}const w=q.get(k);ie.has(k)||(ie.set(k,new Map),ne.set(k,new Map));const _=ie.get(k),P=ne.get(k);_.has(c.typeName)||(_.set(c.typeName,w.shift()),P.set(c.typeName,0));const H=_.get(c.typeName);P.set(c.typeName,P.get(c.typeName)+1);const j=new Me({paths:[H]});if(c.feature.attributes[E]=j,r.has(c.typeName)){const p=r.get(c.typeName);p==null||p.set(c.feature.attributes[D],c.feature)}else{const p=new Map;p.set(c.feature.attributes[D],c.feature),r.set(c.typeName,p)}y.set(c.feature.attributes[D],c.feature);const me=V(c.feature.attributes[E]);this.relationshipLinkChartDiagramLookup.set(c.feature.attributes[D],c.feature.attributes[E]?me:null)}for(const n of o)n.feature.attributes[ze]=((ge=ne.get(n.feature.attributes[K]+"-"+n.feature.attributes[X]))==null?void 0:ge.get(n.typeName))??null;return this._currentLinkChartConfig={layoutMode:e,layoutOptions:de},{nodes:l,links:r,idMap:y}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const i=[];await this._calculateLayoutWithSublayerTimeInfo(e,t),this.layers.forEach(a=>{i.push(a.refreshCachedQueryEngine())}),await Promise.all(i),this._refreshNamedTypes()}getCurrentNodeLocations(){var t,i;const e=new Map;return(i=(t=this.dataManager.inclusionModeDefinition)==null?void 0:t.namedTypeDefinitions)==null||i.forEach(a=>{var o;(o=a==null?void 0:a.members)==null||o.forEach(l=>{const r=l.linkChartLocation;let y;const M=l.id;r&&(y="x"in r?{x:r.x,y:r.y}:{x:r.coords[0],y:r.coords[1]},e.set(M,new se({x:y.x,y:y.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{var t;(t=this.dataManager.inclusionModeDefinition)==null||t.namedTypeDefinitions.forEach((i,a)=>{if(i.useAllData=!1,i.members&&i.members.size>0){if(!this.dataManager.sublayerCaches.get(a))return;const o=new Set(Array.from(this.dataManager.sublayerCaches.get(a).keys()));Array.from(i.members.keys()).filter(l=>!o.has(l)).forEach(l=>{var r;(r=i.members)==null||r.delete(l)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach(i=>{t.push(i.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}async connectBetweenEntities(e){let t=[];for(const a of this.dataManager.relationshipTypeNames){const o=this.sublayerIdsCache.get(a);o&&(t=t.concat(Array.from(o.keys())))}const i=await this.dataManager.getRelationshipsBetweenNodes(e,t);return await this._handleNewRecords(i),{records:i}}async connectFromEntities(e){let t=[];for(const o of this.dataManager.relationshipTypeNames){const l=this.sublayerIdsCache.get(o);l&&(t=t.concat(Array.from(l.keys())))}let i=[];for(const o of this.dataManager.entityTypeNames){const l=this.sublayerIdsCache.get(o);l&&(i=i.concat(Array.from(l)))}const a=await this.dataManager.getRelationshipsFromNodes(e,i,t);return await this._handleNewRecords(a),{records:a}}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}async _calculateLayoutWithSublayerTimeInfo(e="RADIAL_TREE",t){const i=new Map;this.layers.forEach(a=>{i.set(a.objectType.name,a.timeInfo)}),await this.calculateLinkChartLayout(e,{timeInfoByTypeName:i,...t})}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const a of e)this.sublayerIdsCache.has(a.typeName)||(this.sublayerIdsCache.set(a.typeName,new Set),t.push(a.typeName)),this.sublayerIdsCache.get(a.typeName).add(a.id);for(const a of t){const o=this._graphTypeLookup.get(a);if(o){const l=this._createSublayer(o);o.type==="entity"?this.dataManager.entityTypeNames.add(a):this.dataManager.relationshipTypeNames.add(a),l.geometryType?this.layers.push(l):this.tables.push(l),this.dataManager.sublayerCaches.set(a,new Map)}}await oe(this,t),await this.dataManager.refreshCacheContent(e.map(a=>a.id));const i=Object.assign({},this._currentLinkChartConfig.layoutOptions);i.lockedNodeLocations=new Map;for(const[a,o]of this.entityLinkChartDiagramLookup.entries())o&&i.lockedNodeLocations.set(a,new se(o.coords[0],o.coords[1]));await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,i)}async _initializeDiagram(){var e,t;this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?((t=(e=this.dataManager.inclusionModeDefinition)==null?void 0:e.namedTypeDefinitions)==null||t.forEach((i,a)=>{var o;(o=i==null?void 0:i.members)==null||o.forEach(l=>{const r=l.linkChartLocation;let y;const M=l.id;if(!r)return;y="x"in r?{x:r.x,y:r.y}:{x:r.coords[0],y:r.coords[1]};const m=V(y);this.dataManager.relationshipTypeNames.has(a)?this.relationshipLinkChartDiagramLookup.set(M,m):this.entityLinkChartDiagramLookup.set(M,m),this.linkChartExtent.xmin>y.x&&(this.linkChartExtent.xmin=y.x),this.linkChartExtent.xmax<y.x&&(this.linkChartExtent.xmax=y.x),this.linkChartExtent.ymin>y.y&&(this.linkChartExtent.ymin=y.y),this.linkChartExtent.ymax<y.y&&(this.linkChartExtent.ymax=y.y)})}),this.memberRelationshipTypes.forEach(i=>{var a;i.name&&((a=this.dataManager.sublayerCaches.get(i.name))==null||a.forEach(o=>{const l=this.relationshipLinkChartDiagramLookup.get(o.attributes[K]),r=this.relationshipLinkChartDiagramLookup.get(o.attributes[X]);if(l&&r){const y=V(new Me({paths:[[[l.coords[0],l.coords[1]],[r.coords[0],r.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(o.attributes[D],y)}else this.relationshipLinkChartDiagramLookup.set(o.attributes[D],null)}))})):await this._calculateLayoutWithSublayerTimeInfo(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.defaultLinkChartConfig.layoutOptions||{}}):await this._calculateLayoutWithSublayerTimeInfo("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateLayoutSettings(e,t){const i=h=>typeof h=="number"&&!isNaN(h),a=h=>i(h)&&h>=1,o=h=>i(h)&&h>=1,l=h=>Object.values(Z).includes(h),r=h=>i(h)&&h>=0,y={organicLayoutSettings:{},chronologicalLayoutSettings:{}};if(!new Set(["FORCE_DIRECTED","COMMUNITY","GEOGRAPHIC","CHRONOLOGICAL_MULTIPLE","CHRONOLOGICAL_SINGLE"]).has(e)||!t)return y;t.organicLayoutSettings??(t.organicLayoutSettings={});const{computationBudgetTime:M,repulsionRadiusMultiplier:m,idealEdgeLength:g,idealEdgeLengthType:s}=t.organicLayoutSettings;if(o(M)?y.organicLayoutSettings.computationBudgetTime=M:M!==void 0&&G.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),a(m)?y.organicLayoutSettings.repulsionRadiusMultiplier=m:m!==void 0&&G.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting"),e==="GEOGRAPHIC"&&(g!==void 0||s!==void 0)&&(l(s)?y.organicLayoutSettings.idealEdgeLengthType=s:s!==void 0&&G.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),r(g)?y.organicLayoutSettings.idealEdgeLength=g:g!==void 0&&G.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),(e==="CHRONOLOGICAL_MULTIPLE"||e==="CHRONOLOGICAL_SINGLE")&&t.chronologicalLayoutSettings){const h=t.chronologicalLayoutSettings;h.durationLineWidth&&h.durationLineWidth<0&&G.getLogger(this).warn("Invalid layout durationLineWidth setting, will revert to default setting")}return y}_convertLayoutSettingsToCalculationSettings(e){e.organicLayoutSettings??(e.organicLayoutSettings={});let t=e.organicLayoutSettings.idealEdgeLength;return e.organicLayoutSettings.idealEdgeLengthType===Z.ABSOLUTE&&(t===void 0?t=-1:t*=-1),{computationBudgetTime:e.organicLayoutSettings.computationBudgetTime,repulsionRadiusMultiplier:e.organicLayoutSettings.repulsionRadiusMultiplier,idealEdgeLengthMultiplier:t}}_createSublayer(e){return new $e({objectType:e,parentCompositeLayer:this,graphType:e.type})}};T([I()],b.prototype,"dataPreloadedInLocalCache",void 0),T([I()],b.prototype,"defaultLinkChartConfig",void 0),T([I()],b.prototype,"dataManager",void 0),T([I()],b.prototype,"knowledgeGraph",void 0),T([I()],b.prototype,"layers",void 0),T([I()],b.prototype,"entityLinkChartDiagramLookup",void 0),T([I()],b.prototype,"relationshipLinkChartDiagramLookup",void 0),T([I()],b.prototype,"linkChartExtent",void 0),T([I()],b.prototype,"memberEntityTypes",void 0),T([I()],b.prototype,"memberRelationshipTypes",void 0),T([I()],b.prototype,"sublayerIdsCache",void 0),T([I()],b.prototype,"tables",void 0),T([I({json:{read:!1}})],b.prototype,"type",void 0),T([I({json:{read:!1}})],b.prototype,"chronologicalAuxiliaryGraphics",void 0),b=T([Re("esri.layers.LinkChartLayer")],b);const ut=b;export{ut as default};
