import{C as ot,s as ee,U as lt,et as X,aN as gt,aZ as Tt,aM as Oe,_ as bt,cu as wt,lC as pt,r as m,q as f,w as ke,d1 as Et,$ as It,g9 as pe,hS as _t,ee as ve,dL as re,cF as be,B as we,mW as xe,bF as dt,hQ as Nt,hB as Lt,hC as $t,d9 as vt,hA as Mt,fa as St,da as Dt,eD as Rt,eG as Ct,mX as kt,ef as Te,eg as le,hD as At,cz as Ie,hF as Ft,cx as Ot,hE as xt,P as jt,Y as qt,a8 as W,mY as Gt,mZ as Pt,m_ as Bt,m$ as Ut,hH as Ht,hI as zt,hJ as Qt,eI as Wt,h$ as Jt,i0 as Vt,hK as Yt,n0 as Zt,hL as Kt,cy as Xt,hM as en,jG as tn,A as nn,m5 as rn,ct as an,dd as sn}from"./index-c2b82012.js";import{i as Ae,r as on,a as Fe,H as ln,q as de}from"./knowledgeGraphService-a86d7d52.js";import{o as pn}from"./featureConversionUtils-65314b0a.js";import"./GraphicsLayer-a0d687bf.js";import{s as se}from"./GraphQueryStreaming-6dc7953f.js";import{m as dn}from"./FeatureStore-f7588460.js";import{L as un}from"./QueryEngine-f3b61189.js";import{y as cn,u as _e}from"./clientSideDefaults-7e58181d.js";let yn=class{constructor(){this.version="",this.queryResult=new hn}},hn=class{constructor(){this.featureResult=new mn}},mn=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new fn,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new gn,this.geometryType=null,this.spatialReference=new ot,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new ut,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},fn=class{constructor(){this.name="",this.isSystemMaintained=!1}},gn=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},ut=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new Tn,this.translate=new bn}},Tn=class{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}},bn=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},wn=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},En=class{constructor(){this.attributes=[],this.compressedGeometry=new Me,this.centroid=new Me,this.aggregateGeometries=[]}},Me=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var ye;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(ye||(ye={}));const In=[ye.ELEMENTUID,ye.TYPENAME];var je,qe;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(je||(je={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(qe||(qe={}));var Ge,Se,De,ue;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(Ge||(Ge={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(Se||(Se={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(De||(De={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(ue||(ue={}));function _n(e){const t=new yn;t.version=e.version;const i=e.get_query_result();if(i.results_type.value!==0)throw new Error("Got a non-feature collection type");const n=i.get_feature_result(),r=t.queryResult.featureResult;r.objectIdFieldName=n.objectid_field_name,r.exceededTransferLimit=n.exceeded_transfer_limit,r.hasM=n.has_m,r.hasZ=n.has_z,r.geometryType=Ae[n.geometry_type.value],r.globalIdFieldName=n.globalid_field_name,r.geohashFieldName=n.geohash_field_name;const a=r.uniqueIdField,s=n.unique_id_field;a.name=s.name,a.isSystemMaintained=s.isSystemMaintained;const o=r.geometryProperties,p=n.geometry_properties;o.shapeAreaFieldName=p.shapeAreaFieldName,o.shapeLengthFieldName=p.shapeLengthFieldName,o.units=p.units;const d=r.spatialReference,c=n.spatial_reference;d.wkid=c.wkid,d.latestWkid=c.latestWkid,d.vcsWkid=c.vcsWkid,d.latestVcsWkid=c.latestVcsWkid,d.wkt=c.wkt,r.transform=Ln(n.transform);const l=r.fields,u=r.fieldNameToAttributeIndexMap,y=n.fields,_=y.size();for(let w=0;w<_;w++){const $=y.get(w),M=ct($);l.push(M),u[M.name]=w,$.delete()}y.delete();const N=r.values,A=n.values_count();for(let w=0;w<A;w++)N.push(n.get_value_at(w));const h=r.features,L=n.features,S=L.size();if(S>0){for(const w of In)if(u[w]===void 0)throw new Error(`Feature collection missing required attribute: ${w}`)}for(let w=0;w<S;w++){const $=new En,M=L.get(w),q=$.attributes,F=M.attributes_count();for(let I=0;I<F;I++)q.push(M.get_attribute_at(I));const G=M.get_compressed_geometry();G&&($.compressedGeometry=Ne(G),$.centroid=Ne(M.get_centroid()));const Q=$.aggregateGeometries,x=M.aggregate_geometries,U=x.size();for(let I=0;I<U;I++){const b=x.get(I),D=Ne(b);Q.push(D),b.delete()}x.delete(),h.push($),M.delete()}L.delete();const j=r.geometryFields,P=n.geometry_fields,B=P.size();for(let w=0;w<B;w++){const $=P.get(w),M=Nn($);j.push(M),$.delete()}return P.delete(),t}function Ne(e){const t=new Me;t.geometryType=Ae[e.geometry_type.value];const i=[],n=[];for(let r=0;r<e.lengths.length;r++)i.push(e.lengths[r]);for(let r=0;r<e.coords.length;r++)n.push(e.coords[r]);return t.lengths=i,t.coords=n,t}function ct(e){const t=new wn;return t.name=e.name,t.alias=e.alias,t.fieldType=on[e.field_type.value],t.sqlType=De[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function Nn(e){const t=ct(e);return t.geometryType=Ae[e.geometry_type.value],t}function Ln(e){const t=new ut;t.quantizeOriginPosition=Se[e.quantizeOriginPosition.value];const i=t.scale,n=e.scale;i.xScale=n.xScale,i.yScale=n.yScale,i.mScale=n.mScale,i.zScale=n.zScale;const r=t.translate,a=e.translate;return r.xTranslate=a.xTranslate,r.yTranslate=a.yTranslate,r.mTranslate=a.mTranslate,r.zTranslate=a.zTranslate,t}async function $n(e){const t=[],i={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(Pe(e.entitiesUrl).then(n=>{Be(n,i)})),e.relationshipsUrl&&t.push(Pe(e.relationshipsUrl).then(n=>{Be(n,i)})),await Promise.all(t),i}async function ai(e,t){t??(t=!1);const i={generateAllSublayers:t,namedTypeDefinitions:new Map};return await Sn(e).then(n=>{Rn(n,i)}),i}async function si(e){const t=await Fe(),i=new t.MapOfObjectIdentifierSets;vn(i,t,e);const n=new t.MapOfObjectIdentifierSetsEncoder;try{n.set_map_of_identifier_sets(i),n.encode();const r=n.get_encoding_result();if(r.error.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",r.error.error_message);const a=structuredClone(r.get_byte_buffer());return n.delete(),a}finally{i.delete()}}function vn(e,t,i){for(const[n,r]of i.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const a=r.members.keys();let s=!1,o=!0;const p=new t.ObjectIdArray,d=new t.StringArray,c=new t.GlobalIdArray,l=new t.IdentifierArray,u=new t.ObjectIdentifierSet;for(const y of a)o&&(s=!isNaN(Number(y)),o=!1),s?p.add_objectid(Number(y)):(d.add_string(y),c.add_globalid(y)),l.add_identifier(y);u.set_oid_array(p),u.set_string_array(d),u.set_globalid_array(c),u.set_identifier_array(l),p.delete(),d.delete(),c.delete(),l.delete(),e.put_identifier_set(n,u),u.delete()}return e}async function Pe(e){const t=await lt(e,{responseType:"array-buffer"});return Mn(await t.data)}async function Mn(e){const t=new(await Fe()).FeatureCollectionDecoder,i=t.decode(new Uint8Array(e));if(i.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",i.error_message);const n=t.get_feature_collection(),r=_n(n);return t.delete(),r}async function Sn(e){const t=await lt(e,{responseType:"array-buffer"}),i=await t.data;return Dn(new Uint8Array(i))}async function Dn(e){const t=new(await Fe()).MapOfObjectIdentifierSetsDecoder,i=t.decode(new Uint8Array(e)),n=new Map;if(i.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",i.error_message);const r=t.get_map_of_identifier_sets(),a=r.keys,s=a.size();for(let o=0;o<s;o++){const p=a.get(o),d=r.query_identifier_set(p),c=[];if(d.id_array_type.value===ue.GLOBALID_ARRAY){const l=d.get_globalid_array(),u=l.count();for(let y=0;y<u;y++)c.push(l.get_globalid_at(y))}else if(d.id_array_type.value===ue.IDENTIFIER_ARRAY){const l=d.get_identifier_array(),u=l.count();for(let y=0;y<u;y++)c.push(l.get_identifier_at(y).toString())}else if(d.id_array_type.value===ue.STRING_ARRAY){const l=d.get_string_array(),u=l.count();for(let y=0;y<u;y++)c.push(l.get_string_at(y))}else{if(d.id_array_type.value!==ue.OID_ARRAY)throw new ee("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const l=d.get_oid_array(),u=l.count();for(let y=0;y<u;y++)c.push(l.get_objectid_at(y).toString())}}n.set(p,c)}return t.delete(),n}function Be(e,t){var n,r,a;if(!((n=e==null?void 0:e.queryResult)!=null&&n.featureResult))return t;const i=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const s of e.queryResult.featureResult.features){const o=s.attributes[i[ye.TYPENAME]],p=X(t.namedTypeDefinitions,o,()=>({useAllData:!1,members:new Map})),d=s.attributes[i[ye.ELEMENTUID]];if(((a=(r=s.compressedGeometry)==null?void 0:r.coords)==null?void 0:a.length)>0){let c=s.compressedGeometry.lengths;s.compressedGeometry.geometryType==="esriGeometryPoint"&&(c=[]),p.members.set(d,{id:d,linkChartLocation:new gt(c,s.compressedGeometry.coords)})}else p.members.set(d,{id:d})}return t}function Rn(e,t){for(const[i,n]of e){const r=X(t.namedTypeDefinitions,i,()=>({useAllData:!1,members:new Map}));for(const a of n)r.members.has(a)||r.members.set(a,{id:a})}return t}const oi={fetchAndConvertSerializedLinkChart:e=>$n(e)},Z="ESRI__ID",Re="ESRI__OriginID",Ce="ESRI__DestID",yt="ESRI__LayoutGeometry",Ue="ESRI__AggregationCount",me="LC.ESRI__IsSpatial",Cn={initializeLayersFromClientData:async(e,t,i)=>{if(t||(t=[...e.layers,...e.tables].map(a=>a.graphTypeName)),(t==null?void 0:t.length)===0)return;const n=new Map;for(const a of t)n.set(a,He(e,a));const r=await ln(e.dataManager.knowledgeGraph,Array.from(n.values()),{requestOptions:{signal:i==null?void 0:i.signal}});for(const a of[...e.layers,...e.tables]){const s=a.objectType.name;if(s==null)continue;const o=r.get(He(e,s));if(o){const p=JSON.parse(o);p===null||typeof p!="object"||p.hasOwnProperty("showLabels")||(p.showLabels=!1),a.read(p,{origin:"service"})}}}},He=(e,t)=>e.type==="knowledge-graph"?`${t}/Map`:`${t}/LinkChart/LinkChartSubLayer`;async function li(e,t,i){return Cn.initializeLayersFromClientData(e,t,i)}let Le=class oe{constructor(){this._featureLookup=new Map}static getInstance(){return oe.instance||(oe.instance=new oe),oe.instance}static resetInstance(){oe.instance&&(oe.instance=null)}deleteFromStore(t){t.forEach(i=>{this._featureLookup.delete(i)})}readFromStoreByList(t){const i=[];return t.forEach(n=>{const r=this.readFromStoreById(n);r&&i.push(r)}),i}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,i,n){const r=[];return t.forEach(a=>{if(!(a!=null&&a.id))return;a.properties||(a.properties=[]);let s,o=null;if(n&&a.properties[n]&&(o=pn(a.properties[n])),"originId"in a&&"destinationId"in a&&(a.properties[Re]=a.originId,a.properties[Ce]=a.destinationId),a.properties[i]=a.id,a.id&&this._featureLookup.has(a.id)&&this._featureLookup.get(a.id).attributes){const p=this._featureLookup.get(a.id),d=JSON.parse(JSON.stringify(Object.assign(p.attributes,a.properties)));n&&a.properties[n]&&(d[n]=Tt(a.properties[n])),s=new Oe(o?JSON.parse(JSON.stringify(o)):p!=null&&p.geometry?JSON.parse(JSON.stringify(p.geometry)):null,d,null,a.properties[i])}else s=new Oe(o?JSON.parse(JSON.stringify(o)):null,a.properties,null,a.properties[i]);this._featureLookup.set(`${a.typeName?`${a.typeName}__${a.id}`:a.id}`,s),r.push(s)}),r}},$e,E=null;function pi(){return $e||($e=bt(()=>import("./lclayout-7ca3af21.js"),["assets/lclayout-7ca3af21.js","assets/_commonjsHelpers-2f3e7994.js"]).then(e=>e.l).then(({default:e})=>e({locateFile:t=>wt(`esri/libs/linkchartlayout/${t}`)})).then(e=>{kn(e)}),$e)}function kn(e){E=e}var ze,te,Qe,fe,ce;function An(e){const t=Object.keys(fe).filter(n=>isNaN(parseInt(n,10))).indexOf(e.timeDirection);let i=ce.startAndEnd;switch(e.eventsTicksVisualization){case"start-only":i=ce.startOnly;break;case"none":i=ce.none}return{timeDirection:{value:t>-1?t:fe.right},timeBannerUTCOffsetInMinutes:e.timeBannerUTCOffsetInMinutes,eventsTicksVisualization:{value:i},showDurationLineForNonZeroDurationEntityEvents:e.showDurationLineForNonZeroDurationEntityEvents,durationLineWidth:e.durationLineWidth,entityPositionAtDurationRatio:e.entityPositionAtDurationRatio,showNonZeroDurationIntervalBounds:e.showNonZeroDurationIntervalBounds,separateTimeOverlaps:e.separateTimeOverlaps,separateTimelineOverlaps:e.separateTimelineOverlaps,moveFirstBends:e.moveFirstBends,secondBendRatio:e.secondBendRatio,lineSeparationMultiplier:e.lineSeparationMultiplier,spaceSeparatedLinesEvenly:e.spaceSeparatedLinesEvenly,useBezierCurves:e.useBezierCurves,separatedLineShapeRatio:e.separatedLineShapeRatio}}function ae(e,t,i,n,r,a){const s=i.length,o=r.length,p=Float64Array.BYTES_PER_ELEMENT,d=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,l=16,u=l+s*(c+2*p)+o*(2*d),y=E._malloc(u);try{const _=y+l-y%l,N=_+s*p,A=N+s*p,h=A+o*d,L=h+o*d,S=()=>[E.HEAPF64.subarray(_>>3,(_>>3)+s),E.HEAPF64.subarray(N>>3,(N>>3)+s),E.HEAPU32.subarray(A>>2,(A>>2)+o),E.HEAPU32.subarray(h>>2,(h>>2)+o),E.HEAPU8.subarray(L,L+s)],[j,P,B,w,$]=S();j.set(i),P.set(n),B.set(r),w.set(a),$.set(t);const M=e(s,L,_,N,o,A,h);let q=null,F=null;if(M.value===te.Success){const b=E.getLayoutLinksTypes(),D=E.getLayoutLinksVerticesEndIndices(),k=E.getLayoutLinksVertices(),R=E.countLayoutLinksVertices();!o||b&&D?R&&!k?M.value=te.Error:(q={types:new Uint8Array(E.HEAPU8.subarray(b,b+o)),vertexEndIndex:new Uint32Array(E.HEAPU32.subarray(D>>2,(D>>2)+o)),vertices:new Float64Array(E.HEAPF64.subarray(k>>3,(k>>3)+2*R))},F=E.getAuxiliaryGraphicElements()):M.value=te.Error}const[G,Q,x,U,I]=S();return i.set(G),n.set(Q),r.set(x),a.set(U),t.set(I),{status:M.value,links:q,graphics:F}}finally{E._free(y),E.cleanupLayout()}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot",e[e.IsOld=8]="IsOld"})(ze||(ze={})),function(e){e[e.Success=0]="Success",e[e.Error=1]="Error",e[e.Canceled=2]="Canceled"}(te||(te={})),function(e){e[e.Regular=0]="Regular",e[e.Curved=1]="Curved",e[e.Recursive=2]="Recursive"}(Qe||(Qe={})),function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom"}(fe||(fe={})),function(e){e[e.none=0]="none",e[e.startOnly=1]="startOnly",e[e.startAndEnd=2]="startAndEnd"}(ce||(ce={}));const We=2,Je=1,Ve=-1;var Ye,Ze,Ke,Xe,et,tt,nt,it,rt;(function(e){function t(){return E.getMinIdealEdgeLength()}function i(n,r,a,s,o,p,d=We,c=Je,l=Ve){return ae((u,y,_,N,A,h,L)=>E.applyForceDirectedLayout(n,u,y,_,N,A,h,L,d,c,l),r,a,s,o,p)}e.getMinIdealEdgeLength=t,e.apply=i})(Ye||(Ye={})),function(e){function t(i,n,r,a,s,o,p=We,d=Je,c=Ve){return ae((l,u,y,_,N,A,h)=>E.applyCommunityLayout(i,l,u,y,_,N,A,h,p,d,c),n,r,a,s,o)}e.apply=t}(Ze||(Ze={})),function(e){function t(i,n,r,a,s,o){return ae((p,d,c,l,u,y,_)=>E.applySimpleLayout(i,p,d,c,l,u,y,_),n,r,a,s,o)}e.apply=t}(Ke||(Ke={})),function(e){function t(i,n,r,a,s,o){return ae((p,d,c,l,u,y,_)=>E.applyHierarchicalLayout(i,p,d,c,l,u,y,_),n,r,a,s,o)}e.apply=t}(Xe||(Xe={})),function(e){function t(i,n,r,a,s,o){return ae((p,d,c,l,u,y,_)=>E.applyRadialTreeLayout(i,p,d,c,l,u,y,_),n,r,a,s,o)}e.apply=t}(et||(et={})),function(e){function t(i,n,r,a,s,o){return ae((p,d,c,l,u,y,_)=>E.applySmartTreeLayout(i,p,d,c,l,u,y,_),n,r,a,s,o)}e.apply=t}(tt||(tt={})),function(e){function t(i,n,r,a,s,o,p,d,c,l,u,y){const _={timeDirection:fe.right,timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:ce.startAndEnd,showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0};return ae((N,A,h,L,S,j,P)=>{if(s.length!==N)return{value:te.Error};if(o.length!==N)return{value:te.Error};if(c.length!==S)return{value:te.Error};if(l.length!==S)return{value:te.Error};const B=Float64Array.BYTES_PER_ELEMENT,w=16,$=E._malloc(w+N*B),M=E._malloc(w+N*B),q=E._malloc(w+S*B),F=E._malloc(w+S*B),G=$+w-$%w,Q=M+w-M%w,x=q+w-q%w,U=F+w-F%w;try{E.HEAPF64.subarray(G>>3,(G>>3)+N).set(s),E.HEAPF64.subarray(Q>>3,(Q>>3)+N).set(o),E.HEAPF64.subarray(x>>3,(x>>3)+S).set(c),E.HEAPF64.subarray(U>>3,(U>>3)+S).set(l);const I=An(Object.assign(_,y));return E.applyChronologicalLayout(i,N,A,h,L,G,Q,S,j,P,x,U,u,I)}finally{E._free($),E._free(M),E._free(q),E._free(F)}},n,r,a,p,d)}e.apply=t}(nt||(nt={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(it||(it={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(rt||(rt={}));pt()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"});pt()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Fn=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function On(e,t){var n,r;const i=new Map;if((n=t.dataModel)!=null&&n.relationshipTypes)for(const a of t.dataModel.relationshipTypes)a.name&&i.set(a.name,[]);for(const a of e)i.has(a.typeName)&&((r=i.get(a.typeName))==null||r.push(a.id));return i}async function di(e,t,i){const n=[],r=On(e,t),a={},s=[];for(const[c,l]of r){if(l.length<1)continue;const u=`${c}_ids`;a[u]=l,s.push(`MATCH (n)-[r:${c}]->(m) WHERE id(r) in $${u} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(s.length===0)return[];const o=s.join(" UNION "),p=new se({openCypherQuery:o,bindParameters:a}),d=(await de(t,p,i==null?void 0:i.requestOptions)).resultRowsStream.getReader();for(;;){const{done:c,value:l}=await d.read();if(c)break;for(const u of l)n.push({id:u[0],typeName:u[1]}),n.push({id:u[2],typeName:u[3]})}return n}const ui=e=>Fn.get(e)??"radial-root-centric";function xn(e){if(!e.spatialReference.isWGS84)throw new ee("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]])}let Y=class extends Et{constructor(e){var i,n,r;super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;(i=e.knowledgeGraph.dataModel.entityTypes)==null||i.forEach(a=>{var s,o;a.name&&(t.set(a.name,"entity"),this._processingCacheUpdatesLookup.set(a.name,[]),e.inclusionModeDefinition&&!((s=e.inclusionModeDefinition)!=null&&s.generateAllSublayers)||this.entityTypeNames.add(a.name),(o=a.properties)==null||o.forEach(p=>{p.geometryType&&p.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:p.name??"",geometryType:p.geometryType})}))}),(n=e.knowledgeGraph.dataModel.relationshipTypes)==null||n.forEach(a=>{var s,o;a.name&&(t.set(a.name,"relationship"),this._processingCacheUpdatesLookup.set(a.name,[]),e.inclusionModeDefinition&&!((s=e.inclusionModeDefinition)!=null&&s.generateAllSublayers)||this.relationshipTypeNames.add(a.name),(o=a.properties)==null||o.forEach(p=>{p.geometryType&&p.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:p.name??"",geometryType:p.geometryType})}))}),(r=e.inclusionModeDefinition)==null||r.namedTypeDefinitions.forEach((a,s)=>{var p,d;if(t.get(s)==="entity")this.entityTypeNames.add(s);else{if(t.get(s)!=="relationship")return It.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void((p=e.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions.delete(s));this.relationshipTypeNames.add(s)}const o=new Map;(d=a.members)==null||d.forEach(c=>{X(this.memberIdTypeLookup,c.id,()=>new Set).add(s);const l=this.getById(c.id);l&&o.set(c.id,l)}),this.sublayerCaches.set(s,o)})}addToLayer(e){e.forEach(({typeName:t,id:i})=>{if(!this.inclusionModeDefinition)throw new ee("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(t);n.members||(n.members=new Map),n.members.set(i,{id:i}),X(this.memberIdTypeLookup,i,()=>new Set).add(t)}}else{const n=new Map;n.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:n}),X(this.memberIdTypeLookup,i,()=>new Set).add(t)}})}getById(e){return Le.getInstance().readFromStoreById(e)}async getData(e,t,i){var r,a;if(t.objectType.name&&((r=this.inclusionModeDefinition)!=null&&r.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let n;if(n=e||new pe({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const s=t.parentCompositeLayer,o=this._processingCacheUpdatesLookup.get(t.objectType.name??""),p=n.outFields;p&&p.length===1&&p[0]===Z&&n.where==="1=1"||await Promise.all(o??[]);const d=this.sublayerCaches.has(t.objectType.name??"")?Array.from((a=this.sublayerCaches.get(t.objectType.name))==null?void 0:a.values()):[],c=[];return d.forEach(l=>{if(this.relationshipTypeNames.has(t.objectType.name)){l.geometry=s.relationshipLinkChartDiagramLookup.get(l.attributes[t.objectIdField]);const u=this.memberIdTypeLookup.get(l.attributes[Re]),y=this.memberIdTypeLookup.get(l.attributes[Ce]),_=this._isEndEntitySpatial(u,l,Re),N=this._isEndEntitySpatial(y,l,Ce);l.attributes[me]=Number(_&&N)}else{l.geometry=s.entityLinkChartDiagramLookup.get(l.attributes[t.objectIdField]);const u=this.geographicLookup.get(t.objectType.name);u&&l.attributes[u.name]?l.attributes[me]=1:l.attributes[me]=0}l.attributes[yt]=l.geometry,c.push(l)}),c}return this.retrieveDataFromService(n,t,i)}async getConnectedRecordIds(e,t,i){const n=[];let r="";const a=this._getNamedTypeIdMapFromNodeIds(e);if(t&&(t==null?void 0:t.length)!==0){for(const c of t)r=r+c+"|";r=r.slice(0,-1)}const s={},o=[];for(const[c,l]of a){const u=`${c}_ids`;s[u]=l,t&&(t==null?void 0:t.length)!==0?o.push(`MATCH (n:${c}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r:${r}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):o.push(`MATCH (n:${c}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!o.length)return n;const p=o.join(" UNION "),d=(await de(this.knowledgeGraph,new se({openCypherQuery:p,bindParameters:s}),{signal:i==null?void 0:i.signal})).resultRowsStream.getReader();for(;;){const{done:c,value:l}=await d.read();if(c)break;for(let u=0;u<l.length;u++){const y=l[u];n.push({id:y[0],typeName:y[1]}),n.push({id:y[2],typeName:y[3]})}}return n}async getRelationshipsBetweenNodes(e,t,i){const n=this._getNamedTypeIdMapFromNodeIds(e);if(n.size===0)return[];const r={relationshipExclusionIds:t,possibleConnectionEntityIds:e},a=[];for(const[d,c]of n.entries()){const l=`${d}_ids`;r[l]=c,a.push(`MATCH (n:${d}) WHERE id(n) IN $${l} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const s=a.join(" UNION "),o=[],p=(await de(this.knowledgeGraph,new se({openCypherQuery:s,bindParameters:r}),{signal:i==null?void 0:i.signal})).resultRowsStream.getReader();for(;;){const{done:d,value:c}=await p.read();if(d)break;for(let l=0;l<c.length;l++){const u=c[l];o.push({id:u[0],typeName:u[1]})}}return o}async getRelationshipsFromNodes(e,t,i,n){const r=this._getNamedTypeIdMapFromNodeIds(e);if(r.size===0||t.length===0)return[];const a={relationshipExclusionIds:i,possibleConnectionEntityIds:t},s=[];for(const[l,u]of r.entries()){const y=`${l}_ids`;a[y]=u,s.push(`MATCH (n:${l}) WHERE id(n) IN $${y} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const o=s.join(" UNION "),p=new Map,d=(await de(this.knowledgeGraph,new se({openCypherQuery:o,bindParameters:a}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:l,value:u}=await d.read();if(l)break;for(let y=0;y<u.length;y++){const _=u[y];let N=p.get(_[1]);N||(N=new Set,p.set(_[1],N)),N.add(_[0])}}const c=[];for(const[l,u]of p)for(const y of u)c.push({id:y,typeName:l});return c}async refreshCacheContent(e,t,i,n=!0,r){var d,c,l,u,y,_,N,A;const a=Le.getInstance(),s=[],o=new Map,p=new Map;(d=this.knowledgeGraph.dataModel.entityTypes)==null||d.forEach(h=>{h.name&&p.set(h.name,h)}),(c=this.knowledgeGraph.dataModel.relationshipTypes)==null||c.forEach(h=>{h.name&&p.set(h.name,h)}),e||this.inclusionModeDefinition?e?e.forEach(h=>{var L;if(this.memberIdTypeLookup.has(h))for(const S of this.memberIdTypeLookup.get(h))o.has(S)?(L=o.get(S))==null||L.push(h):o.set(S,[h])}):(u=(l=this.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions)==null||u.forEach((h,L)=>{h.useAllData?o.set(L,null):h.members&&h.members.forEach(S=>{var j;o.has(L)&&o.get(L)!==null?(j=o.get(L))==null||j.push(S.id):o.set(L,[S.id])})}):((y=this.knowledgeGraph.dataModel.entityTypes)==null||y.forEach(h=>{h.name&&o.set(h.name,null)}),(_=this.knowledgeGraph.dataModel.entityTypes)==null||_.forEach(h=>{h.name&&o.set(h.name,null)}));for(const[h,L]of o){const S=new Set(L),j=new Promise((P,B)=>{(async()=>{var U,I,b,D,k,R,C,O,v;const $=new Set,M=[];let q,F="",G=!1;if(t||((I=(U=p.get(h))==null?void 0:U.properties)==null||I.forEach(g=>{g.name&&$.add(g.name)})),i&&this.geographicLookup.has(h)){const g=(b=this.geographicLookup.get(h))==null?void 0:b.name;g&&$.add(g)}if(this.entityTypeNames.has(h))F=`MATCH (n:${h}) ${L?"WHERE id(n) IN $ids ":""}return ID(n)`,$.forEach(g=>{F+=`, n.${g}`,M.push(g)});else{if(!this.relationshipTypeNames.has(h))throw new ee("knowledge-graph:layer-data-manager",`The graph type of ${h} could not be determined. Was this type set in the KG data model and inclusion definition?`);G=!0,F=`MATCH ()-[n:${h}]->() ${L?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,$.forEach(g=>{F+=`, n.${g}`,M.push(g)})}q=new se(L?{openCypherQuery:F,bindParameters:{ids:L}}:{openCypherQuery:F});const Q=(await de(this.knowledgeGraph,q,{signal:r==null?void 0:r.signal})).resultRowsStream.getReader();for(;;){const{done:g,value:ne}=await Q.read();if(g)break;const V=[];for(let K=0;K<ne.length;K++){const ie=ne[K];let H=0,ge=0;const z={properties:{}};for(z.id=ie[H],H++,ge++,G&&(z.originId=ie[H],H++,ge++,z.destinationId=ie[H],H++,ge++,X(this.nodeConnectionsLookup,z.originId,()=>new Set).add(z.id),X(this.nodeConnectionsLookup,z.destinationId,()=>new Set).add(z.id),X(this.relationshipConnectionsLookup,z.id,()=>[z.originId,z.destinationId]));H<ie.length;H++)z.properties[M[H-ge]]=ie[H];S.delete(z.id),V.push(z)}const ft=a.writeToStore(V,Z,(D=this.geographicLookup.get(h))==null?void 0:D.name);this.sublayerCaches.has(h)||this.sublayerCaches.set(h,new Map),n&&!((k=this.inclusionModeDefinition)!=null&&k.namedTypeDefinitions.has(h))&&((R=this.inclusionModeDefinition)==null||R.namedTypeDefinitions.set(h,{useAllData:!1,members:new Map})),n&&!((C=this.inclusionModeDefinition)!=null&&C.namedTypeDefinitions.get(h).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(h).members=new Map);const Ee=this.sublayerCaches.get(h);ft.forEach(K=>{var ie,H;Ee==null||Ee.set(K.attributes[Z],K),n&&!((ie=this.inclusionModeDefinition)!=null&&ie.namedTypeDefinitions.get(h).members.has(K.attributes[Z]))&&((H=this.inclusionModeDefinition)==null||H.namedTypeDefinitions.get(h).members.set(K.attributes[Z],{id:K.attributes[Z]}),X(this.memberIdTypeLookup,K.attributes[Z],()=>new Set).add(h))})}const x=(O=this.inclusionModeDefinition)==null?void 0:O.namedTypeDefinitions.get(h);if(x)for(const g of S)(v=x.members)==null||v.delete(g)})().then(()=>{P(null)}).catch($=>{$.name==="AbortError"?P(null):B($)})});s.push(j),(N=this._processingCacheUpdatesLookup.get(h))==null||N.push(j)}if(await Promise.all(s),(A=r==null?void 0:r.signal)==null?void 0:A.aborted)throw _t()}removeFromLayer(e){var n,r,a;const t=new Set,i=new Set(e.map(s=>s.id));for(const s of e)t.add(s.typeName),((n=this.memberIdTypeLookup.get(s.id))==null?void 0:n.size)===1?this.memberIdTypeLookup.delete(s.id):(r=this.memberIdTypeLookup.get(s.id))==null||r.delete(s.typeName),(a=this.inclusionModeDefinition)==null||a.namedTypeDefinitions.forEach((o,p)=>{var d;p===s.typeName&&((d=o.members)!=null&&d.has(s.id))&&o.members.delete(s.id)});t.forEach(s=>{var o;(o=this.sublayerCaches.get(s))==null||o.forEach((p,d)=>{var c;i.has(d)&&((c=this.sublayerCaches.get(s))==null||c.delete(d))})})}async retrieveDataFromService(e,t,i){var _,N,A,h,L,S,j,P,B,w,$,M,q,F,G,Q,x,U;const n=Le.getInstance(),r=new Set,a=[];let s,o="",p=[];const d=t.graphType==="relationship",c=(A=(N=(_=this.inclusionModeDefinition)==null?void 0:_.namedTypeDefinitions)==null?void 0:N.get(t.objectType.name))==null?void 0:A.useAllData,l=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let u=!c&&l?Array.from(l).sort():null;if((S=(L=(h=this.inclusionModeDefinition)==null?void 0:h.namedTypeDefinitions)==null?void 0:L.get(t.objectType.name))!=null&&S.useAllData)(B=(P=(j=this.inclusionModeDefinition)==null?void 0:j.namedTypeDefinitions)==null?void 0:P.get(t.objectType.name))!=null&&B.useAllData&&e.objectIds!=null&&(u=e.objectIds);else if(e.objectIds!=null&&u&&u.length>0){const I=e.objectIds;e.objectIds=u.filter(b=>I.includes(b))}else if(e.objectIds!=null)u=e.objectIds;else{if((w=this.inclusionModeDefinition)!=null&&w.namedTypeDefinitions.has(t.objectType.name)&&(!(($=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))!=null&&$.members)||((q=(M=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))==null?void 0:M.members)==null?void 0:q.size)<1))return e.objectIds=[],[];e.objectIds=u}if(e.outFields!=null){const I=e.outFields;I.includes("*")?t.fields.forEach(b=>{r.add(b.name)}):I.forEach(b=>{b!==Z&&b!==t.geometryFieldName&&r.add(b)})}if(e.geometry!=null){const I=e.geometry;let b;const D=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,k=D==null?void 0:D.spatialReference,R=(F=D==null?void 0:D.serviceCapabilities)==null?void 0:F.geometryCapabilities;let C=R==null?void 0:R.geometryMaxBoundingRectangleSizeX,O=R==null?void 0:R.geometryMaxBoundingRectangleSizeY;if(I.type==="point"){let v=I;(G=v.spatialReference)!=null&&G.isWGS84||(await ve(v.spatialReference,re),v=be(v,re)),b=new we({spatialReference:re,xmin:v.x-1e-4,ymin:v.y-1e-4,xmax:v.x+1e-4,ymax:v.y+1e-4})}else(Q=I==null?void 0:I.extent)!=null&&Q.spatialReference&&!((x=I.spatialReference)!=null&&x.isWGS84)?(await ve(I.extent.spatialReference,re),b=be(I.extent,re)):b=I.extent;if(C&&O&&k){if(k.wkid!==4326){const v=new we({spatialReference:k,xmax:C,ymax:O}),g=be(v,re);C=g.xmax,O=g.ymax}if(b.xmax-b.xmin>C)throw new ee("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${C}° latitude, limit exceeded`);if(b.ymax-b.ymin>O)throw new ee("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${O}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const v=await xe(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(g=>{v.fieldNames.includes(g.name)&&r.add(g.name)})}o=d?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(v=>{o+=`, n.${v}`,a.push(v)}),s=new se({openCypherQuery:o,bindParameters:{param_filter_geom:new dt({rings:xn(b)})}})}else{let I="";if(e.where!=null&&e.where!=="1=1"){const k=await xe(e.where,t.fieldsIndex);t.fields.forEach(g=>{k.fieldNames.includes(g.name)&&r.add(g.name)});const R=new Set(["column-reference","string","number","binary-expression"]),C=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let O=!1;const v=g=>{if(g.type==="column-reference")return`n.${g.column}`;if(g.type==="string")return`'${g.value}'`;if(g.type==="number")return`${g.value}`;if(g.type==="binary-expression"&&R.has(g.left.type)&&R.has(g.right.type)&&C.has(g.operator))return`${v(g.left)} ${g.operator} ${v(g.right)}`;if(g.type==="binary-expression"&&g.operator==="LIKE"){let ne="";if(g.left.type==="function"&&g.left.args.value[0].type==="column-reference")ne+=`lower(n.${g.left.args.value[0].column})`;else{if(g.left.type!=="column-reference")return O=!0,"";ne+=`lower(n.${g.left.column})`}if(ne+=" CONTAINS (",g.right.type!=="string")return O=!0,"";{let V=g.right.value;V.charAt(0)==="%"&&(V=V.slice(1)),V.charAt(V.length-1)==="%"&&(V=V.slice(0,-1)),ne+=`'${V.toLowerCase()}')`}return ne}return O=!0,""};I=v(k.parseTree),O&&(I="")}let b="";b=d?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let D=!1;u&&(D=!0,b+=" WHERE ID(n) IN $ids"),I&&(b+=D?" AND":" WHERE",b+=` ${I}`),b+=" return ID(n)",d&&(b+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(k=>{b+=`, n.${k}`,a.push(k)}),s=new se(u?{openCypherQuery:b,bindParameters:{ids:u}}:{openCypherQuery:b})}const y=(await de(t.parentCompositeLayer.dataManager.knowledgeGraph,s,i)).resultRowsStream.getReader();for(;;){const{done:I,value:b}=await y.read();if(I)break;const D=[];for(let k=0;k<b.length;k++){const R=b[k];let C=0,O=0;const v={properties:{}};for(v.id=R[C],C++,O++,d&&(v.originId=R[C],C++,O++,v.destinationId=R[C],C++,O++);C<R.length;C++)v.properties[a[C-O]]=R[C];D.push(v)}p=p.concat(n.writeToStore(D,Z,(U=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))==null?void 0:U.name))}return p}_isEndEntitySpatial(e,t,i){var n;for(const r of e??[])if(this.entityTypeNames.has(r)){const a=this.geographicLookup.get(r),s=a&&((n=this.sublayerCaches.get(r))==null?void 0:n.get(t.attributes[i]));if(a&&(s!=null&&s.attributes[a.name]))return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const t=new Map;return e.forEach(i=>{var n;if(this.memberIdTypeLookup.has(i))for(const r of this.memberIdTypeLookup.get(i)){if(!this.entityTypeNames.has(r))return;t.has(r)?(n=t.get(r))==null||n.push(i):t.set(r,[i])}}),t}};m([f()],Y.prototype,"knowledgeGraph",void 0),m([f()],Y.prototype,"inclusionModeDefinition",void 0),m([f()],Y.prototype,"entityTypeNames",void 0),m([f()],Y.prototype,"relationshipTypeNames",void 0),m([f()],Y.prototype,"geographicLookup",void 0),m([f()],Y.prototype,"sublayerCaches",void 0),m([f()],Y.prototype,"nodeConnectionsLookup",void 0),m([f()],Y.prototype,"relationshipConnectionsLookup",void 0),m([f()],Y.prototype,"memberIdTypeLookup",void 0),Y=m([ke("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],Y);const at=Nt(),jn=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return m([f(at.fields)],t.prototype,"fields",void 0),m([f(at.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=m([ke("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t};function J(e){if(!e.json)return e;e.json.write=st(e.json.write);const t=e.json.origins;if(!t)return e;let i;for(i in t){const n=t[i];n&&(n.write=st(n.write))}return e}function st(e){return typeof e=="object"&&e?(e.enabled!==!1&&(e.overridePolicy=qn(e)),e):e===!0?he():e}function qn(e){const{target:t,writer:i,overridePolicy:n,...r}=e;return function(a,s){const o=ht.call(this,a,s);return o.enabled?{...r,...o}:o}}function he(){return{overridePolicy:ht}}function ht(e,t){const i=!!this.geometryType;let n={enabled:i};return i&&(n={...n,...mt.call(this,e,t)}),n}function mt(e,t){return{ignoreOrigin:this.originIdOf(t)>an.DEFAULTS}}let T=class extends jn(Lt($t(vt(Mt(St(Dt(Rt(Ct(sn))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=cn(!1,!1),this.charts=null,this.definitionExpression=null,this.displayField="",this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.labelingInfo=null,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=Z,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new kt(t.port1,{channel:t,client:{queryFeatures:(i,n={})=>{const r=pe.fromJSON(i);return this.queryFeaturesJSON(r,n)}}}),[t.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){var t,i;const e=[];return(i=(t=this.objectType)==null?void 0:t.properties)==null||i.forEach(n=>{const r=n.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":n.fieldType;e.push(Te.fromJSON({name:n.name,type:r,alias:n.alias,defaultValue:n.defaultValue,editable:n.editable,nullable:n.nullable}))}),e.push(Te.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),Te.fromJSON({name:Ue,type:"esriFieldTypeInteger",alias:Ue,editable:!1}),Te.fromJSON({name:me,type:"esriFieldTypeInteger",alias:me,editable:!1})),e}get geometryType(){var i,n,r;if(((i=this.parentCompositeLayer)==null?void 0:i.type)==="link-chart")return this.graphType==="relationship"?"polyline":"point";const e=(r=this.parentCompositeLayer)==null?void 0:r.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name),t=e==null?void 0:e.geometryType;return t&&t!=="esriGeometryNull"?le.fromJSON(t):null}get geometryFieldName(){var t,i,n;if(((t=this.parentCompositeLayer)==null?void 0:t.type)==="link-chart")return yt;const e=(n=this.parentCompositeLayer)==null?void 0:n.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name);return(e==null?void 0:e.name)??null}get graphTypeName(){var e;return(e=this.objectType)==null?void 0:e.name}get hasM(){var n,r,a,s;const e=(r=this.parentCompositeLayer)==null?void 0:r.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name),t=e==null?void 0:e.name,i=t?(s=(a=this.objectType)==null?void 0:a.properties)==null?void 0:s[t]:null;return(i==null?void 0:i.hasM)??!1}get hasZ(){var n,r,a,s;const e=(r=this.parentCompositeLayer)==null?void 0:r.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name),t=e==null?void 0:e.name,i=t?(s=(a=this.objectType)==null?void 0:a.properties)==null?void 0:s[t]:null;return(i==null?void 0:i.hasZ)??!1}set renderer(e){At(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){var e;return this._isOverridden("renderer")?this._get("renderer"):((e=this.parentCompositeLayer)==null?void 0:e.type)==="link-chart"?this.graphType==="relationship"?Ie(_e(le.toJSON("polyline")).renderer):Ie(_e(le.toJSON("point")).renderer):Ie(_e(le.toJSON(this.geometryType)).renderer)}get spatialReference(){var e,t,i,n;return((n=(i=(t=(e=this.parentCompositeLayer)==null?void 0:e.dataManager)==null?void 0:t.knowledgeGraph)==null?void 0:i.dataModel)==null?void 0:n.spatialReference)??ot.WGS84}set timeInfo(e){this._set("timeInfo",e)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(e){this._set("title",e)}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return Ft(this,e)}createQuery(){return new pe({where:"1=1",outFields:["*"]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e),r=Ot.fromJSON(await n.executeQuery(i.toJSON(),t==null?void 0:t.signal));return r.features.forEach(a=>{a.sourceLayer=this}),r}async queryFeaturesJSON(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return await n.executeQuery(i.toJSON(),t==null?void 0:t.signal)}async queryFeatureCount(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return n.executeQueryForCount(i.toJSON(),t==null?void 0:t.signal)}async queryExtent(e={},t){var o,p,d,c;const i={...e,returnGeometry:!0},{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(i),a=await r.executeQueryForExtent(n.toJSON(),t==null?void 0:t.signal);let s;return s=((o=a.extent)==null?void 0:o.xmin)!=null&&((p=a.extent)==null?void 0:p.xmax)!=null&&((d=a.extent)==null?void 0:d.ymin)!=null&&((c=a.extent)==null?void 0:c.ymax)!=null?new we(a.extent):new we,{count:a.count,extent:s}}async queryObjectIds(e,t){const i=pe.from(e);let n;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const r=await this.parentCompositeLayer.dataManager.getData(i,this,t);n=this.loadQueryEngine(r)}return n.executeQueryForIds(i.toJSON(),t==null?void 0:t.signal)}loadQueryEngine(e){var n;const t=new dn({geometryType:le.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),i=new un({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:le.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:(n=this.timeInfo)==null?void 0:n.toJSON(),featureStore:t});return i.featureStore.addMany(e),i}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new pe({where:"1=1",outFields:[Z]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>xt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){var a;const i=pe.from(e),n=i.geometry;if(n&&!((a=n.spatialReference)!=null&&a.isWGS84)&&(await ve(n.spatialReference,re),i.geometry=be(n instanceof dt||n instanceof jt||n instanceof qt?n:n.extent,re)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:i,queryEngine:this._cachedQueryEngine};const r=await this.parentCompositeLayer.dataManager.getData(i,this,t);return{resolvedQuery:i,queryEngine:this.loadQueryEngine(r)}}};m([f(J(W(Gt)))],T.prototype,"blendMode",void 0),m([f()],T.prototype,"capabilities",void 0),m([f({json:{origins:{"web-scene":{write:!1}},write:he()}})],T.prototype,"charts",void 0),m([f({readOnly:!0})],T.prototype,"defaultPopupTemplate",null),m([f({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],T.prototype,"definitionExpression",void 0),m([f()],T.prototype,"displayField",void 0),m([f(J(W(Pt)))],T.prototype,"effect",void 0),m([f()],T.prototype,"elevationInfo",void 0),m([f(J(W(Bt)))],T.prototype,"featureEffect",void 0),m([f(J(W(Ut)))],T.prototype,"featureReduction",null),m([f()],T.prototype,"fields",null),m([f()],T.prototype,"geometryType",null),m([f()],T.prototype,"geometryFieldName",null),m([f({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],T.prototype,"graphType",void 0),m([f({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],T.prototype,"graphTypeName",null),m([f()],T.prototype,"hasM",null),m([f()],T.prototype,"hasZ",null),m([f({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],T.prototype,"id",void 0),m([f(J(W(Ht)))],T.prototype,"labelsVisible",void 0),m([f({type:[zt],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:Qt,write:he()}})],T.prototype,"labelingInfo",void 0),m([f({readOnly:!0,json:{read:!1,write:{writer(e,t){switch(this.parentCompositeLayer.type){case"link-chart":t.layerType="LinkChartSubLayer";break;case"knowledge-graph":t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],T.prototype,"layerType",void 0),m([f(J(W(Wt)))],T.prototype,"legendEnabled",void 0),m([f(J(W(Jt)))],T.prototype,"maxScale",void 0),m([f(J(W(Vt)))],T.prototype,"minScale",void 0),m([f()],T.prototype,"objectIdField",void 0),m([f()],T.prototype,"objectType",void 0),m([f(J(W(Yt)))],T.prototype,"opacity",void 0),m([f(J(W(Zt)))],T.prototype,"orderBy",void 0),m([f({clonable:!1})],T.prototype,"parent",void 0),m([f()],T.prototype,"parentCompositeLayer",void 0),m([f(J(W(Kt)))],T.prototype,"popupEnabled",void 0),m([f({type:Xt,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],T.prototype,"popupTemplate",void 0),m([f({type:Number,json:{write:{overridePolicy:mt}}})],T.prototype,"refreshInterval",void 0),m([f({types:en,json:{name:"layerDefinition.drawingInfo.renderer",write:he()}})],T.prototype,"renderer",null),m([f()],T.prototype,"source",void 0),m([f()],T.prototype,"spatialReference",null),m([f({type:tn,json:{name:"layerDefinition.timeInfo",write:!0,origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:!0},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:!0}}}})],T.prototype,"timeInfo",null),m([f({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],T.prototype,"title",null),m([nn("title")],T.prototype,"writeTitle",null),m([f({json:{read:!1}})],T.prototype,"type",void 0),m([f(J(W(rn)))],T.prototype,"useViewTime",void 0),m([f({type:Boolean,json:{name:"visibility",write:he()}})],T.prototype,"visible",void 0),T=m([ke("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],T);const ci=T;export{Ze as A,ui as C,oi as D,Y as E,et as L,nt as P,Ke as a,tt as b,Xe as c,Z as d,pi as e,Qe as f,di as g,si as h,Ue as i,Le as j,ai as m,Ce as n,te as o,li as p,yt as r,ze as s,Re as t,ci as u,Ye as v};
